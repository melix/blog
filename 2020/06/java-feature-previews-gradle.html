<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog: Using Java feature previews with Gradle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    </head>
  <body>
    <div id="wrap">
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/groovy.html">Gradle</a></li>
				<li><a href="/blog/2013/07/30/deck2pdf_exporting_html5_slide_decks.html">deck2pdf</a></li>
				<li><a href="/blog/tags/jlangdetect.html">JLangDetect</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">
	
	<div class="page-header">
		<h1>Using Java feature previews with Gradle</h1>
	</div>

	<p><em>11 juin 2020</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	</em>
		<a href="/blog/tags/java.html"> java</a> 
	</em>
		<a href="/blog/tags/preview.html"> preview</a> 
	</p>
	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>You&#8217;ve probably heard about Java providing features like <a href="https://blogs.oracle.com/javamagazine/records-come-to-java">records</a>, <a href="https://docs.oracle.com/en/java/javase/13/text_blocks/index.html">multi-line text blocks</a> or <a href="https://blogs.oracle.com/javamagazine/inside-the-language-sealed-types">sealed types</a> and you&#8217;d like to try them.</p>
</div>
<div class="paragraph">
<p>Those features are called <em>feature previews</em> and it means a couple of things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the Java team wants you to test them and give feedback. They want honest feedback about how it <em>feels</em> to use them, whether you like them or not. Both ways, feedback is important.</p>
</li>
<li>
<p>because they are feature previews, you <em>shouldn&#8217;t</em> them use in production, but you can play with them for toy projects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There&#8217;s actually an important thing about point 2 if you are a <em>library author</em>: <strong>never, ever publish a library which uses feature previews on Maven Central</strong>. The reason is that the feature previews <em>leak to consumers</em>: as soon as <em>you</em> start using them, any project depending on your code will also have to enable them. This is not a problem for toy projects, it&#8217;s clearly a problem for published libraries. In particular, there are no guarantees that the generated bytecode will be compatible with future Java releases, and there are no guarantees that the feature preview will make it to Java eventually.</p>
</div>
<div class="paragraph">
<p>The goal of this blog post is not to explain what records or sealed classes are, there&#8217;s already a lot of litterature about it.
Instead, we&#8217;re going to explain how to configure your Gradle build to use feature previews and therefore report issues/bugs to the JDK team.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_your_gradle_build">Configuring your Gradle build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code in this blog post is available on a <a href="https://github.com/melix/gradle-java-feature-previews">GitHub repository</a>.</p>
</div>
<div class="paragraph">
<p>First, make sure you are using latest Gradle versions.
If you use the repository above, the Gradle wrapper will make sure that you do.
Gradle 6.5, for example, works perfectly fine with Java 14 and even Java 15.</p>
</div>
<div class="paragraph">
<p>Imagine that you want to compile the following record:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>public record Person(
        String firstName,
        String lastName,
        boolean likeJavaRecords) {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And execute this test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>class PersonTest {
    @Test void testRecord() {
        Person cedric = new Person("Cédric", "Champeau", true);
        Person otherCedric = new Person("Cédric", "Champeau", true);
        assertEquals(cedric, otherCedric);
        assertTrue(cedric.likeJavaRecords());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to configure the build to do a couple of things:</p>
</div>
<div class="paragraph">
<p>First, we need to tell the Java compiler to use feature previews:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint kotlin language-kotlin"><code>tasks.withType&lt;JavaCompile&gt;().configureEach {
    options.compilerArgs.add("--enable-preview")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to tell the test runtime to use feature previews:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint kotlin language-kotlin"><code>tasks.withType&lt;Test&gt;().configureEach {
    useJUnitPlatform()
    jvmArgs("--enable-preview")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it, you can run the build with <code>./gradlew test</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_gradle_to_use_a_different_jdk_from_its_own_runtime">Configuring Gradle to use a different JDK from its own runtime</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Usually, people use the same JDK version for running Gradle, than they use to compile and execute tests.
It doesn&#8217;t have to be that way, and actually the Gradle team is working on adding support for toolchains to simplify the configuration of builds in this case.
In the mean time, if for some reason your Gradle build doesn&#8217;t want to start on JDK 15, but it works on 14, then you can easily configure Gradle to fork compilation and execution.</p>
</div>
<div class="paragraph">
<p>You can for example configure the build to use a JDK found externally by specifying an environment variable like in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint kotlin language-kotlin"><code>providers.environmentVariable("JDK15")
        .forUseAtConfigurationTime()
        .map(::File)
        .orNull?.let { javaHome -&gt;
            println("Configuring your build to use JDK 15 from $javaHome")
            tasks.withType&lt;Test&gt;().configureEach {
                executable = "${javaHome}/bin/java"
            }

            tasks.withType&lt;JavaCompile&gt;().configureEach {
                options.isFork = true
                options.forkOptions.javaHome = javaHome
                options.compilerArgs.addAll(listOf("--release", "15"))
            }
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you don&#8217;t have any excuse not to try feature previews!</p>
</div>
</div>
</div></p>
   


<div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'melixblog';
	var disqus_identifier = 'gradle-java-feature-previews';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.9.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script src="/blog/js/run_prettify.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
<script src="http://cdn.lanyrd.net/badges/person-v1.min.js"></script>
  </body>
</html>
