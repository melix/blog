<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog: Upcoming Groovy goodness : automatic thread interruption</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    </head>
  <body>
    <div id="wrap">
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/groovy.html">Gradle</a></li>
				<li><a href="/blog/2013/07/30/deck2pdf_exporting_html5_slide_decks.html">deck2pdf</a></li>
				<li><a href="/blog/tags/jlangdetect.html">JLangDetect</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">
	
	<div class="page-header">
		<h1>Upcoming Groovy goodness : automatic thread interruption</h1>
	</div>

	<p><em>30 November 2010</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/ast.html">ast</a> 
	</em>
		<a href="/blog/tags/groovy.html"> groovy</a> 
	</em>
		<a href="/blog/tags/programming.html"> programming</a> 
	</p>
	<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using Groovy can really be addictive. It deals with so many different problems that you’ll eventually end up using it everywhere in your application. One of the situations that I think is widely used is embedding Groovy for your business logic. For example, embedding a Groovy DSL which allows users to customize their application or even run scripts on your platform. However, when doing this, you expose your infrastructure dangerously : what if a user accidently creates an infinite loop ? What if another creates a memory leak ? Would it be reasonable if your whole application goes down because a customer just ran <em>one poor script</em> ?</p>
</div>
<div class="paragraph">
<p>There are common solutions for that, but most are not suitable. The real solution would be to isolate the script from the rest of the application by spawning it in its own process. However, this may be complicated to do if you need to share objects from the original VM.</p>
</div>
<div class="paragraph">
<p>As I had this problem multiple times in the past, I proposed a patch to Groovy 1.8 introducing a new AST Transformation which was just, at the beginning, an elegant solution for interrupting loops and closures when the running thread has been interrupted. Eventually, thanks to the Groovy folks (and a special mention to Hamlet D’Arcy), we ended up with three separate annotations that I’ll describe here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_basic_example">A basic example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here’s the most basic example : how would you manage this ?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>while (true) {
 // eat cpu
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can test it in the Groovy console (<em>groovyConsole</em> command), and try to click on the script interruption button. Most likely you won’t be able to click on the script interruption button because the script doesn’t even make a call to <em>Thread.yield()</em> which does not let a chance to the UI thread to catch up. If you could, Groovy would have sent an interruption request to the script thread. However, even in that case, the script thread would never stop because no one ever checks for interruption. Here’s where the first annotation comes up.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_ast_transformations">New AST Transformations</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Note that the following is based on an early implementation and subject to changes. Those annotations are available since the Groovy 1.8.0-beta-3 release.</strong></p>
</div>
<div class="sect2">
<h3 id="__threadinterrupt">@ThreadInterrupt</h3>
<div class="paragraph">
<p>This is the most basic transformation we can apply. The script above becomes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>@ThreadInterrupt
import groovy.transform.ThreadInterrupt

while (true) {
// eat cpu
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run it in the Groovy 1.8.0-beta3 console, you will not notice any change, apart from the fact that you can click on the interrupt button now. If you do so, you’ll see an exception thrown :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>java.lang.InterruptedException: Execution Interrupted
 at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
 at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:39)
 at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The magic here is that our transformation automatically added a thread interruption check in the loop block. Thus, the annotated code is equivalent to the following :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>while (true) {
  if (Thread.currentThread().isInterrupted()) throw new InterruptedException("Execution Interrupted");
// eat cpu
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s all ! Adding this annotation ensures that <em>for</em>, <em>while</em>,<em>do</em> loops and closures will have an interruption check added. It will also add a check on method start. This annotation also applies on classes. The behaviour of the transformation can also be tuned for your needs :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>checkOnMethodStart</em> annotation parameter (defaults to true) adds an interrupt check as the first statement of a method body</p>
</li>
<li>
<p><em>applyToAllClasses</em> annotation parameter (default to true) will apply the transformation to every class in your script (or compilation unit if not in a script), therefore allowing to interrupt more complex method call pathes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You may wonder what use is this transform if the user has to explicitely add it to scripts (s)he writes. However, the good thing is that you can do it automatically, because Groovy scripts accept import statements anywhere. So basically, you could take the user code, append the annotated import, and you’d see the expected behaviour.</p>
</div>
</div>
<div class="sect2">
<h3 id="__timedinterrupt">@TimedInterrupt</h3>
<div class="paragraph">
<p>The second AST Transformation to be added allows interrupting a script after a maximum execution time. It is interesting when you want to automatically timeout scripts. For example :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>@TimedInterrupt(10)
import groovy.transform.TimedInterrupt

while (true) {
// eat cpu
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the script will automatically timeout after 10 seconds, throwning a <em>TimeoutException</em>. Apart from the two previously described annotation parameters, this annotation accepts two additional ones :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>value</em> (mandatory, defaults to 1) : the amount of time unit the script is allowed to consume</p>
</li>
<li>
<p><em>unit</em> (defaults to TimeUnit.SECONDS) : the unit used to describe the timeout</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="__conditionalinterrupt">@ConditionalInterrupt</h3>
<div class="paragraph">
<p>This one is another powerful variant of automatic thread interruption annotation. It allows the user to provide a custom condition for interruption. For example, one would like to check that user credentials are valid, while other would like to ensure that there are enough file descriptors left to allow script execution. There’s a wide variety of problems that can be solved thanks to this one. In my examples, I’ll focus on simple test cases to show off the advantages of this annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>@ConditionalInterrupt({counter++&gt;1})
import groovy.transform.ConditionalInterrupt

counter=0
def scriptMethod() {
     4.times {
         println 'executing script method...'
     }
}

scriptMethod()
</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the @ConditionalInterrupt annotation accepts a <em>closure as annotation value</em>. This amazing features which is already used by <a href="https://github.com/andresteingress/gcontracts">GContracts</a> allows us to annotate a class (or import statement) with a custom condition. Here, we implement a custom interruption policy which decides that an <em>InterruptedException</em> should be thrown whenever <em>counter1</em>. The <em>counter</em> variable references the one defined in the script. This is the main difficulty you’ll have to face with this annotation : variable scoping. The semantics is not different from the one in regular Groovy scripts, but may be hard to understand. Indeed, replacing the line :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>counter=0
</code></pre>
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>def counter=0
</code></pre>
</div>
</div>
<div class="paragraph">
<p>would cause the compilation to fail because the counter variable would not be in the scope. Now the hard question is given the annotated script upper, how many times would you expect the &#8216;executing script method…&#8217; message to be displayed ? If your answer is 2, not bad, but you missed one point. If your answer is 1, either you are lucky, or you are brilliant. If your answer is anything else, you’ll be interested in the explanation.</p>
</div>
<div class="paragraph">
<p>How is this script updated ? To check it out, you can use the AST Browser found in the Groovy console. It will show you how your script gets transformed, and help you tune your custom conditions. Here, the generated script looks like this (stripped for clarity) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>public class script1291150384631 extends groovy.lang.Script {

    public java.lang.Object run() {
        counter = 0
        this.scriptMethod()
    }

    public java.lang.Object scriptMethod() {
        if (this.conditionalTransform$condition()) {
            throw new java.lang.InterruptedException('Execution Interrupted')
        }
        4.times({
            if (this.conditionalTransform$condition()) {
                throw new java.lang.InterruptedException('Execution Interrupted')
            }
            this.println('executing script method...')
        })
    }

    protected java.lang.Boolean conditionalTransform$condition() {
        ( counter )++ &gt; 1
    }

}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Got it ? If your answer was two, you probably missed the fact that <em>scriptMethod</em> first statement will be, by default (understand unless you set the <em>checkOnMethodStart</em> flag to false), an interruption check…</p>
</div>
<div class="paragraph">
<p>Can we do anything more complex with it ? Indeed, you can. For example, I can imagine, in a web application, a custom condition that would use a helper class which looks up a thread local to extract the current request context and check user credentials. Here’s another example which demonstrates a very simple case where the condition is shared by multiple classes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>import groovy.transform.ConditionalInterrupt

class Helper {
  static int i=0
  static def shouldInterrupt() { i++&gt;0 }
}

@ConditionalInterrupt({ Helper.shouldInterrupt() })
class MyClass {
   def myMethod() { }
}

class MyOtherClass {
   def myOtherMethod() { new MyClass().myMethod() }
}

new MyOtherClass().myOtherMethod()
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, a Helper class stores a static counter. Every method call will increase the counter, independently of the class from which a method is called. A few tricks to understand though :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>we are using static members for the helper class (both counter and method) because this annotation <strong>does not</strong> add interrupt checks on static members. If it had, then the Helper class itself would have been modified, and you would have ended with a stack overflow error.</p>
</li>
<li>
<p>it is not necessary to add the annotation to the second class as by default, the <em>applyToAllClasses</em> flag is on</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_few_gotchas">A few gotchas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is something more you need to be aware when using this annotation : first, it’s obvious (yet we talk about it) that this won’t deal with pure Java classes that the script may use. If an infinite loop occurs in a Java library used by the script, it won’t get interrupted. Second, you must take care of open resources, especially files, sockets, result sets, … that would not be closed if the script didn’t check for exceptions. Those magic annotations won’t do it for you.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I really hope you’ll enjoy those new features, as I think those are quite mandatory in production environments where Groovy scripts are not totally under control (this is not limited to user errors, but resources exhausted is a common case too).</p>
</div>
</div>
</div></p>
   


<div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'melixblog';
	var disqus_identifier = 'upcoming_groovy_goodness_automatic_thread';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.9.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script src="/blog/js/run_prettify.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
  </body>
</html>
