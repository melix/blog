<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog: Simplified version management with Gradle 7</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
   <script src="https://kit.fontawesome.com/fefa3ec5bf.js" crossorigin="anonymous"></script>
      
    <script src="/blog/js/highlight.min.js"></script>
    <link href="/blog/css/equilibrium-gray-light.min.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
  </head>
  <body>
    <div id="wrap">
   
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/gradle.html">Gradle</a></li>
                <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/micronaut.html">Micronaut</a></li>
                <li><a href="/blog/tags/index.html">See all tags</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a></li>
	        <li><a rel="me" href="https://mastodon.xyz/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	        <li><a rel="me" href="https://astrodon.social/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">
	
	<div class="page-header">
		<h1>Simplified version management with Gradle 7</h1>
	</div>

	<p><em>24 March 2021</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	</em>
		<a href="/blog/tags/catalog.html">catalog</a> 
	</em>
		<a href="/blog/tags/convenience.html">convenience</a> 
	</p>
	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Gradle 7 introduces the concept of <a href="https://docs.gradle.org/7.0-rc-1/userguide/platforms.html">version catalogs</a>, which I&#8217;ve been working on for several months already. Long story short, I&#8217;m extremely excited by this new feature which should make dependency management easier with Gradle. Let&#8217;s get started!</p>
</div>
<div class="paragraph">
<p><em>Please also read my <a href="/blog/2021/03/version-catalogs-faq.html">Version catalogs FAQ</a> follow up post if you have more questions!</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sharing_dependencies_between_projects">Sharing dependencies between projects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the most frequent questions raised by Gradle users is how to properly share dependency versions between projects.
For example, let&#8217;s imagine that you have a multi-project build with this layout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>root
 |---- client
 |---- server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because they live in the same "multi-project", it is expected that both <code>client</code> and <code>server</code> would require the same dependencies.
For example, both of them would need Guava as an implementation detail and JUnit 5 for testing:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">dependencies {
    implementation("com.google.guava:guava:30.0-jre")
    testImplementation("org.junit.jupiter:junit-jupiter-api:5.7.1")
    testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without any sharing mechanism, both projects would replicate the dependency declarations, which is subject to a number of drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>upgrading a library requires updating all build files which use it</p>
</li>
<li>
<p>you have to remember about the dependency coordinates (group, artifact, version) of all dependencies</p>
</li>
<li>
<p>you might accidentally use different versions in different projects</p>
</li>
<li>
<p>some dependencies are always used together but you have to duplicate entries in build files</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_existing_patterns">Existing patterns</h3>
<div class="paragraph">
<p>For these reasons, users have invented over the years different patterns for dealing with dependency versions over time.
For example:</p>
</div>
<div class="paragraph">
<p>Versions in properties files:</p>
</div>
<div class="listingblock">
<div class="title">gradle.properties</div>
<div class="content">
<pre class="pygments highlight"><code>guavaVersion=30.0-jre</code></pre>
</div>
</div>
<div class="paragraph">
<p>then in a build file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>dependencies {
    implementation("com.google.guava:guava:${guavaVersion}")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or versions in "extra properties" in the root project:</p>
</div>
<div class="listingblock">
<div class="title">extra properties</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">ext {
   guavaVersion = '30.0-jre'
}

// ...

dependencies {
    implementation("com.google.guava:guava:${guavaVersion}")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you even find full coordinates in <code>dependencies.gradle</code> files.</p>
</div>
<div class="paragraph">
<p>And since the rise of the Kotlin DSL, another pattern became extremely popular in the Android world: declaring libraries in <code>buildSrc</code> then using type-safe accessors to declare dependencies in build scripts:</p>
</div>
<div class="listingblock">
<div class="title">buildSrc/src/main/kotlin/Libs.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin">object Libs {
   val guava = "com.google.guava:guava:30.0-jre"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and in a build script:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="pygments highlight"><code>dependencies {
    implementation(Libs.guava)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This last example is interesting because it goes into the direction of having more type-safety, more compile-time errors (as opposed to runtime errors).
But it has a major drawback: any change to any dependency will trigger recompilation of build scripts and invalidate the build script classpath, causing up-to-date checkness to fail and in the end, rebuilding a lot more than what you should do for a single version change.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introducing_version_catalogs">Introducing version catalogs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A version catalog is basically a replacement for all the previous patterns, supported by Gradle, without the drawbacks of the previous approaches.
To add support for version catalogs, you need to enable the experimental feature in your settings file:</p>
</div>
<div class="listingblock">
<div class="title">settings.gradle</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">enableFeaturePreview("VERSION_CATALOGS")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In its simplest form, a catalog is a file found in a conventional location and uses the <a href="https://toml.io/en/">TOML</a> configuration format:</p>
</div>
<div class="listingblock">
<div class="title">gradle/libs.versions.toml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="toml">[libraries]
guava = "com.google.guava:guava:30.0-jre"
junit-jupiter = "org.junit.jupiter:junit-jupiter-api:5.7.1"
junit-engine = { module="org.junit.jupiter:junit-jupiter-engine" }

[bundles]
testDependencies = ["junit-jupiter", "junit-engine"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This declares the <em>dependency coordinates</em> which will be used in build scripts.
You still have to declare your dependencies, but this now can be done using a <em>typesafe</em> API:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">dependencies {
    implementation(libs.guava)
    testImplementation(libs.testDependencies)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The benefit of type-safe APIs is immediately visible in the IDE:</p>
</div>
<video controls autoplay height="450">
    <source src="/blog/video/ide-completion.webm"
            type="video/webm">
</video>
<div class="paragraph">
<p>In the catalog file above, we inlined dependency versions directly in the coordinates.
However, it&#8217;s possible to externalize them so that you can share a dependency version between dependencies.
For example:</p>
</div>
<div class="listingblock">
<div class="title">gradle/libs.versions.toml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="toml">[versions]
groovy = "2.5.14"
guava = "30.0-jre"
jupiter = "5.7.1"

[libraries]
guava = { module="com.google.guava:guava", version.ref="guava" }
junit-jupiter = { module="org.junit.jupiter:junit-jupiter-api", version.ref="jupiter" }
junit-engine = { module="org.junit.jupiter:junit-jupiter-engine" }

groovy-core = { module="org.codehaus.groovy:groovy", version.ref="groovy" }
groovy-json = { module="org.codehaus.groovy:groovy-json", version.ref="groovy" }

[bundles]
testDependencies = ["junit-jupiter", "junit-engine"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This new feature makes it trivial to update a dependency version: you have a single place where to look at.</p>
</div>
<div class="paragraph">
<p>This comes with other benenefits like the fact that updating the GAV coordinates (group, artifact or version) of a dependency doesn&#8217;t trigger recompilation of build scripts.
The TOML format also provides us with the ability to declare <a href="https://docs.gradle.org/7.0-rc-1/userguide/rich_versions.html">rich versions</a>.</p>
</div>
<div class="sect2">
<h3 id="_under_the_hood">Under the hood</h3>
<div class="paragraph">
<p>Under the hood, Gradle provides an API to declare catalogs. This API is found on the <code>Settings</code>, which means that plugin authors can contribute catalogs, for example via convention plugins applied to the <code>settings.gradle(.kts)</code> file.</p>
</div>
<div class="paragraph">
<p>This API is more verbose than when you use the TOML file, but is designed for type-safety. The equivalent of the catalog above would be this:</p>
</div>
<div class="listingblock">
<div class="title">settings.gradle</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">dependencyResolutionManagement {
   versionCatalogs {
      libs {
           alias("guava").to("com.google.guava", "guava").versionRef("guava")
           alias("junit-jupiter").to("org.junit.jupiter", "junit-jupiter-api").versionRef("jupiter")
           alias("junit-engine").to("org.junit.jupiter", "junit-jupiter-engine").withoutVersion()
           alias("groovy-core").to("org.codehaus.groovy", "groovy").versionRef("groovy")
           alias("groovy-json").to("org.codehaus.groovy", "groovy-json").versionRef="groovy")

           version("groovy", "2.5.14")
           version("guava", "30.0-jre")
           version("jupiter", "5.7.1")
      }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This API actually must be used if you are <em>consuming an external catalog</em>.
That&#8217;s one of the big selling points of this feature: it allows teams (or framework authors) to <em>publish catalogs</em>, so that users can get recommendations.
For example, let&#8217;s imagine that the Spring Boot team <a href="https://docs.gradle.org/7.0-rc-1/userguide/platforms.html#sec:version-catalog-plugin">publishes a catalog of recommendations</a> (they do something similar today with a BOM, but BOMs will have an impact on your transitive dependencies that you might not want).</p>
</div>
<div class="paragraph">
<p>Consuming this catalog it in a Gradle build would look like this:</p>
</div>
<div class="listingblock">
<div class="title">settings.gradle</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">dependencyResolutionManagement {
   versionCatalogs {
       spring {
           from("org.springframework:spring-catalog:1.0')
       }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would make a catalog available under the <code>spring</code> namespace in your build scripts.
Therefore, you&#8217;d be able to use whatever version of SLF4J the Spring team recommends by declaring this dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">dependencies {
    implementation(spring.slf4j)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such a catalog would be published on a regular Maven repository, as a TOML file.
Thanks to Gradle&#8217;s advanced dependency resolution engine, it&#8217;s totally transparent to the user that the actual dependency is a <em>catalog</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_version_catalogs_are_not">What version catalogs are not</h3>
<div class="paragraph">
<p>At this stage, it becomes important to state what version catalogs are <strong>not</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>they <strong>are not</strong> the "single source of truth" for your dependencies: it&#8217;s not because you have a catalog that you can&#8217;t directly declare dependencies using the "old" notation in build scripts. Nor does it prevent plugins from adding dependencies. Long story short: the presence of a catalog makes discoverability and maintenance easier, but it doesn&#8217;t remove any of the flexibility that Gradle offers. We&#8217;re thinking about ways to <em>enforce</em> that all direct dependencies are declared via a catalog in the future.</p>
</li>
<li>
<p>the version declared in a catalog <strong>is not</strong> necessarily the one which is going to be resolved: a catalog only talks about direct dependencies (not transitives) and the version that you use is the one used as an <em>input</em> to dependency resolution. With transitive dependencies, it&#8217;s typically possible that a version gets upgraded, for example.</p>
</li>
<li>
<p>while it makes it possible for third-party tooling to "update automatically" versions, this wasn&#8217;t a goal of this work. If you relate to the previous point, it all makes sense: as long as you rely on the <em>input</em> (what is written) to assume what is going to be resolved, you&#8217;re only <em>wishing</em> that it is what is going to be resolved. It may be enough for some cases, though. Please refer to my <a href="https://melix.github.io/blog/2020/10/about-dependabot.html">blog post about Dependabot</a> for more insights on this topic. Again, future work we have in mind is adding some linting to make sure that the first level dependencies you declare match whatever you resolved, because in general, having a difference there is a sign that something is wrong in the setup. I&#8217;m going to repeat myself, but <strong>don&#8217;t assume that the version you see in a config file is the one you will get</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please take a look at the <a href="https://docs.gradle.org/7.0-rc-1/userguide/platforms.html#sub:central-declaration-of-dependencies">documentation</a> for further details, and give us your feedback!</p>
</div>
</div>
</div>
</div></p>
   


<div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'melixblog';
	var disqus_identifier = 'gradle-7-version-catalog';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="https://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="https://jbake.org">JBake v2.6.6</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.11.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
   <script>hljs.highlightAll();</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
  </body>
</html>
