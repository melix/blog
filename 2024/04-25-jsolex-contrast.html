<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog: JSol&#8217;Ex 2.2.0 et amélioration du contraste</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
   <script src="https://kit.fontawesome.com/fefa3ec5bf.js" crossorigin="anonymous"></script>
      
    <script src="/blog/js/highlight.min.js"></script>
    <link href="/blog/css/equilibrium-gray-light.min.css" rel="stylesheet">

    <!-- MathJax for LaTeX math rendering -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['\\(', '\\)']],
          displayMath: [['\\[', '\\]']],
          processEscapes: true
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
    <script defer data-domain="melix.github.io" src="https://analytics.champeau.me/js/script.js"></script>
  </head>
  <body>
    <div id="wrap">
   
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		          <li><a href="/blog/projects.html">Projects</a></li>
				    <li><a href="/blog/jsolex.html">JSol'Ex</a></li>
		<li><a href="/blog/astrophotography.html">Astrophotography</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
		          <li><a href="/blog/tags/jsolex.html">JSol'Ex</a></li>
				    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/micronaut.html">Micronaut</a></li>
                <li><a href="/blog/tags/index.html">See all tags</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://bsky.app/profile/melix.champeau.me"><i class="fa fa-twitter"></i></a></li>
	        <li><a rel="me" href="https://mastodon.xyz/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	        <li><a rel="me" href="https://astrodon.social/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">
	
	<div class="page-header">
		<h1>JSol&#8217;Ex 2.2.0 et amélioration du contraste</h1>
	</div>

	<p><em>25 April 2024</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/solex.html">solex</a> 
	</em>
		<a href="/blog/tags/jsolex.html">jsolex</a> 
	</em>
		<a href="/blog/tags/solaire.html">solaire</a> 
	</em>
		<a href="/blog/tags/astronomie.html">astronomie</a> 
	</p>
	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/melix/astro4j/releases/tag/2.2.0">JSol&#8217;Ex 2.2.0</a> est tout juste sorti ! Dans cette version, j&#8217;ai particulièrement travaillé sur l&#8217;amélioration des contrastes. En effet, celles et ceux qui m&#8217;ont entendu parler de ce logiciel savent que je râle depuis longtemps sur mon algo d&#8217;amélioration de contraste. Dans JSol&#8217;Ex, il y a plusieurs algorithmes d&#8217;implémentés. Historiquement, le premier était une transformation sinus hyperbolique inverse, qui fonctionne relativement bien pour faire ressortir les zones plus sombres, mais éclaircit trop le reste. L&#8217;autre algorithme, utilisé aussi par <a href="http://valerie.desnoux.free.fr/inti/">INTI</a>, c&#8217;est la normalisation locale d&#8217;histogramme (CLAHE).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_les_problèmes_avec_clahe">Les problèmes avec CLAHE</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CLAHE est un algorithme qui améliore sensiblement le contraste. Cependant, je n&#8217;ai jamais été très content du résultat. Je ne sais pas comment Valérie Desnoux fait dans INTI, qui a l&#8217;air de s&#8217;en sortir mieux, mais dans JSol&#8217;Ex les résultats obtenus sont assez moyens.
En particulier, je note plusieurs défauts :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la création d&#8217;artéfacts, liés au fait que cet algorithme travaille sur des "tuiles" d&#8217;une taille donnée. Plus la taille de la tuile est élevée, moins l&#8217;amélioration de contraste est aggressive, mais plus les artéfacts sont visibles</p>
</li>
<li>
<p>sur l&#8217;image du soleil, les limbes sont toujours éclaircis, ce qui me mène au point suivant</p>
</li>
<li>
<p>les images solaires paraissent plus "plates" : le relief, en particulier l&#8217;obscurcissement lié à la sphéricité du soleil, disparaît. C&#8217;est aussi un effet mécanique de l&#8217;algorithme lui-même : plus la taille des tuiles est faible, moins on peut utiliser de valeurs distinctes. Ainsi pour une taille de tuile à 16 pixels, on aura au maximum 256 valeurs possibles (pour une image 16 bits avec 65536 valeurs à l&#8217;origine). Or, les meilleurs résultats, sur Sol&#8217;Ex, sont obtenus avec une taille de tuile de 8 pixels, soit une réduction à 64 valeurs possibles maximum.</p>
</li>
<li>
<p>il y a trop de paramètres possibles : la taille des tuiles, la dynamique et enfin le "facteur de coupe" pour l&#8217;égalisation. Sans entrer dans les détails, trouver une combinaison qui fonctionne bien indépendamment de la taille des images en entrée, de la dynamique de l&#8217;image et enfin du type d&#8217;image (H-alpha, calcium) est presque impossible.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour illustrer mon propos, voici par exemple un disque solaire (le fichier SER est <a href="http://www.astrosurf.com/solex/sol-ex-traitement.html">celui disponible sur le site de Christian Buil</a>) traité par JSol&#8217;Ex 2.1 (version précédente donc), avec les paramètres par défaut, une tuile de taille 16 pixels (à gauche) ou 64 pixels (à droite) :</p>
</div>
<div class="paragraph">
<p>
<div class="container-fluid">
<div class="row">
   <div class="col-md-6">
      <img class="img-responsive pop" src="/blog/img/jsolex2_2/clahe_16_jsolex_2.1.jpg">
   </div>
   <div class="col-md-6">
      <img class="img-responsive pop" src="/blog/img/jsolex2_2/clahe_64_jsolex_2.1.jpg">
   </div>
</div>
</div>
</p>
</div>
<div class="paragraph">
<p>On note déja clairement éclaircissement des limbes, et des artéfacts "carrés" qui apparaissent dès que la taille des tuiles augmente.
Trouver les bons paramètres qui conviennent à tous étant compliqué, JSol&#8217;Ex offrait déja la possibilité de changer ces paramètres (taille de tuile, intensité, &#8230;&#8203;) mais je pense que peu d&#8217;utilisateurs le faisaient.</p>
</div>
<div class="paragraph">
<p>Aussi ais-je décidé d&#8217;ajouter un algorithme dans JSol&#8217;Ex 2.2 dédié aux images solaires.
Pour vous donner un peu envie de lire la suite, voici ce qu&#8217;on peut obtenir avec JSol&#8217;Ex 2.2 sur la même image :</p>
</div>
<img src="/blog/img/jsolex2_2/christian-jsolex-2.2-decon.jpg" class="img-responsive center-block" width="50%">
</div>
</div>
<div class="sect1">
<h2 id="_nouvel_algorithme">Nouvel algorithme</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le nouvel algorithme est disponible dans JSol&#8217;Ex 2.2 et est l&#8217;algorithme utilisé par défaut.
Il combine plusieurs techniques, dont une correction du gamma avec masques, CLAHE et un stretching dynamique de l&#8217;image, pour produire une image plus digne de ce que Sol&#8217;Ex peut faire.
Je ne prétends pas que cet algorithme est parfait, il a lui aussi des défauts, mais il semble être un bon compromis.</p>
</div>
<div class="paragraph">
<p>Afin de vérifier mes assertions, j&#8217;ai procédé méthodiquement à une comparaison des images produites avec les paramètres par défaut de INTI, JSol&#8217;Ex 2.1 et JSol&#8217;Ex 2.2 (la seule modification est l&#8217;autocrop activé et un retournement vertical pour que les images soient orientées de la même façon).</p>
</div>
<div class="paragraph">
<p>Commençons par la vidéo H-alpha de démonstration utilisée par Christian Buil sur son site.</p>
</div>
<div class="paragraph">
<p><strong>Les images pouvant être difficiles à comparer en taille réduite, je vous invite à faire un clic doit et ouvrir l&#8217;image dans un nouvel onglet pour comparer.</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-1.jpg" alt="comparaison panel 1">
</div>
</div>
<div class="paragraph">
<p>On note clairement que sur JSol&#8217;Ex 2.1, il y avait certes une amélioration de contraste, mais elle se faisait au prix d&#8217;artéfacts et d&#8217;une perte de relief.
En revanche, JSol&#8217;Ex 2.2 offre une image plus nette que celle d&#8217;INTI, sans avoir les défauts de CLAHE.</p>
</div>
<div class="paragraph">
<p>Continuons avec une autre image solaire en H-alpha, avec plus de dynamique :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-2.jpg" alt="comparaison panel 2">
</div>
</div>
<div class="paragraph">
<p>Là encore on remarque que JSol&#8217;Ex 2.1 produisait une image raisonnable mais assez saturée et surtout "plate".
La version 2.2.0, quant à elle, offre une meilleure dynamique tout en préservant les détails et cette impression de profondeur.</p>
</div>
<div class="paragraph">
<p>Nous pouvons aussi comparer les résultats sur une image obtenue avec une plus longue focale et un disque partiel :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-3.jpg" alt="comparaison panel 3">
</div>
</div>
<div class="paragraph">
<p>Cette fois-ci on note que les 3 logiciels s&#8217;en tirent honorablement.
Cependant, JSol&#8217;Ex 2.1.3 affiche une image moins contrastée que la v2.2.0, alors qu&#8217;INTI v6 affiche une image légèrement plus floue.</p>
</div>
<div class="paragraph">
<p>Malheureusement suite à une fausse manipulation, j&#8217;ai perdu la plupart de mes fichiers SER en raie calcium. J&#8217;ai cependant pu faire des comparaisons, sur des fichiers loins d&#8217;être idéaux.
Les résultats sont cependant intéressants :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-4.jpg" alt="comparaison panel 4">
</div>
</div>
<div class="paragraph">
<p>Cette fois-ci, on constate que JSol&#8217;Ex 2.1 s&#8217;en sortait plutôt bien. INTI là encore fait un travail remarquable, mais JSol&#8217;Ex 2.2 sature trop l&#8217;image.
C&#8217;est un défaut que j&#8217;espère arriver à corriger, qui est lié au fait que les images calcium on un histogramme avec une gaussienne à base très large.
Il est néanmoins possible d&#8217;atténuer la saturation en choisissant un facteur de correction moins fort (par exemple 1.1 au lieu de la valeur par défaut 1.5), ce que je vous encourage à faire pour les images Calcium (conserver le 1.5 pour le h-alpha, baisser pour le calcium) :</p>
</div>
<img src="/blog/img/jsolex2_2/calcium-1-jsolex-2-2-facteur-1.1.jpg" class="img-responsive center-block" width="50%">
<div class="paragraph">
<p>Le résultat dépendra cependant beaucoup de l&#8217;exposition initiale de votre vidéo. Voici un autre exemple en raie calcium K:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-5.jpg" alt="comparaison panel 5">
</div>
</div>
<div class="paragraph">
<p>Il est utile de noter que si vous n&#8217;êtes pas satisfait du nouvel algorithme, il est tout à fait possible de repasser à CLAHE :</p>
</div>
<img src="/blog/img/jsolex2_2/config-params.jpg" class="img-responsive center-block" width="50%">
<div class="paragraph">
<p>Enfin, il vous est tout à fait possible d&#8217;être plus ou moins "aggressif" sur l&#8217;amélioration de constraste à effectuer.
Ansi, dans les paramètres de traitement, vous pouvez changer le facteur <em>gamma</em> qui permet d&#8217;assombrir l&#8217;image.
Pour l&#8217;exemple, si on pousse les curseurs un peu loin (par exemple à <em>4</em> dans l&#8217;image suivante), vous constaterez que l&#8217;image reste exploitable, et surtout que les défauts de CLAHE qui a tendance à aplatir les images est complètement disparu :</p>
</div>
<img src="/blog/img/jsolex2_2/gamma-4.jpg" class="img-responsive center-block" width="50%">
</div>
</div>
<div class="sect1">
<h2 id="_pour_aller_encore_plus_loin">Pour aller encore plus loin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tout d&#8217;abord, JSol&#8217;Ex offre un <a href="https://melix.github.io/astro4j/latest/fr/jsolex.html#imagemath">langage de script</a> qui permet d&#8217;aller bien plus loin dans les traitements, de générer automatiquement des animations, etc.
Bien sûr, les améliorations de JSol&#8217;Ex 2.2 sont disponibles dans les scripts par l&#8217;intermédiaire de 2 nouvelles fonctions : <code>adjust_gamma</code> qui permet de réaliser une simple correction de gamma sur l&#8217;image, et <code>auto_constrast</code> qui correspond à la correction décrite dans ce billet de blog.</p>
</div>
<div class="paragraph">
<p>Enfin, nous n&#8217;avons pas encore parlé des fonctionnalités désactivées par défaut, mais qui étaient déja disponibles dans JSol&#8217;Ex : la déconvolution et l&#8217;amélioration de la netteté.
Ces deux options sont activables dans les paramètres de traitement :</p>
</div>
<img src="/blog/img/jsolex2_2/config-params-2.jpg" class="img-responsive center-block" width="50%">
<div class="paragraph">
<p>Je ne recommande pas nécessairement de cocher la case "aiguiser les détails" si vous avez des images trop bruitées.
Cette dernière ligne compare donc la même image, traitée avec <a href="/blog/img/jsolex2_2/halpha-3-inti-6.png" target="_blank" rel="noopener">INTI v6</a>, JSol&#8217;Ex 2.2 (dernière version donc), mais <a href="/blog/img/jsolex2_2/halpha-3-jsolex-2.2.jpg" target="_blank" rel="noopener">sans déconvolution</a>, <a href="/blog/img/jsolex2_2/halpha-3-jsolex-2.2-decon.jpg" target="_blank" rel="noopener">avec déconvolution</a> et finalement <a href="/blog/img/jsolex2_2/halpha-3-jsolex-2.2-decon-sharpen.jpg" target="_blank" rel="noopener">avec déconvolution et amélioration des détails</a> :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-6.jpg" alt="comparaison panel 6">
</div>
</div>
<div class="paragraph">
<p>En ce qui me concerne, je trouve la version déconvoluée particulièrement plaisante à l&#8217;oeil, et j&#8217;active donc systématiquement la déconvolution :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/halpha-3-jsolex-2.2-decon.jpg" alt="halpha 3 jsolex 2.2 decon">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En conclusion, dans ce billet je vous ai présenté le nouvel algorithme de correction de contraste, activé par défaut dans JSol&#8217;Ex 2.2.
Je pense que les résultats sont assez probants, et que JSol&#8217;Ex n&#8217;a plus à rougir de INTI en ce qui concerne les images avec amélioration de contraste.
Cependant, je rappelle encore une fois que le logiciel officiel <strong>est</strong> INTI, que c&#8217;est le seul validé avec le sérieux de Christian Buil et Valérie Desnoux.
Si vous voulez déposer des images sur BASS2000, vous <strong>devez</strong> utiliser INTI.
Par ailleurs, je vous conseille toujours de comparer les résultats, ne considérez pas que JSol&#8217;Ex fait un meilleur travail, c&#8217;est probablement faux.</p>
</div>
<div class="paragraph">
<p>Par exemple, il reste des améliorations à faire sur les images calcium. Mais il est cependant tout à fait possible de modifier les paramètres par défaut, voire de changer d&#8217;algorithme.</p>
</div>
<div class="paragraph">
<p>N&#8217;oubliez pas non plus que JSo&#8217;Ex offre d&#8217;autres fonctionnalités comme la colorisation automatique des images, le stacking, la création de mosaïques solaires ou encore un langage de script particulièrement puissant, qui vous permet par exemple de générer des animations automatiquement.
Je vais donc conclure ce billet avec un exemple de script qui utilise cette nouvelle amélioration de contraste pour produire une animation qui nous fait plonger dans l&#8217;atmosphère solaire en jouant sur le décalage de pixels :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"># Décalage de pixels qu'on applique, de -15 à +15, pas de 0.5
images=range(-15,15,.5)
# On calcule une image corrigée de ses transversalliums
corrigee=fix_banding(images,32,40)
# Déconvolution
decon=rl_decon(corrigee)
# On redimensionne
redim=rescale_rel(autocrop2(decon,1.1),.5,.5)
# On applique la correction de contraste décrite dans ce billet
cst=auto_contrast(redim,1.5)

[outputs]
# Enfin on produit l'animation (75ms entre chaque frame)
animation=anim(cst,75)</code></pre>
</div>
</div>
<div class="text-center">
 <video width="640" height="640" controls>
  <source src="https://melix.github.io/blog/img/jsolex2_2/animation.webm" type="video/webm">
Your browser does not support the video tag.
</video>
</div>
<div class="sect2">
<h3 id="_bonus">Bonus</h3>
<div class="paragraph">
<p>J&#8217;en profite enfin pour partager deux vidéos, à destination des débutants sur Sol&#8217;Ex, que j&#8217;ai faites récemment :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.youtube.com/watch?v=NsDgg4o2SDw">Trouver le soleil sans chercheur solaire</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=8lWXcPG16I0">Régler exposition, gain et binning</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ressources">Ressources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/melix/astro4j">JSol&#8217;Ex</a> (téléchargement)</p>
</li>
<li>
<p><a href="https://melix.github.io/astro4j/latest/fr/jsolex.html">JSol&#8217;Ex</a> (documentation)</p>
</li>
<li>
<p><a href="http://valerie.desnoux.free.fr/inti/">INTI</a> (logiciel officiel)</p>
</li>
<li>
<p><a href="http://www.astrosurf.com/solex/sol-ex-traitement.html">Sol&#8217;Ex</a> (site officiel Sol&#8217;Ex)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Adaptive_histogram_equalization">CLAHE</a> (algorithme)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Gamma_correction">Gamma correction</a> (algorithme)</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>
   
	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">Baked with <a href="https://jbake.org">JBake v2.6.6</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    
    <script src="/blog/js/jquery-1.11.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
   <script>hljs.highlightAll();</script>
  </body>
</html>
