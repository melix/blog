<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <script src="/blog/js/highlight.min.js"></script>
    <link href="/blog/css/equilibrium-gray-light.min.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body>
    <div id="wrap">
   
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/gradle.html">Gradle</a></li>
                <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/micronaut.html">Micronaut</a></li>
                <li><a href="/blog/tags/index.html">See all tags</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="/blog/2022/08/micronaut-test-resources.html"><h1>Introducing Micronaut Test Resources</h1></a>
  			<p>04 August 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/micronaut.html">micronaut</a> 
	
		<a href="/blog/tags/testcontainers.html">testcontainers</a> 
	
		<a href="/blog/tags/docker.html">docker</a> 
	
		<a href="/blog/tags/test.html">test</a> 
	
		<a href="/blog/tags/testing.html">testing</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The new <a href="https://micronaut.io/2022/08/04/micronaut-framework-3-6-0-released">release of Micronaut 3.6</a> introduces a new feature which I worked on for the past couple of months, called <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a>.
This feature, which is inspired from <a href="https://quarkus.io/guides/dev-services">Quarkus' Dev Services</a>, will greatly simplify testing of Micronaut applications, both on the JVM and using GraalVM native images.
Let&#8217;s see how.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_resources_in_a_nutshell">Test resources in a nutshell</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> simplifies testing of applications which depend on external resources, by handling the provisioning and lifecycle of such resources automatically.
For example, if your application requires a MySQL server, in order to test the application, you need a MySQL database to be installed and configured, which includes a database name, a username and a password.
In general, those are only relevant for production, where they are fixed.
During development, all you care about is having <em>one</em> database available.</p>
</div>
<div class="paragraph">
<p>Here are a couple of traditional solutions to this problem:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>document that a MySQL server is a pre-requisite, and give instructions about the database to create, credentials, etc. This can be simplified by using Docker containers, but there&#8217;s still manual setup involved.</p>
</li>
<li>
<p>Use a library like <a href="https://www.testcontainers.org/">Testcontainers</a> in order to simplify the setup</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In general, using <a href="https://www.testcontainers.org/">Testcontainers</a> is preferred, because it integrates well with the JVM and provides an API which can be used in tests to spawn containers and interact with them.
There are, however, a few issues with using such a library:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tests need to deal with the container lifecycle, which involves things like static initializers, test setup and cleanup, etc.</p>
</li>
<li>
<p>Testcontainers APIs "leak" to the test classpath, making it impossible to <a href="https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html#testing-support">run tests in native mode</a></p>
</li>
<li>
<p>You need to figure out the specific test containers dependencies you need for your application and those dependencies may have transitive dependencies which conflict with the ones you use (both in production or tests)</p>
</li>
<li>
<p>It&#8217;s difficult, or even impossible, to share containers between distinct projects (for example, an MQTT client and a server may want to use the same container)</p>
</li>
<li>
<p>It simply doesn&#8217;t work for "development mode", when you run the application locally (not tests, but really running the application)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The goal of <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> is to get rid of those obstacles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>zero-configuration</strong>: without adding any configuration, test resources should be spawned and the application configured to use them. Configuration is only required for advanced use cases.</p>
</li>
<li>
<p><strong>classpath isolation</strong>: use of test resources shouldn&#8217;t leak into your application classpath, nor your test classpath</p>
</li>
<li>
<p><strong>compatible with GraalVM native</strong>: if you build a native binary, or run tests in native mode, test resources should be available</p>
</li>
<li>
<p><strong>easy to use</strong>: the Micronaut build plugins for Gradle and Maven should handle the complexity of figuring out the dependencies for you</p>
</li>
<li>
<p><strong>extensible</strong>: you can implement your own test resources, in case the built-in ones do not cover your use case</p>
</li>
<li>
<p><strong>technology agnostic</strong>: while lots of test resources use <a href="https://www.testcontainers.org/">Testcontainers</a> under the hood, you can use any other technology to create resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> support advanced development patterns, which are useful in the microservices era.
As an example, it is capable of sharing containers between submodules of a single build, or even between independent projects, from different Git repositories!
Say that you have 2 projects, one built with Gradle, the other with Maven, both needing to communicate using the same message bus: Micronaut is capable of handling this use case for you, making it extremely easy to test components interacting with each other!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_micronaut_test_resources">Using Micronaut Test Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_enabling_test_resources_support">Enabling test resources support</h3>
<div class="paragraph">
<p><a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> integrates with build tools.
In both Maven and Gradle, you need to enable test resources support.
If you create a new project using <a href="https://micronaut.io/launch">Micronaut Launch</a> or the Micronaut CLI, test resources will be configured for you, but if you migrate an existing application to test resources, here&#8217;s what you need to do:</p>
</div>
<div class="paragraph">
<p>If you are using Maven, you will need to upgrade to the Micronaut 3.6 parent POM and add the following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">&lt;properties&gt;
   &lt;micronaut.test.resources.enabled&gt;true&lt;/micronaut.test.resources.enabled&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Gradle, you can use test resources with Micronaut 3.5+ and you simply need to use the test resources plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">plugins {
    id 'io.micronaut.application' version '3.5.1'
    id 'io.micronaut.test-resources' version '3.5.1'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_our_first_test_resources_contact">Our first test resources contact</h3>
<div class="paragraph">
<p>In this blog post we will write an application which makes use of Micronaut Data and connects to a MySQL server to list books.
The whole application code is <a href="https://github.com/melix/micronaut-test-resources-demo/">available on GitHub</a>, so I&#8217;m only going to show the relevant parts for clarity.</p>
</div>
<div class="paragraph">
<p>In such an application, we typically need a repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@JdbcRepository(dialect = Dialect.MYSQL)
public interface BookRepository extends CrudRepository&lt;Book, Long&gt; {
    @Override
    List&lt;Book&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this repository makes use of the <code>Book</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@MappedEntity
public class Book {
    @Id
    @GeneratedValue(GeneratedValue.Type.AUTO)
    private Long id;

    private String title;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order for Micronaut to use the database, we need to add some configuration to our <code>application.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml">datasources:
  default:
    schema-generate: CREATE
    db-type: mysql</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most important thing to see is that <strong>we don&#8217;t</strong> specify any username, password or URL to connect to our database: the only thing we have to specify is the database type of our datasource.
We can then write the following test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@MicronautTest
class DemoTest {

    @Inject
    BookRepository bookRepository;

    @Test
    @DisplayName("A MySQL test container is required to run this test")
    void testItWorks() {
        Book book = new Book();
        book.setTitle("Yet Another Book " + UUID.randomUUID());
        Book saved = bookRepository.save(book);
        assertNotNull(saved.getId());
        List&lt;Book&gt; books = bookRepository.findAll();
        assertEquals(1, books.size());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test creates a new book, stores it in the database, then checks that we get the expected number of books when reading the repository.
Note, again, that we didn&#8217;t have to specify any container whatsoever.
In this blog post I&#8217;m using Gradle, so we can verify the behavior by running:</p>
</div>
<div class="paragraph">
<p><code>./gradlew test</code></p>
</div>
<div class="paragraph">
<p>Then you will see the following output (cleaned up for clarity of this blog post):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>i.m.testresources.server.Application - A Micronaut Test Resources server is listening on port 46739, started in 128ms
i.m.t.e.TestResourcesResolverLoader - Loaded 2 test resources resolvers: io.micronaut.testresources.mysql.MySQLTestResourceProvider, io.micronaut.testresources.testcontainers.GenericTestContainerProvidereted
o.testcontainers.DockerClientFactory - Connected to docker:
  Server Version: 20.10.17
  API Version: 1.41
  Operating System: Linux Mint 20.3
  Total Memory: 31308 MB
🐳 [testcontainers/ryuk:0.3.3] - Creating container for image: testcontainers/ryuk:0.3.3
🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 is starting: 1f5286fa728aca74a7d6d4c0eb2148a3bc81f5c028027496d7aabda7b7ed45e8
🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 started in PT0.655476S
o.t.utility.RyukResourceReaper - Ryuk started - will monitor and terminate Testcontainers containers on JVM exit
🐳 [mysql:latest] - Creating container for image: mysql:latest
🐳 [mysql:latest] - Container mysql:latest is starting: d796c7a1ce10f393a4181f12967ee77ac9864f45595f97967c700f022e86ac7d
🐳 [mysql:latest] - Waiting for database connection to become available at jdbc:mysql://localhost:49209/test using query 'SELECT 1'
🐳 [mysql:latest] - Container is started (JDBC URL: jdbc:mysql://localhost:49209/test)
🐳 [mysql:latest] - Container mysql:latest started in PT7.573915S

BUILD SUCCESSFUL in 11s
7 actionable tasks: 2 executed, 5 up-to-date</code></pre>
</div>
</div>
<div class="paragraph">
<p>What does this tell us? First, that a "Micronaut Test Resources server" was spawned, for the lifetime of the build.
When the test was executed, this service was used to start a MySQL test container, which was then used during tests.
We didn&#8217;t have to configure anything, test resources did it for us!</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_application">Running the application</h3>
<div class="paragraph">
<p>What is also interesting is that this also works if you run the application in development mode.
Using Gradle, you do this by invoking <code>./gradlew run</code> (<code>mvn mn:run</code> with Maven): as soon as a bean requires access to the database, a container will be spawned, and automatically shut down when you stop the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Of course, in production, there won&#8217;t be any server automatically spawned for you: Micronaut will rely on whatever you have configured, for example in an <code>application-prod.yml</code> file. In particular, the URL and credentials to use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What is even nicer is that you can use this in combination with Gradle&#8217;s continuous mode!</p>
</div>
<div class="paragraph">
<p>To illustrate this, let&#8217;s create a controller for our books:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@Controller("/")
public class BookController {
    private final BookRepository bookRepository;

    public BookController(BookRepository bookRepository) {
        this.bookRepository = bookRepository;
    }

    @Get("/books")
    public List&lt;Book&gt; list() {
        return bookRepository.findAll();
    }

    @Get("/books/{id}")
    public Book get(Long id) {
        return bookRepository.findById(id).orElse(null);
    }

    @Delete("/books/{id}")
    public void delete(Long id) {
        bookRepository.deleteById(id);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start the application in <em>continuous mode</em>: <code>./gradlew -t run</code></p>
</div>
<div class="paragraph">
<p>You will see that the application starts a container as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 9166ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how it took about 10 seconds to start the application, most it it spent in starting the MySQL test container itself.
You definitely don&#8217;t want to pay this price for every change you make, so this is where the continuous mode is helpful.
If we ask for the list of books, we&#8217;ll get an empty list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 2
date: Tue, 26 Jul 2022 16:59:51 GMT

[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is expected, but notice how we didn&#8217;t have a method to actually add a book to our store.
Let&#8217;s fix this by editing the <code>BookController.java</code> class <em>without stopping the server</em>.
Add the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    @Get("/books/add/{title}")
    public Book add(String title) {
        Book book = new Book();
        book.setTitle(title);
        return bookRepository.save(book);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and notice how Gradle instantly reloads the application, but doesn&#8217;t restart the database: it&#8217;s already there so it&#8217;s going to reuse it!</p>
</div>
<div class="paragraph">
<p>In the logs you will see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 1086ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the application started in just a second! Let&#8217;s add a book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books/add/Micronaut%20in%20action
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 38
date: Tue, 26 Jul 2022 17:03:57 GMT

{
    "id": 1,
    "title": "Micronaut in action"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if we stop the application (by hitting CTRL+C) and start again, you will see that the database will be destroyed when the application shuts down.
Let&#8217;s see how we can "survive" different build invocations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_keeping_the_service_alive">Keeping the service alive</h3>
<div class="paragraph">
<p>By default, the test resources service is <em>short lived</em>: it&#8217;s going to be started at the beginning of a build, and shutdown at the end of a build.
This means, that it will live as long as you have tests running, or, if running in development mode, as long as the application is alive.
However, you can make it survive the build, and reuse the containers in several, independent build invocations.</p>
</div>
<div class="paragraph">
<p>To do this, you need to <em>explicitly start the test resources service</em>:</p>
</div>
<div class="paragraph">
<p><code>./gradlew startTestResourcesService</code></p>
</div>
<div class="paragraph">
<p>This starts the test resources service in the background: it did <em>not</em> start our application, nor did it run tests.
This means that now, we can start our application:</p>
</div>
<div class="paragraph">
<p><code>./gradlew run</code></p>
</div>
<div class="paragraph">
<p>And, because it&#8217;s the first time the application is launched since we started the test resources service, it&#8217;s going to spawn a test container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 9211ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add our book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books/add/Micronaut%20in%20action
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 38
date: Tue, 26 Jul 2022 17:03:57 GMT

{
    "id": 1,
    "title": "Micronaut in action"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference is now that if we stop the application (e.g hit CTRL+C) and start it again, it will <em>reuse the container</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 895ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we list our books, the database wasn&#8217;t cleaned, so we&#8217;ll get the book we created from the previous time we started the app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 40
date: Tue, 26 Jul 2022 17:14:40 GMT

[
    {
        "id": 1,
        "title": "Micronaut in action"
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice, right?
However there&#8217;s a gotcha if you do this: what happens if we run tests?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ ./gradlew test

&gt; Task :compileTestJava
Note: Creating bean classes for 1 type elements

&gt; Task :test FAILED

DemoTest &gt; A MySQL test container is required to run this test FAILED
    org.opentest4j.AssertionFailedError at DemoTest.java:28</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why is that? This is simply because our tests expect a <em>clean</em> database, and we had a book in it, so keep this in mind if you&#8217;re using this mode.</p>
</div>
<div class="paragraph">
<p>At some point, you will want to close all open resources.
You can do this by explicitly stopping the test resources service:</p>
</div>
<div class="paragraph">
<p><code>./gradlew stopTestResourcesService</code></p>
</div>
<div class="paragraph">
<p>Now, you can run the tests again and see them pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ ./gradlew test

...
INFO  🐳 [testcontainers/ryuk:0.3.3] - Creating container for image: testcontainers/ryuk:0.3.3
INFO  🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 is starting: ea2aa1c7f1e66a9c7306b00443e8a6693451f3f02bd780b3e2ed7b96ed59936a
INFO  🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 started in PT0.553559699S
INFO  o.t.utility.RyukResourceReaper - Ryuk started - will monitor and terminate Testcontainers containers on JVM exit
INFO  o.testcontainers.DockerClientFactory - Checking the system...
INFO  o.testcontainers.DockerClientFactory - ✔︎ Docker server version should be at least 1.6.0
INFO  🐳 [mysql:latest] - Creating container for image: mysql:latest
INFO  🐳 [mysql:latest] - Container mysql:latest is starting: 1c6437a55b8f9e5668bcec4aef27087c889b8a77ca18d2ddf58809853482a422
INFO  🐳 [mysql:latest] - Waiting for database connection to become available at jdbc:mysql://localhost:49227/test using query 'SELECT 1'
INFO  🐳 [mysql:latest] - Container is started (JDBC URL: jdbc:mysql://localhost:49227/test)
INFO  🐳 [mysql:latest] - Container mysql:latest started in PT7.469460173S

BUILD SUCCESSFUL in 11s
7 actionable tasks: 2 executed, 5 up-to-date</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_native_testing">Native testing</h3>
<div class="paragraph">
<p>Did you know that you can run your test suite in native mode?
That is to say, that the test suite is going to be compiled into a native binary which runs tests?
One issue with this approach is that it&#8217;s extremely complicated to make it work with Testcontainers, as it requires additional configuration.
With <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a>, there is no such problem: you can simply invoke <code>./gradlew nativeTest</code> and the tests will properly run.
This works because Testcontainers libraries do not leak into your test classpath: the process which is responsible for managing the lifecycle of test resources is isolated from your tests!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_under_the_hood">Under the hood</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_how_does_that_work">How does that work?</h3>
<div class="paragraph">
<p>In a nutshell, Micronaut is capable of reacting to the <em>absence</em> of a configured property.
For example, a datasource, in order to be created, would need the value of the <code>datasources.default.url</code> property to be set.
<a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> work by <em>injecting</em> those properties at runtime: when the property is read, it triggers the creation of test resources.
For example, we can start a MySQL server, then inject the value of the JDBC url to the <code>datasources.default.url</code> property.
This means that in order for test resources to work, you need to <em>remove</em> configuration (note that for production, you will need to provide an additional configuration file, for example <code>application-prod.yml</code>, which provides the actual values).</p>
</div>
<div class="paragraph">
<p>The entity which is responsible for resolving missing properties is the "Test Resources Server": it&#8217;s a long lived process which is independent from your application and it is responsible for managing the lifecycle of test resources.
Because it&#8217;s independent from the application, it means it can contain dependencies which are not required in your application such as, typically, the Testcontainers runtime.
But it may also contain additional classes, like JDBC drivers, or even your custom test resources resolver!</p>
</div>
<div class="paragraph">
<p>Because this test resources server is a separate process, it also means it can be shared by different applications, which is the reason why we can share the same containers between independent projects.</p>
</div>
<div class="paragraph">
<p>Once you understand that <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> work by resolving <em>missing</em> properties, it becomes straightforward to configure.
In particular, we offer configuration which makes it very easy to support scenarios which are not supported out of the box.
For example, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> supports several JDBC or reactive databases (MySQL, PostgreSQL, MariaDB, SQL Server and Oracle XE), Kafka, Neo4j, MQTT, RabbitMQ, Redis, Hashicorp Vault and ElasticSearch, but what if you need a different container?</p>
</div>
<div class="paragraph">
<p>In that case, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> offer a conventional way to create such containers, by simply adding some configuration lines: in the documentation <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/#modules-testcontainers">we demonstrate how to use the <code>fakesmtp</code> SMTP server with Micronaut Email</a> for example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_test_resources">Custom test resources</h3>
<div class="paragraph">
<p>If the configuration-based support isn&#8217;t sufficient, you also have, in addition, the ability to write your own test resources.
If you use Gradle, which I of course recommend, this is made extremely easy by the test resources plugin, which creates an additional source set for this, named <code>testResources</code>.
For Maven, you would have to create an independent project manually to support this scenario.</p>
</div>
<div class="paragraph">
<p>As an illustration, let&#8217;s imagine that we have a bean which reads a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@Singleton
public class Greeter {
     private final String name;

     public Greeter(@Value("${my.user.name}") String name) {
         this.name = name;
     }

     public String getGreeting() {
     	return "Hello, " + name + "!";
     }

     public void sayHello() {
         System.out.println(getGreeting());
     }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This bean requires the <code>my.user.name</code> property to be set.
We could of course set it in an <code>application-test.yml</code> file, but for the sake of the exercise, let&#8217;s imagine that this value is <em>dynamic</em> and needs to be read from an external service.
We will implement a <em>custom test resources resolver</em> for this purpose.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create the <code>src/testResources/java/demo/MyTestResource.java</code> file with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">package demo;

import io.micronaut.testresources.core.TestResourcesResolver;

import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;

public class MyTestResource implements TestResourcesResolver {

    public static final String MY_TEST_PROPERTY = "my.user.name";

    @Override
    public List&lt;String&gt; getResolvableProperties(Map&lt;String, Collection&lt;String&gt;&gt; propertyEntries, Map&lt;String, Object&gt; testResourcesConfig) {
        return Collections.singletonList(MY_TEST_PROPERTY); // <b class="conum">(1)</b>
    }

    @Override
    public Optional&lt;String&gt; resolve(String propertyName, Map&lt;String, Object&gt; properties, Map&lt;String, Object&gt; testResourcesConfiguration) {
        if (MY_TEST_PROPERTY.equals(propertyName)) {
            return Optional.of("world");                    // <b class="conum">(2)</b>
        }
        return Optional.empty();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Tells that this resolver can resolve the <code>my.user.name</code> property</p>
</li>
<li>
<p>Returns the value of the <code>my.user.name</code> property</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And in order for the resolver to be discovered, we need to create the <code>src/testResources/resources/META-INF/services/io.micronaut.testresources.core.TestResourcesResolver</code> file with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>demo.MyTestResource</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s write a test for this by adding the <code>src/test/java/demo/GreeterTest.java</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">package demo;

import io.micronaut.context.annotation.Requires;
import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import jakarta.inject.Inject;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

@MicronautTest
class GreeterTest {

    @Inject
    Greeter greeter;


    @Test
    @DisplayName("Says hello")
    void saysHello() {
        greeter.sayHello();
        Assertions.assertEquals("Hello, world!", greeter.getGreeting());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run <code>./gradlew test</code>, you will notice that Gradle will compile your custom test resource resolver, and when the test starts, you will read the following line:</p>
</div>
<div class="paragraph">
<p><code>Loaded 3 test resources resolvers: demo.MyTestResource, io.micronaut.testresources.mysql.MySQLTestResourceProvider, io.micronaut.testresources.testcontainers.GenericTestContainerProvider</code></p>
</div>
<div class="paragraph">
<p>So when the <code>Greeter</code> bean is created, it will read the value of the <code>my.user.name</code> property by calling your custom test resolver!
Of course this is a very simple example, and I recommend that you take a look at the <a href="https://github.com/micronaut-projects/micronaut-test-resources">Micronaut Test Resources sources</a> for more examples of implementing resolvers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post, we&#8217;ve explored the new <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> module, which will greatly simplify development of Micronaut applications which depend on external services like databases or messaging queues.
It works by <em>simplifying</em> configuration, by removing lines which used to be present, but now are dynamically resolved, like <code>datasources.default.url</code>.
Test resources are handled in a separate process, the test resources server, which is responsible for handling their lifecycle.
This also makes it possible to share the resources (containers, databases, &#8230;&#8203;) between independent builds.
For advanced use cases, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> provides <em>configuration based</em> resources creation.</p>
</div>
<div class="paragraph">
<p>Last but not least, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> is an extensible framework which will let you implement your own test resources in case the built-in ones miss a feature.</p>
</div>
<div class="paragraph">
<p>Special thanks to <a href="https://twitter.com/tim_yates/">Tim Yates</a> for his hard work on upgrading the Micronaut Guides to use test resources, and <a href="https://twitter.com/alvaro_sanchez">Álvaro Sanchez-Mariscal</a> for his support on the Maven plugin!</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2022/08/micronaut-test-resources.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2022/07/je-suis-le-gars-chiant.html"><h1>Je suis le gars chiant</h1></a>
  			<p>28 July 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/science.html">science</a> 
	
		<a href="/blog/tags/naturopathie.html">naturopathie</a> 
	
		<a href="/blog/tags/homéopathie.html">homéopathie</a> 
	
		<a href="/blog/tags/biais-cognitifs.html">biais cognitifs</a> 
	
		<a href="/blog/tags/zététique.html">zététique</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>La science. Si j&#8217;avais eu les capacités pour comprendre les abstractions mathématiques nécessaires (j&#8217;essaie encore, de temps en temps), je serais, peut-être, aujourd&#8217;hui assis dans un laboratoire de recherche en astrophysique. J&#8217;ai toujours trouvé fascinant la capacité à émettre des hypothèses, puis les vérifier expérimentalement, pour en faire des théories, théories qui, constamment, peuvent être remises en cause lorsque de nouvelles observations les contredisent. Je suis assis derrière un bureau, mais dans le développement informatique. Ma passion, mon loisir, c&#8217;est l&#8217;astronomie.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_alors_oui_mais_non">Alors oui, mais non</h3>
<div class="paragraph">
<p>J&#8217;ai grandi dans un monde empli de graphologie, de magnétisme, d&#8217;ufologie, de pyramidologie, d&#8217;expériences de mort imminente, qui m&#8217;ont aussi profondément marqué. J&#8217;ai entendu des témoignages, j&#8217;ai constaté des guérisons, j&#8217;ai <em>cru</em> à des beaucoup de choses. Mais pendant une grande partie de mon enfance, je n&#8217;avais pas le bagage intellectuel suffisant pour <em>comprendre</em>. En un mot, ma fascination pour les sciences se mélait allègrement à celle pour les pseudo-sciences. Parce que j&#8217;ai toujours cherché des explications, j&#8217;en suis revenu et je pense que cette expérience a renforcé mon sens critique si tant est que je me sens, de nos jours, extrêmement proche du mouvement <a href="https://fr.wikipedia.org/wiki/Z%C3%A9t%C3%A9tique">zététique</a> et combats fermement l&#8217;anti-science.</p>
</div>
<div class="paragraph">
<p>En soirée, je suis le gars chiant qui ne supporte pas qu&#8217;on introduise du surnaturel là où il existe des explications rationnelles, celui qui soulève un sourcil amusé lorsqu&#8217;on lui parle de <a href="https://fr.wikipedia.org/wiki/S%C5%93urs_Fox">séances de spiritisme</a>.</p>
</div>
<div class="paragraph">
<p>Celui qui vous explique que <a href="https://www.lequotidiendumedecin.fr/archives/pr-edzard-ernst-si-lhomeopathie-est-presentee-comme-une-panacee-il-faudra-quelle-prouve-son">l&#8217;homéopathie ne fonctionne pas</a> et qui vous rappelle que s&#8217;il <a href="https://www.monvoisin.xyz/wp-content/uploads/2020/07/Monvoisin-Pinsault-Diplo-avril19_p21.pdf">existe un effet placébo, il est moralement discutable de le rembourser</a>.</p>
</div>
<div class="paragraph">
<p>Je suis le gars chiant qui, il y a déja des années, avertissait mes amis sur la montée du <a href="https://www.ladn.eu/nouveaux-usages/antivax-histoire-mouvement/">mouvement antivax</a>.
Je suis le gars chiant qui, en tant qu&#8217;astronome amateur, vous démontre que <a href="https://www.afis.org/L-astrologie-a-l-epreuve-ca-ne-marche-pas-ca-n-a-jamais-marche">l&#8217;astrologie n&#8217;a aucun sens</a>.
Je suis le gars chiant qui s&#8217;indigne qu&#8217;on puisse vous vendre des absurdités comme des colliers en ambre pour les douleurs dentaires des bébés ou des <a href="https://menace-theoriste.fr/lithotherapie-1/">pierres à recharger sous la lumière de la lune</a>.</p>
</div>
<div class="paragraph">
<p>Je suis le gars chiant qui vous invite à douter de la médecine chinoise, responsable du <a href="https://dragondubled.fr/medecine-chinoise/rhinoceros-medecine-chinoise/">massacre des rhinocéros</a> et de la <a href="https://fr.wikipedia.org/wiki/Bile_d%27ours">maltraitance d&#8217;ours</a> pour des produits dont il est démontré qu&#8217;il n&#8217;ont aucun effet.
Je suis le gars chiant qui, lorsqu&#8217;on lui parle de produits naturels, vous rappelle que <a href="https://fr.wikipedia.org/wiki/Appel_%C3%A0_la_nature">naturel ne veut pas nécessairement dire bon pour la santé</a>.
Je suis le gars chiant qui vous explique que si les électrosensibles sont réellement malades, <a href="https://www.contrepoints.org/2021/11/22/227498-electrosensibilite-la-maladie-imaginaire-du-xxieme-siecle">ça n&#8217;est pas à cause des ondes mais de mécanismes psychologiques proches des phobies</a>.
Je suis le gars chiant qui s&#8217;insurge contre <a href="https://www.radiofrance.fr/franceinter/podcasts/antidote/antidote-du-vendredi-22-octobre-2021-5726804">la naturopathie et ses tendances complotistes</a> et invite à prendre connaissance <a href="https://www.la-croix.com/Famille/Ecole-meditation-pleine-conscience-accusee-derive-sectaire-2022-02-14-1201200267">des dérives sectaires de la méditation pleine conscience</a>.</p>
</div>
<div class="paragraph">
<p>Je suis le gars chiant qui se dit écolo, mais aussi pro-nucléaire: je suis effondré lorsque les <a href="https://www.latribune.fr/economie/union-europeenne/l-allemagne-pourrait-prolonger-des-centrales-a-charbon-pour-reduire-sa-dependance-au-gaz-russe-906817.html">écolos incitent à relancer des centrales à charbon</a> alors que <a href="https://bonpote.com/nouveau-rapport-du-giec-agir-coutera-moins-cher-que-le-business-as-usual/">les rapports du GIEC nous disent que chaque tonne de CO2 compte</a>.
Je suis le gars chiant qui choque ses amis écolos lorsqu&#8217;il affirme que <a href="https://doseequivalentbanana.home.blog/2021/05/08/dechets-8-on-ne-sait-pas-gerer-les-dechets-nucleaires/">le stockage géologique des déchets nucléaire n&#8217;est pas un problème pour les générations futures</a>.</p>
</div>
<div class="paragraph">
<p>Je me sens écologiste et je suis convaincu que nous devons aller vers la sobriété: je recherche des modes de vie alternatifs, moins impactants pour l&#8217;environnement, moins industriels et à ce titre j&#8217;ai été attiré par les concepts des <a href="https://fr.wikipedia.org/wiki/Mouvement_Colibris">colibris</a> et ses nombreuses variantes.
Mais je vérifie, je confronte mes croyances. Je suis le gars chiant qui découvre que presque tous les mouvements écologistes sont infiltrés par des groupes anti-science, au premier rang desquels on trouve la <a href="https://blogs.mediapart.fr/mathieu-repiquet/blog/090520/qu-est-ce-que-l-anthroposophie-entretien-avec-gregoire-perra">secte anthroposophique</a>. Je suis le gars chiant qui vous fait remarquer que <a href="https://www.reussir.fr/ce-celebre-youtubeur-radicalement-change-sa-vision-de-lagriculture">la permaculture ne permet pas d&#8217;être auto-suffisant</a>, que la plupart de ces mouvements dits alternatifs ne survivent que grâce à des "formations" qui s&#8217;auto-entretiennent et/ou financent des sectes.</p>
</div>
<div class="paragraph">
<p>Je suis l&#8217;écolo qui vous déculpabilise de ne pas <a href="https://www.youtube.com/watch?v=rtG77t9kshE">effacer vos emails car celà ne réduira pas votre emprunte carbone</a>, mais en profite pour vous faire remarquer que ne pas utiliser votre sèche-linge, oui.</p>
</div>
<div class="paragraph">
<p>Je suis le gars chiant qui s&#8217;inquiète lorsque des proches suivent des formations de développement personnel ou aux <a href="https://fr.wikipedia.org/wiki/Enn%C3%A9agramme">ennéagrammes</a>, parce qu&#8217;il cherche <a href="https://www.unadfi.org/actualites/domaines-dinfiltration/sante-et-bien-etre/psychotherapie-et-developpement-personnel/alerte-sur-les-formations-a-l-enneagramme/">qui sont ceux derrière ces mouvements</a> et se rend compte qu&#8217;il est très facile de tomber dans des dérives sectaires et ne pas s&#8217;en rendre compte.</p>
</div>
<div class="paragraph">
<p>Je suis aussi le gars chiant qui fait confiance aux autorités sanitaires, y compris quand elles concluent qu&#8217;<a href="https://france3-regions.francetvinfo.fr/pays-de-la-loire/loire-atlantique/nantes/cancers-pediatriques-du-pays-de-retz-retour-sur-six-annees-de-combat-1990363.html">il n&#8217;y a statistiquement pas de surnombre de cancers pédiatriques au Sud de Nantes</a> alors qu&#8217;on était en <a href="https://www.ouest-france.fr/pays-de-la-loire/sainte-pazanne-44680/cancers-pediatriques-un-22-sup-e-sup-cas-confirme-autour-de-sainte-pazanne-da95a8e2-f7fc-11ea-86be-f690571173ca">droit de s&#8217;inquiéter</a>, mais aussi prêt à revoir ma position si de nouvelles données étaient disponibles.</p>
</div>
<div class="paragraph">
<p>Je suis celui qui heurte la sensibilité de ses amis, les choque, les énerve parfois (souvent), parce que j&#8217;apparais comme ne croyant en rien.</p>
</div>
</div>
<div class="sect2">
<h3 id="_triste_vie_que_celle_de_celui_qui_ne_croît_en_rien">Triste vie que celle de celui qui ne croît en rien</h3>
<div class="paragraph">
<p>Est-ce vrai ? Est-ce que je ne crois réellement en rien ?
Bien évidemment non.
J&#8217;ai mes propres croyances.
Par exemple, je <em>crois</em> qu&#8217;il existe une vie extra-terrestre. Sous quelle forme, je n&#8217;en sais rien, mais j&#8217;en suis intimement convaincu. Mais il s&#8217;agit d&#8217;une croyance, et en tant que tel, je n&#8217;essaierai pas de vous l&#8217;imposer. Je peux vous donner des idées sur le <em>pourquoi</em> j&#8217;y crois, mais il n&#8217;existe aucune <em>preuve</em>.
J&#8217;ai cru à beaucoup de choses aussi: gamin j&#8217;ai cru au bisou magique, j&#8217;ai cru au Père Noël, j&#8217;ai cru que la graphologie fonctionnait (alors que je suis horrifié de constater que cet outil est toujours utilisé de nos jours !).
Je crois qu&#8217;il n&#8217;existe pas de vie après la mort, mais je ne peux pas vous en apporter la preuve.
Je crois aussi qu&#8217;on n&#8217;a pas besoin de revenir 200 ans en arrière en agriculture pour "sauver la planète".</p>
</div>
<div class="paragraph">
<p>Alors on pourrait dire "mais c&#8217;est pas bien grave", "mais les plantes c&#8217;est quand même bien, c&#8217;est mieux que les produits chimiques", "la science n&#8217;explique pas tout", "faut il se fâcher pour ça ?".
Tant de lieux communs, qui n&#8217;apportent rien, mais qui, en revanche, cachent de tristes réalités: <a href="https://www.leparisien.fr/faits-divers/miguel-b-le-naturopathe-qui-pretend-guerir-le-cancer-aurait-fait-au-moins-deux-autres-victimes-14-10-2021-XMQKFRJHGFFDLJQRZZ4DWW4E5E.php">des morts</a>, souvent <a href="https://www.midilibre.fr/2021/11/23/covid-19-quest-ce-que-lanthroposophie-possible-frein-a-la-vaccination-dans-les-pays-germanophones-9945410.php">par milliers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dur_dêtre_celui_qui_gâche_la_fête">Dur d&#8217;être celui qui gâche la fête</h3>
<div class="paragraph">
<p>Alors je si je suis suis le gars chiant, je ne cache pas que c&#8217;est parfois fatigant, moralement: si j&#8217;écris ce billet, c&#8217;est aussi pour exprimer cette fatigue.
C&#8217;est fatigant parce que je vais contre les idées reçues, je "casse l&#8217;ambiance" mais surtout je peux me fâcher avec des personnes que j&#8217;apprécie énormément.
C&#8217;est fatigant parce qu&#8217;on me regarde en sachant d&#8217;avance que je vais intervenir, mais on ne croira pas ce que je dis, même preuves à l&#8217;appui.
C&#8217;est fatigant parce que je constate la montée de l&#8217;obscurantisme, du complotisme et que je me sens impuissant.
C&#8217;est fatigant parce qu&#8217;il est urgent d&#8217;agir pour sauver notre avenir (je ne parlerai pas de sauver la planète, c&#8217;est l&#8217;espèce humaine, et les espèces actuelles en général qui est en jeu) et que les décisions prises ne sont pas à la hauteur.
C&#8217;est fatigant parce que j&#8217;aspire à plus d&#8217;écologie, plus de simplicité, mais que tous les mouvements que je trouve sont plombés par de l&#8217;anti-science et des sectes déguisées en "spiritualité".
C&#8217;est fatigant parce qu&#8217;on me caricature: je suis le "rationnel" qui ne comprend rien aux sciences humaines ou à l&#8217;humain en général.
C&#8217;est fatigant parce qu&#8217;on se bat constamment contre l&#8217;intolérance.
Tout ce que je vous raconte est présent partout: famille, amis, collègues, politiques, mais chez moi y compris.</p>
</div>
<div class="paragraph">
<p>Alors, parfois, parce que je ne veux pas me fâcher ou faire honte à madame, je me tais et je deviens d&#8217;humeur sombre, ne m&#8217;en voulez pas.</p>
</div>
<div class="paragraph">
<p>Nous sommes tous pleins de croyances: la question est de savoir si nous sommes prêts à les remettre en question, pour le bien de tous, et si ces croyances doivent influencer les décisions que nous prenons pour la communauté.
Et parce que nous sommes tous susceptibles de faire des erreurs, je ne porte aucun jugement moral à celles et ceux qui croient ceci ou celà: nous sommes tous pleins de contradictions et je ne suis pas mieux qu&#8217;un autre.
Je n&#8217;en veux pas à ceux qui croient, je ne doute pas qu&#8217;ils aient de bonnes intentions.
Je pourrais en vouloir à ceux qui continuent de croire lorsqu&#8217;on leur montre qu&#8217;il y a de quoi douter, ou mieux qu&#8217;on leur apporte des preuves, mais <a href="https://fr.wikipedia.org/wiki/Biais_cognitif">notre cerveau est câblé pour rendre la remise en question difficile</a>.
J&#8217;en veux, en revanche, à ceux qui utilisent <em>sciemment</em> l&#8217;ignorance des gens pour en tirer profit financièrement ou pour psychologiquement de personnes.</p>
</div>
<div class="paragraph">
<p>Je n&#8217;ai pas de chiffres à vous donner, mais <em>je crois</em> que ces ordures sont nombreuses.</p>
</div>
</div></p>
			<p><a href="/blog/2022/07/je-suis-le-gars-chiant.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2022/07/there-is-no-single-dependency-graph.html"><h1>There is no single dependency graph</h1></a>
  			<p>04 July 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	
		<a href="/blog/tags/dependency-management.html">dependency-management</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>What are the dependencies of Micronaut?
While the question may seem obvious, the answer is not.
I realized, over the years, that many developers tend to ignore the complexity of dependency management in the Java ecosystem.
In particular, I faced several occasions when discussing dependency upgrades (in particular in the context of security updates) when it became obvious that there was a big gap between the mental model that some people have, and the reality.
In this blog post I want to address some misconceptions around dependencies in the Java ecosystem.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_libraries_vs_applications">Libraries vs applications</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_applications_are_easier">Applications are easier</h3>
<div class="paragraph">
<p>First and foremost, we have to make a difference between a <em>library</em> and an <em>application</em>.
If I install, say, a desktop application, then the notion of "dependencies of the application" seem quite obvious: they are often bundled with the application in a <code>libs</code> directory, so all we have to do is look into that.
Therefore, the question "what are the dependencies of X" can be conflated to a simpler question: "what are the dependencies that application X requires at runtime to run properly".</p>
</div>
<div class="paragraph">
<p>This is already a simplfication, though: nothing prevents the application from using a plugin system.
This would make the answer to that question more complicated, but let&#8217;s focus on the simplest case.
Because we have that file list at hand, answering questions like "is X vulnerable to log4shell" is easy: we can look into the <code>libs</code> directory, and if we find a vulnerable version of log4j in there, then we know for sure if the application uses a vulnerable dependency.</p>
</div>
<div class="paragraph">
<p>This model, the "Windows installer" one, is what lots of developers have in mind.
The problem is often that they assume that the <em>libraries</em> work the same, but they don&#8217;t.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_library_dependencies">Library dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For libraries (and frameworks, which can be seen as "super libraries") the answer is indeed more complex.
A library is intended to be consumed by an application, or another library.
Therefore, when we ask the question "what are the dependencies of library L", then the answer is "it depends".</p>
</div>
<div class="paragraph">
<p>In particular, libraries will introduce us to the world of <em>transitive dependencies</em>: an application will depend on libraries, which themselves have dependencies on other libraries.</p>
</div>
<div class="paragraph">
<p>For example, you can have the following dependency graph:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/simple-dependency-graph.svg" alt="simple dependency graph" width="178" height="345">
</div>
</div>
<div class="paragraph">
<p>We can already see that we have a pelicular situation, where 2 libraries depend on the same module <code>c</code>.
If they require the same version of <code>c</code>, then we are lucky.
If they don&#8217;t, then we run in a situation called a <em>version conflict</em>, where different tools will use different strategies to solve them (no, Maven and Gradle, in particular, don&#8217;t have the same way of dealing with dependency conflicts).</p>
</div>
<div class="paragraph">
<p>Say that <code>a</code> requires <code>c 1.0</code> and that <code>d</code> requires <code>c 1.1</code>: a reasonable strategy is to do <em>optimistic upgrades</em> and to choose <code>c 1.1</code> because it&#8217;s the highest version.
This is the default strategy that Gradle uses, for example.
Maven, on the other hand, takes a simpler, but non prectictable strategy of "closest first", where "closest" actually means "first seen wins".
In other words, if <code>a</code> is seen first, then <code>c 1.0</code> will be used.
Reverse the order of dependencies and <code>c</code> will use version <code>1.1</code>.
Gradle&#8217;s strategy is immune to those problems, but we can already see that there can be a difference between the dependencies which are <em>declared in a build file</em> and the ones which will <em>effectively be used</em>.</p>
</div>
<div class="paragraph">
<p>As a consequence, <strong>it&#8217;s a mistake to look at the declared dependencies to determine what are the effective dependencies of a project</strong>.
You must always look at the resolved dependency graphs.
This is why I wrote, a few months ago, that <a href="http://localhost:8820/blog/2020/10/about-dependabot.html">Dependabot gave a false sense of security</a> (hopefully, now, they provide <a href="https://github.blog/2022-07-01-extend-your-dependency-information-in-the-github-dependency-graph-with-new-github-actions/">an API which can be used to mitigate that problem</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_from_sources">Building from sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we understand that the declared dependencies can be different from the <em>resolved</em> dependencies, and that we reckon that it&#8217;s the build tool&#8217;s responsibility to solve those conflicts, let&#8217;s address an elephant in the room: building a proejct <em>entirely</em> from sources (including transitive dependencies).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine that, for legal reasons, you don&#8217;t want to use Maven Central.
Instead you want to build your project against the <em>sources</em> of your dependencies and build themselves from dependencies, and so on.
Obviously, if your build tool doesn&#8217;t support resolving a dependency graph first (which implies having metadata available for transitive dependencies in some form) <em>then</em> replacing the dependencies with their sources instead of the binaries, then you have a problem: you&#8217;re going to have to figure out yourself what libraries to build, in which versions, and do everything by hand.
Spoiler alert: no build tool supports that (in the Java ecosystem, some ecosystems like Rust <em>always</em> use source dependencies, which come with a number of other issues I won&#8217;t address in this blog post).</p>
</div>
<div class="paragraph">
<p>This means that in order to build your project, you must:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>resolve all dependencies, including transitive dependencies, to figure out what <em>version</em> they need</p>
</li>
<li>
<p>find a way to fetch the sources for the particular version of each dependency that is used</p>
</li>
<li>
<p>update the build scripts of that project to use <em>source dependencies</em></p>
</li>
<li>
<p>compile each project independently, and recurse to 1.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But hey, don&#8217;t you see the problem already (except from the fact you&#8217;d have to rewrite all build files, and figure out how to build each project according to their CI specification)?
Because resolved dependency graphs only depend on the <em>top level</em> project being compiled, you have absolutely no guarantee that you&#8217;ll use the same, resolved versions everywhere.
In the dependency graph above, if you resolve the dependency graph for <code>app</code>, then you will determine that you need to build <code>c</code> in version <code>1.1</code> from sources.
Alright, but to build <code>a</code>, we will need to build <code>c</code>&#8230;&#8203; with version <code>1.0</code>!
In other words, there&#8217;s no way you can <em>consistently</em> build such a dependency graph from source without having a <em>single, globally resolved</em> dependency graph, and a <em>single build</em>.
The only alternative to that is basically to go down the tree, build some artifacts, then replace transitive dependencies with <em>file</em> dependencies and cross fingers that everything compiles up to the top.
Of course this is completely unrealistic in the real world, unless you have millions of dollars to spend on rebuilding artifacts (and yes, some organizations do that, that&#8217;s the strategy for debian, for example, which has the "nice" side effect of having applications which have bugs which are not in the initial release, because all applications need to use the <em>same</em> dependency version).</p>
</div>
<div class="paragraph">
<p>That&#8217;s why I think the preferred solution, for security, is still to use precompiled binaries (which also would make builds faster in any case), but combine that with <a href="https://docs.gradle.org/current/userguide/dependency_verification.html">dependency verification</a>: it&#8217;s a good tradeoff, which offers the right level of security, while not having to spend incredible amounts of money in rebuilding the entire world (also, it&#8217;s better for the planet).
Note that this also guarantees trust, as your "custom built" binaries will clearly use different signatures, and possibly checksums, than what the users normally expect.</p>
</div>
<div class="paragraph">
<p>While we were talking about building from sources, we <em>also</em> forgot about one extremely important bit: <em>there is no single dependency graph</em>, even in a single project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_requires_multiple_dependency_graphs">Building requires multiple dependency graphs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most obvious way to illustrate that there&#8217;s no single dependency graph in a project is to thing about <em>tests</em>.
When you compile your application, there shouldn&#8217;t be any test dependency on the compile classpath.
When you compile your <em>tests</em>, then you&#8217;d get the dependencies of the application, plus the dependencies of your test framework, plus your additional test dependencies.</p>
</div>
<div class="paragraph">
<p>Therefore, you have at least 2 distinct dependency graphs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the application compile classpath (in Gradle, it&#8217;s the <code>compileClasspath</code> configuration which represents that dependency graph)</p>
</li>
<li>
<p>the application test compile classpath (in Gradle, it&#8217;s the <code>testCompileClasspath</code> configuration which represents that dependency graph)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maven itself makes a difference, with dependency <em>scopes</em> (<code>compile</code>, <code>runtime</code>, <code>test</code>, &#8230;&#8203;).
You can already see that in practice, we have <em>many more</em> dependency graphs: compile classpath, runtime classpath, test compile classpath, test runtime classpath, annotation processing path, functional tests compile/runtime classpath, etc.
A project can literally have dozens of different dependency graphs.</p>
</div>
<div class="paragraph">
<p>More importantly, there can be conflicts in those graphs: for example, when you compile your tests, you may introduce a dependency which will accidentally trigger an <em>upgrade</em> of a dependency, so you would get a different dependency version during testing and actual run time!
Similarly, your runtime dependencies can introduce transitive dependencies which would have the consequence of having different versions of dependencies at compile time and run time.
Note that Gradle offers different ways to mitigate those real world problems, for example <a href="https://docs.gradle.org/current/userguide/resolution_strategy_tuning.html#resolution_consistency">consistent resolution</a> or <a href="https://docs.gradle.org/6.2.1/userguide/dependency_version_alignment.html">version alignment</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I hope that after reading this, it becomes quite clear that <em>there is no single dependency graph</em>.
Therefore, it&#8217;s a mistake to ask for "what are the dependencies of Micronaut", because the answer <em>depends on the consumer</em>.
Not only does it depend on the consumer, but it also depends on either the order of dependencies (Maven for example), or the strategies being used to "force" dependency versions (which are also consumer dependent), or the kind of dependency graph which is resolved (runtime dependencies, compile dependencies).
Of course, we didn&#8217;t mention more advanced features like optional dependencies, for which I like to remind that <a href="https://blog.gradle.org/optional-dependencies">they are not optional</a>, nor did we talk about more advanced, runtime based systems like OSGi which add another layer of complexity to the problem.</p>
</div>
<div class="paragraph">
<p>If you can take away one thing from this blog post, it&#8217;s to never ask "what are the dependencies of X" anymore: minimally, the question should be more targetted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>what are the dependencies that X need to compile?</p>
</li>
<li>
<p>what are the dependencies that X uses at runtime to run its test suite?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The question "what are the dependencies that X uses at runtime" is only valid for <em>some</em> applications (for example those which are not subject to platform dependent dependencies), not for <em>libraries</em>.</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2022/07/there-is-no-single-dependency-graph.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2022/05/gradle-laziness.html"><h1>Gradle quickie: laziness</h1></a>
  			<p>24 May 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/gradle.html">gradle</a> 
	
		<a href="/blog/tags/laziness.html">laziness</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Yesterday, I wrote this tweet:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/2022-05-24-tweet.png" alt="2022 05 24 tweet">
</div>
</div>
<div class="paragraph">
<p>I got a surprisingly high number of answers, so I thought it would be a good idea to expand a bit on the topic.</p>
</div>
<div class="paragraph">
<p>Gradle <a href="https://docs.gradle.org/current/userguide/lazy_configuration.html">introduced lazy APIs several years ago</a>.
Those APIs are mostly directed at plugin authors but some build authors may have to deal with them too.
Lazy APIs are designed to improve performance, by avoiding to create tasks which would never be invoked during a build.
While lots of users wouldn&#8217;t notice the difference between a build using lazy APIs and a build which doesn&#8217;t, in some ecosystems like Android or with large projects, this makes a dramatic difference.
In other words, while Gradle&#8217;s performance is often praised, it&#8217;s easy to break performance by unintentionally trigerring configuration of tasks which shouldn&#8217;t.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_task_configuration">Task configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The discussion was trigerred when I was doing a code review yesterday.
I saw the following block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.withType(Test) {
    testLogging {
        showStandardStreams = true
        exceptionFormat = 'full'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This block configures logging for all test tasks of the project.
At first glance, this seems appropriate, but there&#8217;s this gotcha: you should use <code>.configureEach</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.withType(Test).configureEach {
    testLogging {
        showStandardStreams = true
        exceptionFormat = 'full'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t, then <em>all tasks of type Test will always be configured</em>, even if you don&#8217;t call them in a build.
In other words, lazy configuration is about only configuring tasks which are going to be invoked.</p>
</div>
<div class="paragraph">
<p>Unfortunately, there are no warnings about eager configuration, or "unnecessary" configuration in a build.
If you use <a href="https://ge.micronaut.io">Build Scans</a>, you can have insights about configuration and realize that, but casual users wouldn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Similarly, this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">test {
    testLogging {
        showStandardStreams = true
        exceptionFormat = 'full'
    }
}
----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will configure the <code>test</code> task (not <em>all</em> test tasks) eagerly: even if the <code>test</code> task isn&#8217;t executed in a build, it would be configured.
Now you see the problem: this configuration pattern has been there basically forever, so it&#8217;s hard to remove.
To do lazy configuration, you have to write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.named('test') {
    testLogging {
        showStandardStreams = true
        exceptionFormat = 'full'
    }
}
----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, this isn&#8217;t as nice, DSL-wise.
One thing you may wonder is why Gradle&#8217;s DSL default to the lazy version?
In other words, why doesn&#8217;t it call the lazy version instead of the eager one?</p>
</div>
<div class="paragraph">
<p>It&#8217;s because of backwards compatiblity: because this pattern has been present since day one in Gradle, eager configuration is everywhere in older builds.
If you search for configuration blocks in Stack Overflow, it&#8217;s very likely that you&#8217;ll end up copy and pasting <em>eager configuration</em> samples.
But, as the name implies, <em>lazy</em> configuration has a different behavior than <em>eager</em>: in the lazy case, the configuration block is invoked <em>only when the task is needed</em>, either because it&#8217;s going to be executed, or that another task depends on its configuration to configure itself.
In the eager case, configuration is executed immediately: unfortunately there are lots of builds which accidentally depend on this order of execution, so changing from eager to lazy could result in breaking changes!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_should_you_use">What should you use?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The consequence is that there&#8217;s a mix of lazy and eager APIs in Gradle, and making the difference between what is going to trigger configuration or not isn&#8217;t obvious, even for Gradle experts.
Let&#8217;s summarize a few patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to configure <em>one particular task</em> by name, you should write:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.named("myTask") {
   // configure the task
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.named("myTask", SomeType) {
   // configure the task
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to all tasks of a particular type, you should write:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.withType(SomeType).configureEach {
   // configure the task
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to create a new task, <em>don&#8217;t use create</em>, but <em>register</em> instead:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.register("myTask", SomeType) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the DSL, the following code that you find in many tutorials would <em>immediately create a task</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">task hello {
   doLast {
       println "Hello!"
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the correct way to do this is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.register("hello") {
    doLast {
         println "Hello!"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the return type of both calls is <em>different</em>: the eager version will return a <code>Task</code>, while the 2d one returns a <code>TaskProvider</code>.
This is the reason why upgrading plugins isn&#8217;t that trivial, since it&#8217;s a binary breaking change!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_task_collections_and_implicit_dependencies">Task collections and implicit dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In <a href="https://melix.github.io/blog/2022/01/understanding-provider-api.html">a previous blog post</a> I explained that the provider API is the right way to handle implicit inputs.
For example, you can pass directly a <code>TaskProvider</code> as an element of a file collection: Gradle would automatically resolve dependencies and trigger the configuration of that task, include it in the task graph and use its output as an input of the task you&#8217;re invoking.</p>
</div>
<div class="paragraph">
<p>Therefore, understanding lazy APIs means that you should understand <em>when</em> things are executed.
In the example above, the call <code>tasks.withType(Test)</code> by itself does <em>not</em> configure anything.
You can see it as a lazy predicate: it returns a <em>live task collection</em>, it&#8217;s a declaration of intent: "this models all tasks of type `Test`".</p>
</div>
<div class="paragraph">
<p>Therefore, the following blocks of code are strictly equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.withType(Test) {
   // configure
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.withType(Test).each {
    // configure
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">def testTasks = tasks.withType(Test)
testTasks.each {
    // configure
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, the last version explains the "magic" behind the traditional Gradle DSL.
The first line is lazy, returns a task collection, and it&#8217;s the fact of calling <code>.each</code> which triggers configuration of all tasks!
Replace <code>.each</code> with <code>.configureEach</code> and you are now lazy!</p>
</div>
<div class="paragraph">
<p>Newer APIs like <code>named</code> are lazy from day one, but are not necessarily user friendly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_gradle_puzzle">A Gradle puzzle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In effect, <code>named</code> is lazy in terms of <em>configuration</em>, but <em>eager</em> in terms of lookup: it will <strong>fail</strong> if the task that you&#8217;re looking for doesn&#8217;t exist.
It&#8217;s a bit strange, since in Gradle everything is now supposed to be lazy, so you can&#8217;t know <em>when</em> a task is going to be available or not.
As an illustration, let&#8217;s explore the following script (don&#8217;t write this in your own builds, this is for demonstration purposes!):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.register("hello") {
   doLast {
       println "Hello,"
   }
}

tasks.named("hello") {
   doLast {
        println "World!"
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run <code>gradle hello</code>, then the output is what you expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>&gt; Task :hello
Hello,
World!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, <em>invert</em> the position of the 2 tasks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.named("hello") {
   doLast {
        println "World!"
   }
}

tasks.register("hello") {
   doLast {
       println "Hello,"
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and run again. Boom!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>* Where:
Build file '/tmp/ouudfd/build.gradle' line: 1

* What went wrong:
A problem occurred evaluating root project 'ohnoes'.
&gt; Task with name 'hello' not found in root project 'ohnoes'.</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is very unexpected: I think what most people would expect is, if any change, that the <code>World!</code> and <code>Hello</code> outputs would be exchanged.
But because <code>named</code> <em>eagerly</em> searches for a task registed with a particular name, it <em>fails</em> if not found.</p>
</div>
<div class="paragraph">
<p>As a consequence, plugin authors who want to react to other plugins, or react to tasks which <em>may</em> be present or not, tend to use the following API instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.matching { it.name == 'hello' }.configureEach {
    doLast {
        println "World!"
   }
}

tasks.register("hello") {
   doLast {
       println "Hello,"
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s run our <code>hello</code> task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>&gt; Task :hello
World!
Hello,</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yay! No failure anymore, and the output is in the order we expected. Problem solved, right?</p>
</div>
<div class="paragraph">
<p>Well, not so fast.
You&#8217;ve used <code>configureEach</code>, so everything should be lazy, right?
Sorry, nope: the <code>matching</code> API is an <em>old</em>, eager API!
Actually, if you look at what the predicate uses, it becomes obvious:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">// T is a Task!
TaskCollection&lt;T&gt; matching(Spec&lt;? super T&gt; var1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because it works on <code>Task</code> instances, it needs to <em>create and configure the tasks</em> so that you can run an arbitrary predicate on them!</p>
</div>
<div class="paragraph">
<p>That&#8217;s why if you have to write things like this, you <strong>must</strong> guard calls to <code>matching</code> with a <code>withType</code> before, which will restrict the set of tasks which will be configured.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.withType(Greeter).matching { it.name == 'hello' }.configureEach {
   messages.add("World!")
}

tasks.register("hello", Greeter) {
   messages.add("Hello,")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course the example is a bit stupid, but it makes sense when you&#8217;re not the one in control of <em>when</em> a task is configured or even if you don&#8217;t know if it will ever be.</p>
</div>
<div class="paragraph">
<p>Unfortunately, <a href="https://github.com/gradle/gradle/issues/16543">Gradle doesn&#8217;t provide an API which is <em>fully lazy</em> and lenient to tasks being present or not</a>.
If you simply want to <em>configure</em> a task, that is not a big deal since you can simply use <code>configureEach</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.configureEach {
    if (it.name == 'hello') { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is fine because the configuration block will be called for each task being configured.
However, this <code>configureEach</code> block is a <em>configurer</em>, not a <em>predicate</em>, so you can&#8217;t use it as an input to another task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">tasks.named("md5") {
    inputFiles.from(tasks.named("userguide"))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above would <em>fail</em> if the <code>userguide</code> task doesn&#8217;t exist <em>before</em> the <code>md5</code> task is configured&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post, I have explained why you should use the new lazy APIs instead of their eager counterparts.
I have also described that while they are more verbose, they make it possible to have faster builds by avoiding configuration of tasks which would not be executed.
However, Gradle doesn&#8217;t warn you if you eagerly configure tasks, and it&#8217;s easy to shoot yourself in the foot.
Some would blame the docs, some would blame the APIs.</p>
</div>
<div class="paragraph">
<p>As a former Gradler, I would blame none of those: the <a href="https://docs.gradle.org/current/userguide/lazy_configuration.html">docs are here</a>, and changing the APIs to be lazy everywhere is either a binary breaking change (return type of methods which <em>create</em> instead of <em>register</em>), or a behavior change (deferred configuration vs immediate configuration).
This makes it particularly complicated to upgrade builds without pissing off a number of users!</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2022/05/gradle-laziness.html#disqus_thread">Comments</a></p>
	
	<hr />
	
	<p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="https://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="https://jbake.org">JBake v2.6.6</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.11.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
   <script>hljs.highlightAll();</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
  </body>
</html>
