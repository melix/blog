<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
   <script src="https://kit.fontawesome.com/fefa3ec5bf.js" crossorigin="anonymous"></script>
      
    <script src="/blog/js/highlight.min.js"></script>
    <link href="/blog/css/equilibrium-gray-light.min.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body>
    <div id="wrap">
   
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/gradle.html">Gradle</a></li>
                <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/micronaut.html">Micronaut</a></li>
                <li><a href="/blog/tags/index.html">See all tags</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a></li>
	        <li><a rel="me" href="https://mastodon.xyz/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	        <li><a rel="me" href="https://astrodon.social/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="/blog/2022/11/monitoring-elec.html"><h1>Monitoring pour optimiser ma conso électrique</h1></a>
  			<p>26 November 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/solaire.html">solaire</a> 
	
		<a href="/blog/tags/fioul.html">fioul</a> 
	
		<a href="/blog/tags/électricité.html">électricité</a> 
	
		<a href="/blog/tags/solaredge.html">solaredge</a> 
	
		<a href="/blog/tags/dualsun.html">dualsun</a> 
	
		<a href="/blog/tags/raspberry.html">raspberry</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>En juillet dernier, j&#8217;ai fait installer des panneaux solaires.
Cette installation change considérablement nos habitudes de consommation: au lieu de consommer de préférence aux heures creuses, il est préférable de consommer lorsque la production locale le permet.
Dans ce billet, je vous explique ce que j&#8217;ai mis en place pour nous aider dans l&#8217;optimisation de notre consommation, en particulier un outil de monitoring avec un Raspberry PI.
L&#8217;objectif de mon projet est de réduire ma facture électrique en maximisant l&#8217;autoconsommation.
Nous allons donc voir comment l&#8217;installation des panneaux peut changer nos habitudes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/elec/moniteur-sep.jpg" alt="moniteur sep">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_de_panneaux_solaires">Installation de panneaux solaires</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il y a longtemps que l&#8217;idée nous trottait dans la tête.
En effet, ici, nous chauffions au fioul, ce qui avait un certain nombre d&#8217;inconvénients: pollution (fort émetteur de CO₂), prix très variable (entre 800€ et 1400€ les 1000L selon les saisons), bruit (la chaudière), odeurs de combustion, etc.
Cette chaudière au fioul nous servait à la fois à chauffer l&#8217;eau chaude, mais aussi au chauffage domestique.
La maison étant relativement bien isolée, nous arrivions cependant, à 4 personnes, à ne consommer qu&#8217;environ 1000L de fioul par an.
Une vieille chaudière à fioul était tombée en panne en plein hiver, il y a 5 ans, nous avions dû la changer en urgence, et, je me souviens très bien de cela, il se trouve que j&#8217;étais à ce moment à l&#8217;étranger pour le "Gradle World Meeting", une semaine de travail avec l&#8217;ensemble de l&#8217;équipe.
Nous n&#8217;avions donc pas eu le temps de faire différents devis, notamment de chauffage alternatif.
Mais en Mars dernier, patatras, nouvelle panne.
Cette fois-ci, la chaudière elle-même n&#8217;était pas en cause: c&#8217;est le système d&#8217;alimentation en fioul, entre la cuve et la chaudière, qui était encrassé.
La chaudière se mettait constamment en défaut faute d&#8217;avoir une arrivée de fioul propre.
Nous avions alors le choix entre faire nettoyer la cuve et la tuyauterie, pour une facture de l&#8217;ordre de 2k€, ou de changer.</p>
</div>
<div class="paragraph">
<p>En même temps, mon épouse et moi-même sommes tous les 2 en télétravail 5j/5.
Notre consommation électrique est donc importante, entre l&#8217;alimentation des ordinateurs, des écrans, la cuisine le midi, le chauffage d&#8217;appoint dans mon bureau, &#8230;&#8203;
Certains de nos équipements consomment aussi régulièrement: n&#8217;ayant pas le tout à l’égout, par exemple, nous avons une microstation de traitement des eaux usées, avec une pompe de recirculation et une pompe de relevage, qui ont des consommations non négligeables à l&#8217;année.
Nous possédons aussi une voiture électrique (une e-208) qui est chargée à domicile.
Enfin, l&#8217;été, nous avons une pompe de circulation pour la piscine qui consomme beaucoup.
Au final, notre facture électrique est donc beaucoup plus importante que celle de fioul.</p>
</div>
<div class="paragraph">
<p>Cette dernière panne a donc été l&#8217;occasion de revoir notre projet.
Après divers devis, nous avons opté pour l&#8217;installation de 16 panneaux solaires de la société française <a href="https://dualsun.com/">DualSun</a> : 10 panneaux classiques "Flash" et 6 panneaux hybrides électricité/eau chaude, pour une production totale de 6kWC (6 kW crète).
Les panneaux hybrides permettent de produire de l&#8217;électricité <strong>et</strong> de préchauffer l&#8217;eau chaude.
Le tout a été associé à une pompe à chaleur air-eau, une Alfea Extensa A.I de la marque française <a href="https://www.atlantic.fr/Chauffer-le-logement/Pompe-a-chaleur/Aerothermie/Aerothermie-Air-Eau/Alfea-Extensa-A.I.-et-Alfea-Extensa-Duo-A.I">Atlantic</a>.
Il s&#8217;agit d&#8217;une pompe à chaleur air-eau moyenne température (55⁰C) qui nous permet de conserver notre installation de chauffages en fonte, au prix (à déterminer) d&#8217;une consommation supérieure lors des grands froids (ce qui n&#8217;arrive pas souvent ici).
La pompe est associée à un ballon d&#8217;eau chaude qui exploite le circuit préchauffé par les panneaux.</p>
</div>
<div class="paragraph">
<p>Les 6kWc nous permettent d&#8217;être en auto-consommation totale en journée l&#8217;été (et probablement une partie du printemps/automne, à confirmer avec le temps) et je devrais pouvoir revendre une partie de la surproduction à Enedis (mais pour des raisons administratives, mon dossier est toujours en attente&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Mon calcul de retour sur investissement m&#8217;a donné 12 ans, en prenant en compte une augmentation annuelle de 5% des prix de l&#8217;électricité.
Si les tarifs augmentent plus vite, alors ça sera rentabilisé plus vite, mais il est impossible de savoir si ça sera le cas&#8230;&#8203; a priori avec la crise énergétique, j&#8217;ai tendance à croire que ça n&#8217;est pas un mauvais calcul&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Enfin, nous n&#8217;avons <strong>pas</strong> fait installer de batteries: bien que cela serait extrêmement intéressant dans mon cas, pour récupérer la nuit le surplus de la production en journée, le prix des batteries est encore bien trop élevé (de l&#8217;ordre de 7k€ pour 10kW).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changer_ses_habitudes_de_consommation">Changer ses habitudes de consommation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans mon cas, nos habitudes de consommation étaient assez simples, au final:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>en journée, nous n&#8217;avions pas trop le choix: il faut bien alimenter les ordinateurs, etc.</p>
</li>
<li>
<p>les machines à laver, lave-vaisselle, etc tournaient la nuit pour profiter des heures creuses</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Malheureusement, notre consommation en heures creuses était assez limitée comparée au reste.
Tout à changé avec les panneaux solaires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cet été et même fin septembre, lorsque le ciel est dégagé, mes panneaux produisent jusqu&#8217;à 5.5kW, ce qui dépasse largement ma consommation "live"</p>
</li>
<li>
<p>nous chargeons la voiture en journée via la prise "domestique" (~2kW) lorsque c&#8217;est possible, et la nuit en charge "rapide" (6kW) lorsque la batterie est trop basse</p>
</li>
<li>
<p>les machines tournent en journée au lieu de la nuit</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Mais optimiser tout cela est <strong>compliqué</strong>, et je souhaitais un système qui permette à mon épouse et mes enfants de savoir si, par exemple, "c&#8217;est le moment" de lancer une machine.</p>
</div>
<div class="paragraph">
<p>Je me suis donc lancé dans un projet de "bidouille" pour faire un système de monitoring qui donnerait en direct ma production, ma consommation, et indiquerait de manière simple si on a de la marge ou pas.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_petite_complication">Petite complication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Évidemment, vous pourriez vous dire que ça devrait être simple, avec toutes les applications connectées qui existent.
Oui et non.
Chez moi, l&#8217;installation est particulière: mes panneaux solaires sont sur le toit de ma maison, ainsi que les onduleurs et optimiseur.
Ces appareils sont capables de vous donner en direct la production, et mesurent aussi la consommation instantanée, ce qui permet donc de mesurer directement son auto-consommation: on peut savoir si on produit plus qu&#8217;on ne consomme, ou l&#8217;inverse, en temps réel, c&#8217;est parfait non ? Voici par exemple un graphique fournit par SolarEdge en été:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/elec/conso-aout.png" alt="conso aout">
</div>
</div>
<div class="paragraph">
<p>En rouge, nous avons la consommation.
En vert, la production solaire, et en bleu, l&#8217;autoconsommation.
Vous noterez d&#8217;ores et déja un problème, si, comme moi, vous êtes un tant soit peu curieux: lorsqu&#8217;il y a production solaire, la <em>courbe de consommation</em> se met à suivre celle de production.
Elle monte lorsque la production augmente et diminue lorsqu&#8217;elle baisse: ça n&#8217;est pas logique et probablement un bug quelque par chez SolarEdge.
J&#8217;ai demandé via mon installateur des explications (ils ne comprennent pas non plus), mais SolarEdge n&#8217;est pas revenu vers eux.</p>
</div>
<div class="paragraph">
<p>A titre de comparaison, voici un autre graphe ce mois-ci:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/elec/conso-nov.png" alt="conso nov">
</div>
</div>
<div class="paragraph">
<p>On note déja qu&#8217;il y a des pics de consommation, correspondant à l&#8217;enclenchement de la pompe à chaleur, ou des appareils de cuisson.
On constate aussi que la période de production est plus resserrée, mais qu&#8217;il existe encore, en journée, de la surproduction par moment (ça n&#8217;est pas toujours vrai, dès qu&#8217;il pleut, la production est pour ainsi dire nulle).</p>
</div>
<div class="paragraph">
<p>Si on oublie la fausse valeur de consommation, c&#8217;est parfait me direz-vous !
Et bien oui mais non.
Chez moi, il y a un hic: le capteur de consommation est au niveau de l&#8217;onduleur, près de mon tableau électrique.
Or ici, j&#8217;ai <em>plusieurs</em> tableaux électriques: un dans mon habitation principale, mais aussi un dans mon garage (bâtiment indépendant) et un autre dans un local technique du jardin.
Lorsque j&#8217;ai acheté cette maison, elle était installée en triphasé, il y avait donc les 3 phases, et de mon compteur EDF principal, dans mon allée, partent des lignes électriques vers 3 bâtiments distincts.
Ces phases étaient particulièrement déséquilibrées, nous avions donc fait repasser en monophasé, mais ce qu&#8217;il faut retenir, c&#8217;est qu&#8217;il aurait fallu que le capteur soit au niveau du compteur électrique, et non dans ma maison, pour qu’on puisse mesurer correctement la consommation en live.
Pour des raisons techniques, il n&#8217;était pas possible de le faire: j&#8217;ai donc une mesure imparfaite de ma consommation, qui ne donne que la consommation de mon habitation principale.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ma_solution">Ma solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si on résume, je dispose pour l&#8217;instant d&#8217;un outil qui me donne la production (nous verrons plus loin comment l&#8217;obtenir), mais pas la consommation.
Mais mon fournisseur d&#8217;électricité (Total Energies) propose une clé ATOME qui permet de connaître ce que je consomme du réseau en live, clé qui se branche sur le compteur Linky.
Malheureusement, Enedis ne propose pas d&#8217;APIs permettant de connaître sa consommation live, il n&#8217;y a donc pas d&#8217;autre choix que de louer la clé de Total Energies&#8230;&#8203;
J&#8217;ai donc fait l&#8217;acquisition de cette clé, et je dispose donc des 2 mesures dont j&#8217;ai besoin:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la consommation live donnée par ma clé ATOME: attention, il ne s&#8217;agit donc pas de ma consommation totale, mais de ce que j&#8217;ai besoin <em>en plus de ma production</em>, du réseau EDF</p>
</li>
<li>
<p>la production live donnée par SolarEdge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il suffit donc de faire la différence entre les 2 pour savoir de quelle marge on dispose, mais je ne peux jamais, en pratique, savoir combien je consomme.</p>
</div>
<div class="paragraph">
<p>Mon idée a donc été d&#8217;utiliser un vieux Rapsberry PI qui traînait dans mon armoire, combiné à un écran e-ink, pour afficher cette production et cette consommation, ainsi qu&#8217;une "note" permettant de suggérer de lancer une machine à laver, par exemple.</p>
</div>
<div class="paragraph">
<p>J&#8217;ai donc fait l&#8217;acquisition de <a href="https://www.amazon.fr/gp/product/B075FRVC4L/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1">cet écran</a>, un écran e-ink dont la consommation en veille est nulle, ce qui, pour un outil de monitoring de consommation d&#8217;énergie, me semblait le minimum.
Nous verrons cependant que ça ne fut pas sans inconvénients.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_les_apis_toujours_le_point_faible">Les APIs, toujours le point faible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bien, maintenant que nous savons que les données sont disponibles, via le <a href="https://monitoring.solaredge.com">site de SolarEdge</a> pour la production, et via l&#8217;application Total Energies pour la clé live, il fallait disposer de ces données via des API que je puisse interroger via mon Raspberry.</p>
</div>
<div class="paragraph">
<p>Là, douche froide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SolarEdge propose bien une API pour développeurs, mais elle n&#8217;est ni super bien documentée (il faut comprendre soit-même à quoi correspondent les champs retournés), ni illimitée : on ne peut effectuer que 300 requêtes par jour, soit un peu moins d&#8217;une requête toutes les 5 minutes ! C&#8217;est d&#8217;autant plus regrettable que l&#8217;information est disponible <em>en continu</em> et en live via leur interface web!</p>
</li>
<li>
<p>pour Total Energies, c&#8217;est encore pire: il n&#8217;y a pas d&#8217;API officielle. Il faut donc "hacker" pour avoir accès, en simulant une connexion via l&#8217;application, qui donne la consommation live</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bref, ni SolarEdge, ni Total ne proposent d&#8217;API de type push, ou d&#8217;event bus qu&#8217;on puisse écouter pour obtenir les informations.
C&#8217;est très décevant, à une heure où ce genre d&#8217;optimisations devient critique pour une bonne gestion de notre consommation électrique: c&#8217;est un outil pour le climat !</p>
</div>
<div class="paragraph">
<p>L&#8217;autre problème, c&#8217;est que même si j&#8217;utilise l&#8217;API officielle de SolarEdge et que je réussis à récupérer l&#8217;information de Total Energies, ces APIs sont instables : elles tombent très souvent "en panne" et ne renvoient aucune info.
Bref, lorsque ça marche, c&#8217;est parfait, mais souvent, ça ne fonctionne tout simplement pas, par exemple en ce moment, ma production indique 0 alors que ça n&#8217;est pas le cas:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/elec/moniteur-nov.jpg" alt="moniteur nov">
</div>
</div>
<div class="paragraph">
<p>Ceci me permet au moins de savoir qu&#8217;en ce moment, je demande 1135W du réseau, ce qui signifie que je consomme sensiblement plus (entre le chauffe-eau, l&#8217;ordinateur de mon fils qui joue à Minecraft et la PS5 de mon autre garçon).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_un_peu_de_technique">Un peu de technique</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Alors comment récupérer en pratique ces informations ?
En fait j&#8217;ai adapté un script en Python qui, toutes les 5 minutes, se connecte à ces 2 APIs, récupère les informations et déclenche le rafraîchissement de l&#8217;écran.
Alors, Python, personnellement c&#8217;est pas ma tasse de thé.
J&#8217;ai l&#8217;impression de refaire du PHP, avec des scripts cracras et des variables globales de partout.
Il y a sûrement possibilité de faire mieux, mais en bidouille en se connectant par SSH à mon Raspberry, c&#8217;est pour l&#8217;instant tout ce que j&#8217;ai.</p>
</div>
<div class="paragraph">
<p>Vous trouverez donc le script <a href="https://gist.github.com/melix/90dce1c44524a368f9186981ec16b475">ici</a>.</p>
</div>
<div class="paragraph">
<p>Parmi les problèmes, je vous mentionnait celui du choix de l&#8217;écran.
J&#8217;avoue avoir été relativement naïf, parce qu&#8217;à l’utilisation, si l&#8217;écran e-ink est très sympa à voir, son rafraîchissement prend&#8230;&#8203; jusqu&#8217;à 30s !
En effet, la façon de dessiner sur ces écrans est assez particulière: on écrit des modèles mémoire, puis on envoie des instructions à l&#8217;écran pour effacer telle zone, etc.
Ces instructions sont très lentes à s&#8217;exécuter, mais surtout, elles provoquent systématiquement un effet bizarre à l&#8217;écran, qui passe du blanc au noir plusieurs fois, commence à afficher des choses, puis la couleur, etc&#8230;&#8203;
Bref, pas super sympa pour du "live", mais, au final, suffisant pour mon usage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Au final, j&#8217;ai quand même un outil proche de ce que je souhaitais.
Il nous a permis, d&#8217;ores et déjà, d&#8217;adapter notre consommation: n&#8217;importe qui peut regarder l&#8217;écran et décider de lancer une machine si la production est importante, alors que cette info n&#8217;était avant uniquement disponible que pour moi, via une application sur mobile: ici, l&#8217;information est donnée en continu, de manière passive, via cet écran.</p>
</div>
<div class="paragraph">
<p>Nous avons, par exemple, pu adapter notre consommation en automne: la pompe à chaleur ne fonctionnait pas (pas besoin de chauffer) et donc nous avons pu mettre notre voiture à charger, plus travailler tous les 2 à domicile et lancer une machine à laver, sans consommer un seul kW du réseau EDF ! Lorsque le monitoring a indiqué que nous commencions à consommer du réseau, il a suffit de couper la charge de la voiture (malheureusement, l&#8217;application MyPeugeot est extrêmement limitée et ne permet pas d&#8217;interrompre une charge mais simplement de la différer, mais c&#8217;est un autre problème).</p>
</div>
<div class="paragraph">
<p>Depuis Juillet, nous sommes à -70% de consommation électrique, ce qui est énorme.
Cependant, les conditions météo ont, jusqu&#8217;ici, été très favorables: beaucoup de soleil et des températures record en Octobre et Novembre (malheureusement pour le climat&#8230;&#8203;).
Depuis une semaine, la pompe à chaleur se met régulièrement en route pour tenir les 19⁰C, mais j&#8217;ai des résultats surprenants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>90kWh consommés en Novembre pour chauffer l&#8217;eau</p>
</li>
<li>
<p>et seulement 9kWh pour le chauffage !</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;avenir nous dira si le passage à une pompe à chaleur pour le chauffage était une bonne idée ou non (en même temps, ici nous n&#8217;avions pas trop le choix).
Il serait pertinent, compte tenu du surplus de production qui arrive souvent en journée, d&#8217;installer des batteries pour maximiser l&#8217;autoconsommation.
Malheureusement comme je l&#8217;ai indiqué, le prix est à ce jour bien trop élevé.
Je devrais donc me contenter de revendre ma production (au prix de 10cts le kWh, prix fixé pour 20 ans (!!) contre environ 15cts lorsque je consomme).
Attention cependant, lorsqu&#8217;on revend et que notre installation, comme la nôtre, dépasse les 3kWc, alors nous devons déclarer celà en revenus.
Cela rend la revente bien moins intéressante, puisque malgré le fait qu&#8217;on va "consommer" notre surplus, mais à des heures différentes, le tarif de rachat ansi que le fait de devoir déclarer réduit sensiblement la rentabilité.</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2022/11/monitoring-elec.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2022/11/hello-mastodon.html"><h1>Hello, Mastodon (goodbye Twitter!)</h1></a>
  			<p>06 November 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/twitter.html">twitter</a> 
	
		<a href="/blog/tags/mastodon.html">mastodon</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>It should be no news to anyone that <a href="https://www.bbc.com/news/technology-63402338">Elon Musk finally took control of Twitter</a>.
There were reasons to be worried about this move, but the <a href="https://www.reuters.com/technology/twitter-start-layoffs-friday-morning-internal-email-2022-11-04/">recent events at Twitter made it worse than most of us would have thought</a>.</p>
</div>
<div class="paragraph">
<p>TL/DR: I am moving primarily to Mastodon. You can now follow me at <a href="https://mastodon.xyz/@melix">@melix@mastodon.xyz</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_twitter_as_a_self_promotion_tool">Twitter as a self-promotion tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lots of people have a complicated story with Twitter, I am no different.
I joined Twitter back in January 2010, and I&#8217;ve grown up to more 4800 followers nowadays, and from time to time, I suffered from being exhausted by the negativity of the network.
Last year, I was even in the middle of an harassment story, because some trolls thought I was someone else.</p>
</div>
<div class="paragraph">
<p>However, Twitter has been my main communication channel for professional work: this is where I explain what I work on, announce software updates, events I will attend or talk to, or publish blog posts links like this one.
This is also my main feedback channel and where I do most of my technology intelligence.</p>
</div>
<div class="paragraph">
<p>My community of followers doesn&#8217;t make me an "influencer" at large scale, like a rock star, but it definitely had an influence on my professional career.
For example, different potential employers explicitly mentioned my "influence" and social media presence, for example, as a major reason why they&#8217;d like to work with me.
I have no doubt that without Twitter, my career wouldn&#8217;t have been the one it is today.
For that, I am forever grateful.</p>
</div>
<div class="paragraph">
<p>I am also using my Twitter account for personal stuff.
Most notably, some of you have seen my astronomy pictures.
You may also have seen some political posts and point of views being expressed.
While I&#8217;m using Twitter professionally, I always made it clear that the opinions I&#8217;m expressing are not representative of my employer&#8217;s point of view.
Said differently, I see my Twitter account as a <em>tool</em>, but a tool which "survives" my different employers.
To some extent, it&#8217;s part of my digital identity.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_then_came_elon_musk">Then came Elon Musk</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I was already very critical of Elon Musk, and not just because of the infamous Starlink project, for which I have so much to say.
One can admire what he created with Tesla or SpaceX (and I do admire), but at the same time, we can recognize that he&#8217;s a terrible human being.
This is all about business, all about money, and “freedom of speech” only when it suits his point of view.
Elon is making people work as hard as they can until they burnout or simply get fired once they have "done their job".
Elon is also a "special" view of free speech, where those who pay will have right for free speech, while those who don&#8217;t won&#8217;t be visible anymore.
He&#8217;s also the one blocking anyone criticizing him.</p>
</div>
<div class="paragraph">
<p>As a consequence, the head of Twitter, and therefore Twitter itself, now represents everything I fight against in my personal life.
This is the world I don&#8217;t want for my children.
This is the world which puts money before human beings, the world where power, masculinity, is emphasized.
Elon doesn&#8217;t care that we exhaust resources, as long as part of the population can survive, be it on Mars (!).</p>
</div>
<div class="paragraph">
<p>But now, he fired half of the company, by email, <a href="https://techcrunch.com/2022/11/04/twitter-faces-a-class-action-lawsuit-over-mass-employee-layoffs-with-proper-legal-notice/">ignoring the law</a>, because, you know, Musk does whatever he wants.
It happens that I know people who got fired and I also know folks who used to work for Twitter before.
I, for one, am respectful of what people produce.
I am respectful of what efforts it takes to build a site like Twitter, and, in general, I am someone who puts <em>trust</em> in other people at the top of my hierarchy of beliefs.
So I find it extremely annoying, or, to be clear, disgusting when someone who has absolutely no understanding of how to build such a large community over the years, decides to layoff half of a company, change the spirit of the website so that paying customers have more power than the others, so that it matches more his political point of view.
Even if the company is losing $4M a day, compared to B44$, seriously, what would have it taken to show the people who built Twitter a bit of respect and simply build a plan, say, of volunteer departures.</p>
</div>
<div class="paragraph">
<p>Elon Musk&#8217;s behavior is everything I hate: someone coming because they have power (understand, money), and then ruining other people lives just because he can, without any respect.</p>
</div>
<div class="paragraph">
<p>This puts me in a difficult situation: at the same time, I <em>need</em> Twitter, because it&#8217;s a professional tool which can&#8217;t be easily replaced and I <em>have to go</em> because there&#8217;s no way I&#8217;m going to pay 8 dollars a month to a company who treats human beings like that, and simply to get more visibility over others just because I can afford it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hello_mastodon">Hello, Mastodon!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a FOSS supporter, back in 2017, I had registered to <a href="https://joinmastodon.org">Mastodon</a>.
My account was left more or less inactive for years, because, honestly, not many people used it so it was &#8230;&#8203; annoying.
This was like talking in an echo chamber.
Until the rumor of Elon Musk acquiring Twitter started: we&#8217;ve seen more and more people joining, and I&#8217;m super glad that this week alone, <em>many</em> other people, including from the Tech industry, decided to make the move.</p>
</div>
<div class="paragraph">
<p>No more ads. No more recommendations. A clean timeline, as it should be.</p>
</div>
<div class="paragraph">
<p>It&#8217;s really refreshing to be on Mastodon, it feels like the Twitter from the early days.</p>
</div>
<div class="paragraph">
<p>However, Mastodon has a number of key differences, which make it more "complicated" for users to understand.
First of all, and that&#8217;s the biggest issue for joining, Mastodon is <em>not</em> a single site like Twitter: it&#8217;s a <em>federation</em> of servers.
Just like you have a provider for your email (say GMail, Hotmail, etc.), you can choose your Mastodon server provider.
As an OSS project, you can go even as far as hosting your own instance.</p>
</div>
<div class="paragraph">
<p>Therefore, Mastodon is, by nature, distributed, which makes it completely immune to what just happened to Twitter.
But it also means that there are a few things you should be aware when you join a server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>content moderation is the responsibility of the server administrator: they can block you, read your posts, private messages. They can block other providers too, which means, for example, that if you choose to go to an instance which has a Code of Conduct, you have to follow the rules.</p>
</li>
<li>
<p>the good news is that you <em>own the content</em>: if you are not happy with your server moderation rules, you can <em>move to a different instance</em>, and you can move your data with it: toots, folks you follow, followers, &#8230;&#8203;</p>
</li>
<li>
<p>the cost of maintenance is distributed on the community: there are lots of <em>free</em> servers out there, but you can choose to participate to the bills. You can even build your own server, for a price which wouldn&#8217;t exceed much what Elon wants us to pay to get a blue mark</p>
</li>
<li>
<p>Hashtags are much more important in Mastodon than Twitter: there&#8217;s no <em>global search</em>: the only things which are indexed are hash tags. You won&#8217;t find contents which is not with a hash tag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the internet I remember of.
It&#8217;s not suitable for everyone, but it&#8217;s what I call <em>open</em>.
What I also like is that it respects freedom of speech, while preserving your freedom of not seeing assholes (there are instances which are full of alt-right folks, but at least, we can block the whole server and not have to suffer their nauseating posts).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, for the time being, I&#8217;m transitioning to Mastodon.
<strong>You can follow me at <a href="https://mastodon.xyz/@melix">@melix@mastodon.xyz</a></strong>, and I strongly suggest that you do the same and find a server which suits you.
I will <em>not</em> support a company which now represents the worst of human beings.
I will <em>not</em> pay $8 a month to a company which shows no respect to its employees, content creators and business partners.</p>
</div>
<div class="paragraph">
<p>Because it&#8217;s hard to say goodbye to a professional network just like that, I do not plan to shutdown my account on Twitter yet, though: I still didn&#8217;t find a way to solve this cognitive dissonance.</p>
</div>
<div class="paragraph">
<p>So what I plan on doing is moving to Mastodon first.
I have already updated my screen name in Twitter to give a link to my Mastodon account.
I suggest you do the same.
I will now limit my tweets to what is strictly required for my professional career (announcements, etc.).
I will also mostly answer to tweets which are related to moving to Mastodon and use Mastodon for everything else, until I can completely get rid of Twitter.
I am conscious that I may not be able to completely get rid of it, if too many people stay on Twitter.
So be it.</p>
</div>
<div class="paragraph">
<p>Congratulations M. Musk, you ruined Twitter!</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2022/11/hello-mastodon.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2022/10/astro-twitch.html"><h1>Astrophotographie: la suite !</h1></a>
  			<p>05 October 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/astrophotographie.html">astrophotographie</a> 
	
		<a href="/blog/tags/twitch.html">twitch</a> 
	</p>
			
  			<p><div class="paragraph">
<p>Salut à tous !</p>
</div>
<div class="paragraph">
<p>Je vous avais promis de faire un deuxième live sur Twitch pour parler d&#8217;astrophotographie, cette fois-ci sur la partie logicielle.
J&#8217;ai décidé d&#8217;arrêter de procrastiner et je vous annonce le <strong>mercredi 12 octobre à 20h</strong> sur <a href="https://www.twitch.tv/melix_fr">ma chaîne Twitch</a>.</p>
</div>
<div class="paragraph">
<p>Si vous avez raté la première partie sur le matériel astrophoto, c&#8217;est dispo en replay sur <a href="https://www.youtube.com/watch?v=Hudtta97gDU">Youtube</a>.</p>
</div>
<div class="paragraph">
<p>Dans ce live j&#8217;aborderais comment, à partir des données brutes acquises pendant la nuit, on peut obtenir de belles photos grâce à la magie du logiciel.
Nous parlerons de flats, darks, pré-traitement, stacking, &#8230;&#8203; plein de termes compliqués mais qui au final ne sont pas si difficiles à comprendre.</p>
</div>
<div class="paragraph">
<p>Bref, il est temps que je prépare tout ça !</p>
</div></p>
			<p><a href="/blog/2022/10/astro-twitch.html#disqus_thread">Comments</a></p>
  			<a href="/blog/2022/08/micronaut-test-resources.html"><h1>Introducing Micronaut Test Resources</h1></a>
  			<p>04 August 2022</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/micronaut.html">micronaut</a> 
	
		<a href="/blog/tags/testcontainers.html">testcontainers</a> 
	
		<a href="/blog/tags/docker.html">docker</a> 
	
		<a href="/blog/tags/test.html">test</a> 
	
		<a href="/blog/tags/testing.html">testing</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The new <a href="https://micronaut.io/2022/08/04/micronaut-framework-3-6-0-released">release of Micronaut 3.6</a> introduces a new feature which I worked on for the past couple of months, called <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a>.
This feature, which is inspired from <a href="https://quarkus.io/guides/dev-services">Quarkus' Dev Services</a>, will greatly simplify testing of Micronaut applications, both on the JVM and using GraalVM native images.
Let&#8217;s see how.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_resources_in_a_nutshell">Test resources in a nutshell</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> simplifies testing of applications which depend on external resources, by handling the provisioning and lifecycle of such resources automatically.
For example, if your application requires a MySQL server, in order to test the application, you need a MySQL database to be installed and configured, which includes a database name, a username and a password.
In general, those are only relevant for production, where they are fixed.
During development, all you care about is having <em>one</em> database available.</p>
</div>
<div class="paragraph">
<p>Here are a couple of traditional solutions to this problem:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>document that a MySQL server is a pre-requisite, and give instructions about the database to create, credentials, etc. This can be simplified by using Docker containers, but there&#8217;s still manual setup involved.</p>
</li>
<li>
<p>Use a library like <a href="https://www.testcontainers.org/">Testcontainers</a> in order to simplify the setup</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In general, using <a href="https://www.testcontainers.org/">Testcontainers</a> is preferred, because it integrates well with the JVM and provides an API which can be used in tests to spawn containers and interact with them.
However, a better integration between Micronaut and <a href="https://www.testcontainers.org/">Testcontainers</a> can improve the developer experience in several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>simplify the container lifecycle configuration by providing an opinionated framework-specific default way, making you think less of how to setup it in the individual tests : tests shouldn&#8217;t need to deal with the container lifecycle: we&#8217;d like to have test containers/resources management as <em>transparent</em> as possible.</p>
</li>
<li>
<p>isolate it better from your application making it simpler to reason about dependencies (and transitive dependencies), not just for the developer, but for example tools enabling native mode as well: Testcontainers APIs "leak" to the test classpath, making it difficult to <a href="https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html#testing-support">run tests in native mode</a>. This is not a problem specific to the Testcontainers library though: many libraries are not yet compatible with GraalVM. Our solution makes it possible to use Testcontainers in native tests without the hassle of configuring it!</p>
</li>
<li>
<p>enable support for "development mode", that is to say when you run the application locally (not the tests, the application itself) or even several distinct projects at once that can benefit from sharing access to the same running containers (for example, an MQTT client and a server may want to use the same container, even if they are individual projects living in distinct Git repositories).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The goal of <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> is to achieve all of these at once:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>zero-configuration</strong>: without adding any configuration, test resources should be spawned and the application configured to use them. Configuration is only required for advanced use cases.</p>
</li>
<li>
<p><strong>classpath isolation</strong>: use of test resources shouldn&#8217;t leak into your application classpath, nor your test classpath</p>
</li>
<li>
<p><strong>compatible with GraalVM native</strong>: if you build a native binary, or run tests in native mode, test resources should be available</p>
</li>
<li>
<p><strong>easy to use</strong>: the Micronaut build plugins for Gradle and Maven should handle the complexity of figuring out the dependencies for you</p>
</li>
<li>
<p><strong>extensible</strong>: you can implement your own test resources, in case the built-in ones do not cover your use case</p>
</li>
<li>
<p><strong>technology agnostic</strong>: while lots of test resources use <a href="https://www.testcontainers.org/">Testcontainers</a> under the hood, you can use any other technology to create resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> support advanced development patterns, which are useful in the microservices era.
As an example, it is capable of sharing containers between submodules of a single build, or even between independent projects, from different Git repositories!
Say that you have 2 projects, one built with Gradle, the other with Maven, both needing to communicate using the same message bus: Micronaut is capable of handling this use case for you, making it extremely easy to test components interacting with each other!</p>
</div>
<div class="paragraph">
<p>Because of these constraints, we decided to use <a href="https://www.testcontainers.org/">Testcontainers</a>, because the library is just perfect for the job, but in an <em>isolated</em> process instead, as I&#8217;m going to describe below.
Note that this solution is also 100% compatible with <a href="https://www.testcontainers.cloud/">Testcontainers Cloud</a>, which makes container provisioning even easier!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_micronaut_test_resources">Using Micronaut Test Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_enabling_test_resources_support">Enabling test resources support</h3>
<div class="paragraph">
<p><a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> integrates with build tools.
In both Maven and Gradle, you need to enable test resources support.
If you create a new project using <a href="https://micronaut.io/launch">Micronaut Launch</a> or the Micronaut CLI, test resources will be configured for you, but if you migrate an existing application to test resources, here&#8217;s what you need to do:</p>
</div>
<div class="paragraph">
<p>If you are using Maven, you will need to upgrade to the Micronaut 3.6 parent POM and add the following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">&lt;properties&gt;
   &lt;micronaut.test.resources.enabled&gt;true&lt;/micronaut.test.resources.enabled&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Gradle, you can use test resources with Micronaut 3.5+ and you simply need to use the test resources plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">plugins {
    id 'io.micronaut.application' version '3.5.1'
    id 'io.micronaut.test-resources' version '3.5.1'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_our_first_test_resources_contact">Our first test resources contact</h3>
<div class="paragraph">
<p>In this blog post we will write an application which makes use of Micronaut Data and connects to a MySQL server to list books.
The whole application code is <a href="https://github.com/melix/micronaut-test-resources-demo/">available on GitHub</a>, so I&#8217;m only going to show the relevant parts for clarity.</p>
</div>
<div class="paragraph">
<p>In such an application, we typically need a repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@JdbcRepository(dialect = Dialect.MYSQL)
public interface BookRepository extends CrudRepository&lt;Book, Long&gt; {
    @Override
    List&lt;Book&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this repository makes use of the <code>Book</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@MappedEntity
public class Book {
    @Id
    @GeneratedValue(GeneratedValue.Type.AUTO)
    private Long id;

    private String title;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order for Micronaut to use the database, we need to add some configuration to our <code>application.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml">datasources:
  default:
    schema-generate: CREATE
    db-type: mysql</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most important thing to see is that <strong>we don&#8217;t</strong> specify any username, password or URL to connect to our database: the only thing we have to specify is the database type of our datasource.
We can then write the following test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@MicronautTest
class DemoTest {

    @Inject
    BookRepository bookRepository;

    @Test
    @DisplayName("A MySQL test container is required to run this test")
    void testItWorks() {
        Book book = new Book();
        book.setTitle("Yet Another Book " + UUID.randomUUID());
        Book saved = bookRepository.save(book);
        assertNotNull(saved.getId());
        List&lt;Book&gt; books = bookRepository.findAll();
        assertEquals(1, books.size());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test creates a new book, stores it in the database, then checks that we get the expected number of books when reading the repository.
Note, again, that we didn&#8217;t have to specify any container whatsoever.
In this blog post I&#8217;m using Gradle, so we can verify the behavior by running:</p>
</div>
<div class="paragraph">
<p><code>./gradlew test</code></p>
</div>
<div class="paragraph">
<p>Then you will see the following output (cleaned up for clarity of this blog post):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>i.m.testresources.server.Application - A Micronaut Test Resources server is listening on port 46739, started in 128ms
i.m.t.e.TestResourcesResolverLoader - Loaded 2 test resources resolvers: io.micronaut.testresources.mysql.MySQLTestResourceProvider, io.micronaut.testresources.testcontainers.GenericTestContainerProvidereted
o.testcontainers.DockerClientFactory - Connected to docker:
  Server Version: 20.10.17
  API Version: 1.41
  Operating System: Linux Mint 20.3
  Total Memory: 31308 MB
🐳 [testcontainers/ryuk:0.3.3] - Creating container for image: testcontainers/ryuk:0.3.3
🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 is starting: 1f5286fa728aca74a7d6d4c0eb2148a3bc81f5c028027496d7aabda7b7ed45e8
🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 started in PT0.655476S
o.t.utility.RyukResourceReaper - Ryuk started - will monitor and terminate Testcontainers containers on JVM exit
🐳 [mysql:latest] - Creating container for image: mysql:latest
🐳 [mysql:latest] - Container mysql:latest is starting: d796c7a1ce10f393a4181f12967ee77ac9864f45595f97967c700f022e86ac7d
🐳 [mysql:latest] - Waiting for database connection to become available at jdbc:mysql://localhost:49209/test using query 'SELECT 1'
🐳 [mysql:latest] - Container is started (JDBC URL: jdbc:mysql://localhost:49209/test)
🐳 [mysql:latest] - Container mysql:latest started in PT7.573915S

BUILD SUCCESSFUL in 11s
7 actionable tasks: 2 executed, 5 up-to-date</code></pre>
</div>
</div>
<div class="paragraph">
<p>What does this tell us? First, that a "Micronaut Test Resources server" was spawned, for the lifetime of the build.
When the test was executed, this service was used to start a MySQL test container, which was then used during tests.
We didn&#8217;t have to configure anything, test resources did it for us!</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_application">Running the application</h3>
<div class="paragraph">
<p>What is also interesting is that this also works if you run the application in development mode.
Using Gradle, you do this by invoking <code>./gradlew run</code> (<code>mvn mn:run</code> with Maven): as soon as a bean requires access to the database, a container will be spawned, and automatically shut down when you stop the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Of course, in production, there won&#8217;t be any server automatically spawned for you: Micronaut will rely on whatever you have configured, for example in an <code>application-prod.yml</code> file. In particular, the URL and credentials to use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What is even nicer is that you can use this in combination with Gradle&#8217;s continuous mode!</p>
</div>
<div class="paragraph">
<p>To illustrate this, let&#8217;s create a controller for our books:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@Controller("/")
public class BookController {
    private final BookRepository bookRepository;

    public BookController(BookRepository bookRepository) {
        this.bookRepository = bookRepository;
    }

    @Get("/books")
    public List&lt;Book&gt; list() {
        return bookRepository.findAll();
    }

    @Get("/books/{id}")
    public Book get(Long id) {
        return bookRepository.findById(id).orElse(null);
    }

    @Delete("/books/{id}")
    public void delete(Long id) {
        bookRepository.deleteById(id);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start the application in <em>continuous mode</em>: <code>./gradlew -t run</code></p>
</div>
<div class="paragraph">
<p>You will see that the application starts a container as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 9166ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how it took about 10 seconds to start the application, most it it spent in starting the MySQL test container itself.
You definitely don&#8217;t want to pay this price for every change you make, so this is where the continuous mode is helpful.
If we ask for the list of books, we&#8217;ll get an empty list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 2
date: Tue, 26 Jul 2022 16:59:51 GMT

[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is expected, but notice how we didn&#8217;t have a method to actually add a book to our store.
Let&#8217;s fix this by editing the <code>BookController.java</code> class <em>without stopping the server</em>.
Add the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    @Get("/books/add/{title}")
    public Book add(String title) {
        Book book = new Book();
        book.setTitle(title);
        return bookRepository.save(book);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and notice how Gradle instantly reloads the application, but doesn&#8217;t restart the database: it&#8217;s already there so it&#8217;s going to reuse it!</p>
</div>
<div class="paragraph">
<p>In the logs you will see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 1086ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the application started in just a second! Let&#8217;s add a book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books/add/Micronaut%20in%20action
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 38
date: Tue, 26 Jul 2022 17:03:57 GMT

{
    "id": 1,
    "title": "Micronaut in action"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if we stop the application (by hitting CTRL+C) and start again, you will see that the database will be destroyed when the application shuts down.
Let&#8217;s see how we can "survive" different build invocations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_keeping_the_service_alive">Keeping the service alive</h3>
<div class="paragraph">
<p>By default, the test resources service is <em>short lived</em>: it&#8217;s going to be started at the beginning of a build, and shutdown at the end of a build.
This means, that it will live as long as you have tests running, or, if running in development mode, as long as the application is alive.
However, you can make it survive the build, and reuse the containers in several, independent build invocations.</p>
</div>
<div class="paragraph">
<p>To do this, you need to <em>explicitly start the test resources service</em>:</p>
</div>
<div class="paragraph">
<p><code>./gradlew startTestResourcesService</code></p>
</div>
<div class="paragraph">
<p>This starts the test resources service in the background: it did <em>not</em> start our application, nor did it run tests.
This means that now, we can start our application:</p>
</div>
<div class="paragraph">
<p><code>./gradlew run</code></p>
</div>
<div class="paragraph">
<p>And, because it&#8217;s the first time the application is launched since we started the test resources service, it&#8217;s going to spawn a test container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 9211ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add our book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books/add/Micronaut%20in%20action
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 38
date: Tue, 26 Jul 2022 17:03:57 GMT

{
    "id": 1,
    "title": "Micronaut in action"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference is now that if we stop the application (e.g hit CTRL+C) and start it again, it will <em>reuse the container</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>INFO  io.micronaut.runtime.Micronaut - Startup completed in 895ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we list our books, the database wasn&#8217;t cleaned, so we&#8217;ll get the book we created from the previous time we started the app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ http :8080/books
HTTP/1.1 200 OK
Content-Type: application/json
connection: keep-alive
content-length: 40
date: Tue, 26 Jul 2022 17:14:40 GMT

[
    {
        "id": 1,
        "title": "Micronaut in action"
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice, right?
However there&#8217;s a gotcha if you do this: what happens if we run tests?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ ./gradlew test

&gt; Task :compileTestJava
Note: Creating bean classes for 1 type elements

&gt; Task :test FAILED

DemoTest &gt; A MySQL test container is required to run this test FAILED
    org.opentest4j.AssertionFailedError at DemoTest.java:28</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why is that? This is simply because our tests expect a <em>clean</em> database, and we had a book in it, so keep this in mind if you&#8217;re using this mode.</p>
</div>
<div class="paragraph">
<p>At some point, you will want to close all open resources.
You can do this by explicitly stopping the test resources service:</p>
</div>
<div class="paragraph">
<p><code>./gradlew stopTestResourcesService</code></p>
</div>
<div class="paragraph">
<p>Now, you can run the tests again and see them pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">$ ./gradlew test

...
INFO  🐳 [testcontainers/ryuk:0.3.3] - Creating container for image: testcontainers/ryuk:0.3.3
INFO  🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 is starting: ea2aa1c7f1e66a9c7306b00443e8a6693451f3f02bd780b3e2ed7b96ed59936a
INFO  🐳 [testcontainers/ryuk:0.3.3] - Container testcontainers/ryuk:0.3.3 started in PT0.553559699S
INFO  o.t.utility.RyukResourceReaper - Ryuk started - will monitor and terminate Testcontainers containers on JVM exit
INFO  o.testcontainers.DockerClientFactory - Checking the system...
INFO  o.testcontainers.DockerClientFactory - ✔︎ Docker server version should be at least 1.6.0
INFO  🐳 [mysql:latest] - Creating container for image: mysql:latest
INFO  🐳 [mysql:latest] - Container mysql:latest is starting: 1c6437a55b8f9e5668bcec4aef27087c889b8a77ca18d2ddf58809853482a422
INFO  🐳 [mysql:latest] - Waiting for database connection to become available at jdbc:mysql://localhost:49227/test using query 'SELECT 1'
INFO  🐳 [mysql:latest] - Container is started (JDBC URL: jdbc:mysql://localhost:49227/test)
INFO  🐳 [mysql:latest] - Container mysql:latest started in PT7.469460173S

BUILD SUCCESSFUL in 11s
7 actionable tasks: 2 executed, 5 up-to-date</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_native_testing">Native testing</h3>
<div class="paragraph">
<p>Did you know that you can run your test suite in native mode?
That is to say, that the test suite is going to be compiled into a native binary which runs tests?
One issue with this approach is that it&#8217;s extremely complicated to make it work with Testcontainers, as it requires additional configuration.
With <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a>, there is no such problem: you can simply invoke <code>./gradlew nativeTest</code> and the tests will properly run.
This works because Testcontainers libraries do not leak into your test classpath: the process which is responsible for managing the lifecycle of test resources is isolated from your tests!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_under_the_hood">Under the hood</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_how_does_that_work">How does that work?</h3>
<div class="paragraph">
<p>In a nutshell, Micronaut is capable of reacting to the <em>absence</em> of a configured property.
For example, a datasource, in order to be created, would need the value of the <code>datasources.default.url</code> property to be set.
<a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> work by <em>injecting</em> those properties at runtime: when the property is read, it triggers the creation of test resources.
For example, we can start a MySQL server, then inject the value of the JDBC url to the <code>datasources.default.url</code> property.
This means that in order for test resources to work, you need to <em>remove</em> configuration (note that for production, you will need to provide an additional configuration file, for example <code>application-prod.yml</code>, which provides the actual values).</p>
</div>
<div class="paragraph">
<p>The entity which is responsible for resolving missing properties is the "Test Resources Server": it&#8217;s a long lived process which is independent from your application and it is responsible for managing the lifecycle of test resources.
Because it&#8217;s independent from the application, it means it can contain dependencies which are not required in your application such as, typically, the Testcontainers runtime.
But it may also contain additional classes, like JDBC drivers, or even your custom test resources resolver!</p>
</div>
<div class="paragraph">
<p>Because this test resources server is a separate process, it also means it can be shared by different applications, which is the reason why we can share the same containers between independent projects.</p>
</div>
<div class="paragraph">
<p>Once you understand that <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> work by resolving <em>missing</em> properties, it becomes straightforward to configure.
In particular, we offer configuration which makes it very easy to support scenarios which are not supported out of the box.
For example, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> supports several JDBC or reactive databases (MySQL, PostgreSQL, MariaDB, SQL Server and Oracle XE), Kafka, Neo4j, MQTT, RabbitMQ, Redis, Hashicorp Vault and ElasticSearch, but what if you need a different container?</p>
</div>
<div class="paragraph">
<p>In that case, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> offer a conventional way to create such containers, by simply adding some configuration lines: in the documentation <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/#modules-testcontainers">we demonstrate how to use the <code>fakesmtp</code> SMTP server with Micronaut Email</a> for example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_test_resources">Custom test resources</h3>
<div class="paragraph">
<p>If the configuration-based support isn&#8217;t sufficient, you also have, in addition, the ability to write your own test resources.
If you use Gradle, which I of course recommend, this is made extremely easy by the test resources plugin, which creates an additional source set for this, named <code>testResources</code>.
For Maven, you would have to create an independent project manually to support this scenario.</p>
</div>
<div class="paragraph">
<p>As an illustration, let&#8217;s imagine that we have a bean which reads a configuration property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">@Singleton
public class Greeter {
     private final String name;

     public Greeter(@Value("${my.user.name}") String name) {
         this.name = name;
     }

     public String getGreeting() {
     	return "Hello, " + name + "!";
     }

     public void sayHello() {
         System.out.println(getGreeting());
     }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This bean requires the <code>my.user.name</code> property to be set.
We could of course set it in an <code>application-test.yml</code> file, but for the sake of the exercise, let&#8217;s imagine that this value is <em>dynamic</em> and needs to be read from an external service.
We will implement a <em>custom test resources resolver</em> for this purpose.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create the <code>src/testResources/java/demo/MyTestResource.java</code> file with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">package demo;

import io.micronaut.testresources.core.TestResourcesResolver;

import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;

public class MyTestResource implements TestResourcesResolver {

    public static final String MY_TEST_PROPERTY = "my.user.name";

    @Override
    public List&lt;String&gt; getResolvableProperties(Map&lt;String, Collection&lt;String&gt;&gt; propertyEntries, Map&lt;String, Object&gt; testResourcesConfig) {
        return Collections.singletonList(MY_TEST_PROPERTY); // <b class="conum">(1)</b>
    }

    @Override
    public Optional&lt;String&gt; resolve(String propertyName, Map&lt;String, Object&gt; properties, Map&lt;String, Object&gt; testResourcesConfiguration) {
        if (MY_TEST_PROPERTY.equals(propertyName)) {
            return Optional.of("world");                    // <b class="conum">(2)</b>
        }
        return Optional.empty();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Tells that this resolver can resolve the <code>my.user.name</code> property</p>
</li>
<li>
<p>Returns the value of the <code>my.user.name</code> property</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And in order for the resolver to be discovered, we need to create the <code>src/testResources/resources/META-INF/services/io.micronaut.testresources.core.TestResourcesResolver</code> file with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>demo.MyTestResource</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s write a test for this by adding the <code>src/test/java/demo/GreeterTest.java</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">package demo;

import io.micronaut.context.annotation.Requires;
import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import jakarta.inject.Inject;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

@MicronautTest
class GreeterTest {

    @Inject
    Greeter greeter;


    @Test
    @DisplayName("Says hello")
    void saysHello() {
        greeter.sayHello();
        Assertions.assertEquals("Hello, world!", greeter.getGreeting());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run <code>./gradlew test</code>, you will notice that Gradle will compile your custom test resource resolver, and when the test starts, you will read the following line:</p>
</div>
<div class="paragraph">
<p><code>Loaded 3 test resources resolvers: demo.MyTestResource, io.micronaut.testresources.mysql.MySQLTestResourceProvider, io.micronaut.testresources.testcontainers.GenericTestContainerProvider</code></p>
</div>
<div class="paragraph">
<p>So when the <code>Greeter</code> bean is created, it will read the value of the <code>my.user.name</code> property by calling your custom test resolver!
Of course this is a very simple example, and I recommend that you take a look at the <a href="https://github.com/micronaut-projects/micronaut-test-resources">Micronaut Test Resources sources</a> for more examples of implementing resolvers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this blog post, we&#8217;ve explored the new <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> module, which will greatly simplify development of Micronaut applications which depend on external services like databases or messaging queues.
It works by <em>simplifying</em> configuration, by removing lines which used to be present, but now are dynamically resolved, like <code>datasources.default.url</code>.
Test resources are handled in a separate process, the test resources server, which is responsible for handling their lifecycle.
This also makes it possible to share the resources (containers, databases, &#8230;&#8203;) between independent builds.
For advanced use cases, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> provides <em>configuration based</em> resources creation.</p>
</div>
<div class="paragraph">
<p>Last but not least, <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a> is an extensible framework which will let you implement your own test resources in case the built-in ones miss a feature.</p>
</div>
<div class="paragraph">
<p>Special thanks to <a href="https://twitter.com/tim_yates/">Tim Yates</a> for his hard work on upgrading the Micronaut Guides to use test resources, and <a href="https://twitter.com/alvaro_sanchez">Álvaro Sanchez-Mariscal</a> for his support on the Maven plugin!</p>
</div>
</div>
</div></p>
			<p><a href="/blog/2022/08/micronaut-test-resources.html#disqus_thread">Comments</a></p>
	
	<hr />
	
	<p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="https://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="https://jbake.org">JBake v2.6.6</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.11.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
   <script>hljs.highlightAll();</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
  </body>
</html>
