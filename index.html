<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
   <script src="https://kit.fontawesome.com/fefa3ec5bf.js" crossorigin="anonymous"></script>
      
    <script src="/blog/js/highlight.min.js"></script>
    <link href="/blog/css/equilibrium-gray-light.min.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body>
    <div id="wrap">
   
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		          <li><a href="/blog/projects.html">Projects</a></li>
				    <li><a href="/blog/jsolex.html">JSol'Ex</a></li>
		<li><a href="/blog/astrophotography.html">Astrophotography</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
		          <li><a href="/blog/tags/jsolex.html">JSol'Ex</a></li>
				    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/micronaut.html">Micronaut</a></li>
                <li><a href="/blog/tags/index.html">See all tags</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://bsky.app/profile/melix.champeau.me"><i class="fa fa-twitter"></i></a></li>
	        <li><a rel="me" href="https://mastodon.xyz/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	        <li><a rel="me" href="https://astrodon.social/@melix"><i class="fa-brands fa-mastodon"></i></a></li>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="/blog/2025/03-11-jsolex-shg700.html"><h1>JSol&#8217;Ex errands: How it helped uncovering an inaccuracy of the SHG 700 specifcations</h1></a>
  			<p>11 March 2025</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/solex.html">solex</a> 
	
		<a href="/blog/tags/jsolex.html">jsolex</a> 
	
		<a href="/blog/tags/solar.html">solar</a> 
	
		<a href="/blog/tags/astronomy.html">astronomy</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>For a few months, I&#8217;ve been working with Minh, from MLAstro, to improve support of the <a href="https://mlastro.com/mlastro-shg">SHG 700</a> in JSol&#8217;Ex.
While JSol&#8217;Ex was initially designed for <a href="https://solex.astrosurf.com/sol-ex-presentation-en.html">Christian Buil&#8217;s Sol&#8217;Ex</a>, it appears that lots of users are using it to process images acquired using a different spectroheliograph.
A while back, I added the ability to declare the specifications of the spectroheliograph you are using, which makes JSol&#8217;Ex compatible with a wide variety of instruments.
An example of collaboration with Minh is the experimental flat correction, which is recommended to enable with the SHG 700, and the addition of the SHG 700 to the list of instruments which are officially supported, in addition to the Sol&#8217;Ex and the <a href="https://www.sunscan.net/">Sunscan</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_light_with_shg_700">First light with SHG 700</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you can see, I had been working with MLAstro for quite some time already, but I didn&#8217;t own the instrument.
This has recently been "fixed" and I&#8217;m now a happy user of the SHG 700!</p>
</div>
<div class="paragraph">
<p>I must say that Minh&#8217;s design is fairly impressive, it&#8217;s a truly qualitative instrument.
The aluminum housing makes it extremely robust, without any flexion, and it comes pre-collimated.
In addition, the micro-focusers, which are used for the collimator lens, for the camera objective and for the wavelength selection wheel, are extremely pleasant to use: anyone who has struggled with the collimation of the Sol&#8217;Ex will immediately feel the magic.</p>
</div>
<div class="paragraph">
<p>Being a regular user of the Sol&#8217;Ex, I immediately felt comfortable with the SHG 700: it only took me a few minutes to setup and get my first images!
Fine tuning the focus is a breeze with the microfocusers, it&#8217;s really fantastic to use.</p>
</div>
<div class="paragraph">
<p>My first images were showcased by MLAStro, but here are a few:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/13_10_48_0000_ha_batch.jpg" alt="13 10 48 0000 ha batch">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/CaK.jpg" alt="CaK">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/20250503-Hb.jpg" alt="20250503 Hb">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/20250503-Mg-b1.jpg" alt="20250503 Mg b1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/20250307-animation-Ha-inv.gif" alt="20250307 animation Ha inv">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_mystery">A mystery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While the above images were fairly easy to produce, I was puzzled because I didn&#8217;t manage to get any decent image in Helium D3.
This was surprising, because the sensitivity of the SHG700 is higher, especially because there&#8217;s no need for a ND filter or a an ERF, so it was curious that the only helium image I was able to produce was this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/helium-error.jpg" alt="helium error">
</div>
</div>
<div class="paragraph">
<p>To understand the problem was that, it is important to mention that unlike Minh, I was using JSol&#8217;Ex <a href="http://localhost:8820/blog/2024/06-14-jsolex-helium-continuum.html">one-click, fully automated processing</a>, a feature which was introduced a while ago (June 2024) and worked extremely well for both Sol&#8217;Ex and Sunscan files (N.B: the Sunscan app introduced the same feature a few days ago).</p>
</div>
<div class="paragraph">
<p>This feature only works if we can properly compute the dispersion of the spectrum, which is measured in Angstrom/pixel.
In order to compute this, we need to know the specifications of the spectroheliograph, such as the grating density, the focal length of the collimator and objective lenses, the total angle as well as the pixel size of the camera.
Once we know all this, we can determine how many pixels separate the reference line that we use, for example the Sodium D2 line, from the Helium D3 line.
To illustrate this, let&#8217;s say that we have a dispersion of 0.1Å/px. The Helium line is to be found at 5875.62Å, when the reference line, the Sodium D2 line, is detected at 5889.95Å.
Therefore, the Helium line can be found 14.33Å away from the D2 line, which means 14.33/0.1 = 143.3 pixels away.</p>
</div>
<div class="paragraph">
<p>Using both Sol&#8217;Ex and Sunscan, I had great experience at extracting this line automatically, so it was to say the least curious that it wouldn&#8217;t work with the SHG 700.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_investigation">Investigation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So I contacted Minh, and after eliminating obvious possible candidates, like weak signal or incorrect exposition or gain, I decided to go the "old way" and searched for the helium line manually.
It was with great surprise that I discovered that when JSol&#8217;Ex told me that the line should be 124.9, I was measuring something closer to 116 pixels!
I brought this to Minh, and we identified 3 possible causes for this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>an error in the computation of the dispersion in JSol&#8217;Ex</p>
</li>
<li>
<p>a different focal length of the SHG 700</p>
</li>
<li>
<p>a grating which wouldn&#8217;t have the expected number of lines/mm</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It was also possible, but unlikely, that a combination of 2 and 3 would happen.
The first thing I&#8217;ve done is double checking my formula to compute the dispersion in JSol&#8217;Ex.
I was doubtful that it could be wrong, given that it was used with success on different SHGs.
In addition, it gave exactly the same result as the <a href="https://solarchatforum.com/viewtopic.php?t=48072">Ken Harrison' SimSpec SHG spreadsheet</a>.</p>
</div>
<div class="paragraph">
<p>So we moved to the 2d option: the SHG 700 was advertised with a focal length of 75mm.
However, the pixel shift I was manually measuring was closer to 70mm.
I brought this again to Minh, who contacted the supplier of the lens, and here&#8217;s what he told me:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The lens from the first production run had a focal length of 72mm, a discrepancy I was unaware of at the time. I had sourced this lens from a supplier in China and provided them with the Zemax file for my self-designed 6-element Double Gauss 75mm lens. The first prototype was disappointing—its near-UV performance and coating were poor, and contrast was low across the field. This was largely due to my inexperience in optical design, as I had only begun learning Zemax a month prior, making this my first optical project.</p>
</div>
<div class="paragraph">
<p>I raised these concerns with the supplier, who was very accommodating and offered to help optimize the design while ensuring key parameters such as focal length, aperture, and exit pupil remained unchanged. With each revision, the lens improved—by the second and third prototypes, contrast was significantly better, sharpness in the blue end of the spectrum improved, and the field was much flatter across the FOV. The field of view closely matched the earlier lens, and because I had already tested focal length in previous iterations, I didn’t think to recheck it. Visually, the lenses appeared identical, except for a slight shift in coating hue.</p>
</div>
<div class="paragraph">
<p><strong>The third prototype was approved for production and became the MLAstro "75mm" compound lens used in all MLAstro SHGs. However, it was only later confirmed by the supplier that the final production lens actually had a focal length of 72mm instead of 75mm</strong>. The optimizations for blue performance and field flattening had slightly shortened the focal length."</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Mihn Truong Nguyen<br>
<cite>MLAstro</cite>
</div>
</div>
<div class="paragraph">
<p>So I changed the focal length to 72mm and got this image instead:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/helium-fixed.jpg" alt="helium fixed">
</div>
</div>
<div class="paragraph">
<p>That&#8217;s quite a difference! So it appeared that the software was correct, and that it allowed identifying a problem in the spectrograph specifications, because a spectral line wasn&#8217;t found where it should have been!
While going from 75mm to 72mm won&#8217;t make much of a difference, the fact of not using the right numbers makes a huge difference in JSol&#8217;Ex: computations are all off, which includes the pixel shifts like in this exercise, but also the measured redshifts.
In addition, this would make it impossible to perform more complicated tasks like finding the ionized Fe lines when imaging the corona E.
The image is stil less contrasted than it should be, which may indicate that the computation is slightly off, or it&#8217;s just due to the weather conditions that day, I didn&#8217;t have the opportunity to retry.</p>
</div>
<div class="paragraph">
<p>Lastly, we can actually see fairly easily that the new focal length is a better fit, by using JSol&#8217;Ex "profile" tab.
In that tab, we compare the profile of the spectrum that you captured with a reference spectrum from the BASS2000 database: this is also how the software automatically determines what spectral line is observed, by comparing the profiles together.</p>
</div>
<div class="paragraph">
<p>With a 75mm length and an H-alpha profile, here&#8217;s what we got:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/profile-75mm.jpg" alt="profile 75mm">
</div>
</div>
<div class="paragraph">
<p>You can see that while the H-alpha profile is found, as soon as we move towards the wings, there are slight shifts between the local minimas.
When we switch to a 72mm length, these are perfectly aligned:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/shg700/profile-72mm.jpg" alt="profile 72mm">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The SHG 700 is a fairly impressive instrument: it&#8217;s robust, it&#8217;s a pleasure to use with its microfocusers, and Minh is always super responsive and very patient.
Its use doesn&#8217;t come without drawbacks, though.
It&#8217;s weight, for example, restricts it to refractors which have a good focuser.
The dimension of the sun is also smaller than with the Sol&#8217;Ex at equivalent focal length (see <a href="https://solarchatforum.com/viewtopic.php?p=460891#p460891">this post for an explanation</a>).
However, it produces stunning images, sometimes rivalizing these produced with an etalon.</p>
</div>
<div class="paragraph">
<p>While testing it, I faced this problem that the helium line images were significantly worse than with the Sol&#8217;Ex, which didn&#8217;t quite make sense.
After investigation, it turned out we had highlighted a difference in the specifications, a lens had been changed from 75mm to 72mm by the supplier, without letting MLAstro know.
That&#8217;s a pity, but, in the end, the problem is very easy to fix in JSol&#8217;Ex.
Be sure to upgrade to JSol&#8217;Ex 2.11.2 which includes <a href="https://github.com/melix/astro4j/pull/525">a fix to update the focal length</a>.</p>
</div>
</div>
</div></p>
  			<a href="/blog/2025/02-01-jsolex-actve-areas.html"><h1>Automatic active region detection with JSol&#8217;Ex 2.9</h1></a>
  			<p>01 February 2025</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/solex.html">solex</a> 
	
		<a href="/blog/tags/jsolex.html">jsolex</a> 
	
		<a href="/blog/tags/solar.html">solar</a> 
	
		<a href="/blog/tags/astronomy.html">astronomy</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The latest release of JSol&#8217;Ex as of writing this blog post, JSol&#8217;Ex 2.9, ships with a new ability: automatically detecting <a href="https://en.wikipedia.org/wiki/Active_region">active regions</a>.
In this blog post, I will explain the principles and the algorithm I used, but also show its limits.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_active_regions">About active regions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of all, a bit of vocabulary.
An active region is a region of the Sun atmosphere where special activity occurs, such as flares or coronal mass ejections.
They don&#8217;t have to be associated with sunspots, but in general, they are.
In JSol&#8217;Ex, we&#8217;re essentially detecting sunspots, and the terminology "active regions" essentially comes from the fact that we can use the <a href="https://www.swpc.noaa.gov/" class="bare">https://www.swpc.noaa.gov/</a>NOAA database] to label these active regions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spectroheliographs">Spectroheliographs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An instrument like <a href="http://www.astrosurf.com/solex/">Christian Buil&#8217;s Sol&#8217;Ex</a>, called a spectroheliograph (or SHG in short) doesn&#8217;t offer any kind of "live view" like typical solar instruments like Coronado or Lunt instruments.
Instead, what we get is a video file, where each frames consists of a "slice" of the sun, observed as a portion of the light spectrum:</p>
</div>
<video controls autoplay height="80">
    <source src="/blog/video/anim-spectrum.webm"
            type="video/webm">
</video>
<div class="paragraph">
<p>The video above is an excerpt from a so-called "scan": the principle is to have a slice of the sun passing through a slit, and a grating is used to spread the light into a spectrum.
Here, we are observing a curved dark line, which is the H-alpha line, and the "wobbling" we see around that line is an illustration of the <a href="https://en.wikipedia.org/wiki/Doppler_effect">Doppler effect</a>.
The idea of software like <a href="http://valerie.desnoux.free.fr/inti/">Valérie Desnoux&#8217;s INTI</a> and <a href="https://melix.github.io/astro4j/2.9.0/en/jsolex.html">JSol&#8217;Ex</a> is to extract pixels from the studied line (here H-alpha) in order to reconstruct an image of the sun.</p>
</div>
<div class="paragraph">
<p>However, as you can see in that animation, there&#8217;s a lot more information available in each frame.
While we are mostly interested in the central line (here H-alpha), it&#8217;s also interesting to look "above" or "below" the line, which is often referred to "pixel shifting", in which case we&#8217;re not studying H-alpha, but a different wavelength: that&#8217;s one of the strenghts of Sol&#8217;Ex, which makes it possible to do "science" at home!</p>
</div>
<div class="paragraph">
<p>In particular, this video shows a couple interesting features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sometimes, you see some vertical dark lines appearing: these are features of the solar atmosphere. The darker lines which spread around multiple columns are these we are mostly interested in for this blog post: they correspond to sunspots!</p>
</li>
<li>
<p>near the end of the video, on the right, you will see a white flash apparearing inside of of these regions: it&#8217;s a solar flare!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This video is actually an excerpt from one of the many captures I&#8217;ve done with Sol&#8217;Ex, and I captured it during an eruption, on May 5th, 2024.
What you are seeing here is the <a href="https://www.earth.com/news/sunspot-region-ar3664-blasted-earth-mars-may-2024-still-very-active/">massive AR3664 region</a> which was suject to multiple X-flares and resulted in beautiful auroras on Earth!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatic_active_region_detection">Automatic active region detection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve always considered that it would be a cool feature to be able to detect these lines automatically in JSol&#8217;Ex, and provide an overlay of the detected sunspots.
Here we go, it is finally implemented in JSol&#8217;Ex 2.9.0!
If you select the "full processing mode" or that you check the "active regions" checkbox in a custom process, then JSol&#8217;Ex will automatically create an image of the sun with the detected active regions as an overlay:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex-ar/ar-labels.jpg" alt="ar labels">
</div>
</div>
<div class="paragraph">
<p>Unfortunately that day I didn&#8217;t capture a full disk, but you can see that JSol&#8217;Ex annotated the disk with the detected active regions, but it also added the labels for these regions automatically.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take another example with an image captured in Calcium K on January 17, 2025:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex-ar/detection-calcium.jpg" alt="detection calcium">
</div>
</div>
<div class="paragraph">
<p>You will notice 2 different colors for labels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>blue labels are the ones detected by JSol&#8217;Ex</p>
</li>
<li>
<p>red labels are the ones coming from the NOAA database, which were not detected</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sometimes, you will see like in the image above regions which are not detected, and others which are detected but not in the NOAA database.
The reason why not all of them are detected is that I had to choose "reasonable" detection thresholds, which work for most use cases.
I plan to improve the algorithm over time to make it more robust, based on your feedback.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_does_it_work">How does it work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The algorithm is based on a simple analysis of each frame.
If you open your SER file in JSol&#8217;Ex video analyzer, you will see something similar to this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex-ar/detection-debugger.jpg" alt="detection debugger">
</div>
</div>
<div class="paragraph">
<p>On the top, you see the original frame, with the curved H-alpha line.
On the bottom, you see the corrected frame, where the H-alpha line is straightened, and the active regions are highlighted in purple.</p>
</div>
<div class="paragraph">
<p>The algorithm is based on the following steps:</p>
</div>
<div class="paragraph">
<p>For each frame:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Detect the borders of the sun</p>
</li>
<li>
<p>For each column, compute the average intensity of the column, as well as its standard deviation</p>
</li>
<li>
<p>Compute a 3rd order polynomial fit of the average intensity and standard deviation</p>
</li>
<li>
<p>now, for each column, we compare its average intensity and standard deviation to the polynomial fits: if both of them are below a particular threshold, we consider that we have detected a candidate</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The reason to only keep candidates which have both average intensity and standard deviation below a threshold is because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sunspots characterize by a clear vertical line, which means that the standard deviation is low (most pixels have a similar value on the column)</p>
</li>
<li>
<p>sunspots are darker than the surrounding, which means that the average intensity is lower</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the moment, I&#8217;m using the following thresholds (note that they may change in future releases, as I improve the accuracy):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>average intensity threshold: 0.95 times the predicted value</p>
</li>
<li>
<p>standard deviation threshold: 0.85 times the predicted value</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once we have the results for all frames, we aggregate active regions by collecting adjacent candidates.</p>
</div>
<div class="paragraph">
<p>Finally, we filter out regions which are too small, then perform clustering of regions which are close to each other.</p>
</div>
<div class="paragraph">
<p>The whole algorithm <a href="https://github.com/melix/astro4j/blob/dbb2418318f4cb143726791830a32da00a35ae6f/jsolex-core/src/main/java/me/champeau/a4j/jsolex/processing/sun/detection/PhenomenaDetector.java#L40">can be found here</a> (note that it also includes redshift detection, which was discussed in a different blog post).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limitations">Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This algorithm proves to work relatively well in many different wavelengths (H-alpha, calcium, magnesium &#8230;&#8203;).
However, there are sometimes false positives.
This is for example the case when I&#8217;m scanning in H-beta, due to the long focal length of my telescope and astigmatism, and the fact that H-beta provides a lot of details.</p>
</div>
<div class="paragraph">
<p>In this case, the algorithm detects areas which are actually just noise:</p>
</div>
<div class="paragraph">
<p>Note that these are close to the north and south poles.
I have also noticed that the algorithm tends to detect noise as active regions when we&#8217;re close to the limb, which is also why I&#8217;m currently filtering these out.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex-ar/active_regions_noise.jpg" alt="active regions noise">
</div>
</div>
<div class="paragraph">
<p>At this stage, I have chosen not to make the detection thresholds configurable, because I consider these internal implementation details, which may change in the future, and that I don&#8217;t want to expose to the user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annotation_of_active_regions">Annotation of active regions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once piece of work that we didn&#8217;t explain yet is how JSol&#8217;Ex puts labels around active regions.
For this, we are using the <a href="https://www.swpc.noaa.gov/products/solar-region-summary">NOAA Solar Region Summary</a> database.</p>
</div>
<div class="paragraph">
<p>This provides us, at a particular date, the list of active regions with their positions on the solar disk.
JSol&#8217;Ex will compare these with the detected regions, and put the labels in different colors based on whether they were detected or not.</p>
</div>
<div class="paragraph">
<p>However, the position of active regions will only be correct if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you have properly oriented your image (north at the top, east on the left): to help you with this, use the "GONG" tab on the right of the interface to download a reference image and compare with yours</p>
</li>
<li>
<p>you are using an equatorial mount. If you are not, then make sure to check the new "alt-az" mode and enter your GPS coordinates in the settings, so that JSol&#8217;Ex can compute the parallactic angle of the sun at the moment of the observation and automatically correct the orientation of the image.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The data from NOAA is cached in your local filesystem, so that we don&#8217;t have to download it every time you open a video file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_frequently_asked_questions">Frequently Asked Questions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Despite only having released this a day ago, I already have received the same question multiple times: can JSol&#8217;Ex be used to annotate an <em>existing</em> image of the sun, that is to say, take a JPG or PNG image and annotate it?</p>
</div>
<div class="paragraph">
<p>If you have read carefully this blog post and that I explained things correctly, you will have understood that the answer is no: because my algorithm is based on the analysis of each frame, there&#8217;s no such information available in a single image.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I hope you will enjoy this new feature in JSol&#8217;Ex 2.9.0.
This blog post is a tentative explanation of the algorithm, and I will be happy to answer any questions you may have about it.
As always, feel free to contribute, JSol&#8217;Ex is open source!</p>
</div>
</div>
</div></p>
  			<a href="/blog/2024/06-14-jsolex-helium-continuum.html"><h1>Extraction automatique d&#8217;images Hélium avec JSol&#8217;Ex</h1></a>
  			<p>14 June 2024</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/solex.html">solex</a> 
	
		<a href="/blog/tags/jsolex.html">jsolex</a> 
	
		<a href="/blog/tags/solaire.html">solaire</a> 
	
		<a href="/blog/tags/astronomie.html">astronomie</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Dans ce billet, je vais prendre exemple d&#8217;un cas d&#8217;utilisation particulier, l&#8217;extraction d&#8217;images Hélium, pour expliquer comment j&#8217;envisage le développement de JSol&#8217;Ex, dans l&#8217;optique de simplifier, d&#8217;une version à une autre, son exploitation par les utilisateurs.</p>
</div>
<div class="paragraph">
<p>Je rappelle à toutes fins utiles que le logiciel officiel n&#8217;est pas JSol&#8217;Ex mais bien <a href="http://valerie.desnoux.free.fr/inti/">INTI de Valérie Desnoux</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_principe_du_solex">Principe du Sol&#8217;Ex</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rappelons tout d&#8217;abord le principe de base du <a href="http://www.astrosurf.com/solex/">Sol&#8217;Ex de Christian Buil</a>.
Le concept requiert de reconstituer une image du soleil, ligne par ligne, en exploitant une vidéo dont chaque trame montre une partie du spectre solaire, centré sur une raie particulière que l&#8217;on étudie.
La raie la plus communément étudiée est la raie H-alpha, qui, sur le spectre solaire, apparaît en absorption, c&#8217;est à dire qu&#8217;elle sera une ligne sombre sur une image du spectre :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex-helium/spectre.jpg" alt="spectre">
</div>
<div class="title">Figure 1. Image du spectre solaire, raie H-alpha sombre détectée</div>
</div>
<div class="paragraph">
<p><em>En haut, l&#8217;image telle qu&#8217;on la trouve dans la vidéo, la ligne est "déformée". En bas, l&#8217;image "corrigée". Les points bleus correspondent à la détection de l&#8217;effet Doppler, les lignes sombres verticales correspondent à des taches solaires.</em></p>
</div>
<div class="paragraph">
<p>Les logiciels comme <a href="http://valerie.desnoux.free.fr/inti/">INTI</a> et <a href="https://melix.github.io/astro4j/latest/fr/jsolex.html">JSol&#8217;Ex</a> exploitent le fait que la ligne étudiée est la plus sombre de l&#8217;image pour se repérer.
Un des aspects fondamentaux de la reconstruction que je n&#8217;avais honnêtement pas compris lorsque je me suis lancé dans ce projet, c&#8217;est que <strong>tout le signal permettant de recomposer l&#8217;image H-alpha se trouve dans cette ligne sombre</strong>.
En effet, même si elle paraît "noire", il y a en fait bien d&#8217;infimes variations dans cette ligne, et c&#8217;est celà qui nous sert à reconstituer une image !</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">8 bits vs 16 bits</div>
Cet aspect explique l&#8217;importance d&#8217;utiliser une acquisition en 16 bits et non en 8-bits.
En effet, si l&#8217;acquisition est faite en 8 bits, on ne dispose que de 256 valeurs possibles pour encoder l&#8217;ensemble de la dynamique de l&#8217;image.
Si le signal ne se trouve qu&#8217;au centre de la raie, on comprend vite qu&#8217;on ne dispose alors que d&#8217;un nombre très limité de valeurs pour ce qui se passe dans cette simple région.
En utilisant 16 bits, on augmente sensiblement notre capacité à encoder des valeurs de niveaux différents dans le centre de la raie, puisqu&#8217;on dispose cette fois de 65536 valeurs possibles pour l&#8217;ensemble de l&#8217;image !
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_cas_des_raies_hélium">Le cas des raies Hélium</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La détection de raies sombres permet, si la fenêtre de cropping du spectre est relativement petite, de se concentrer sur une raie à étudier.
Ca fonctionne très bien pour les raies H-alpha, Magnésium, Calcium K ou H, etc, qui sont des raies en absorption.</p>
</div>
<div class="paragraph">
<p>En revanche, la raie Hélium est une raie en émission : elle est "claire" au lieu d&#8217;être sombre, mais elle est aussi impossible à distinguer dans la plupart des trames parce que noyée dans le flux.
Aussi les logiciels ne peuvent pas la trouver.</p>
</div>
<div class="paragraph">
<p>Alors, comment fait JSol&#8217;Ex, dans ses dernières versions, pour être capable de produire en 1 clic une image Hélium comme celle ci-dessous ?
La question est intéressante non seulement d&#8217;un point de vue technique, mais aussi pour comprendre la façon dont j&#8217;aborde le développement de JSol&#8217;Ex.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex-helium/image-helium.jpg" alt="image helium">
</div>
</div>
<div class="paragraph">
<p>Le site de Christian Buil <a href="http://www.astrosurf.com/solex/sol-ex-observation.html">est une nouvelle mine d&#8217;information pour nous aider</a> : pour pouvoir produire une telle image, il est nécessaire de prendre une raie sombre comme référence, puis d&#8217;appliquer un "décalage de pixels" pour "trouver" la raie Hélium.
Enfin, il est nécessaire de procéder à une soustraction du continuum (une 2ème image).</p>
</div>
<div class="paragraph">
<p>Cette notion de décalage de pixels est bien connue des utilisateurs chevronnés du Sol&#8217;Ex.
Le principe est relativement simple : au lieu de reconstituer une image en utilisant le centre de la raie détectée (la ligne rouge dans l&#8217;image spectrale ci-dessus), on va reconstituer une image en se décalant vers le haut ou vers le bas de quelques pixels.
C&#8217;est ce même principe qui permet de créer des images Doppler du soleil, qui montrent en bleu les régions qui s&#8217;approchent de nous et en rouge celles qui s&#8217;éloignent.
On peut même produire des timelapses assez spectaculaires comme cette animation que j&#8217;ai réalisée le 5 juin 2024 et qui est générée par le logiciel en quelques minutes :</p>
</div>
<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;"> <iframe style="width:100%;height:100%;position:absolute;left:0px;top:0px;overflow:hidden" frameborder="0" type="text/html" src="https://www.dailymotion.com/embed/video/x8znzg6?autoplay=1" width="100%" height="100%" allowfullscreen title="Dailymotion Video Player" allow="autoplay; web-share"> </iframe> </div>
<br>
<div class="paragraph">
<p>Comme <a href="https://www.youtube.com/watch?v=TuF6R9K5cqg&amp;feature=youtu.be">Christian l&#8217;explique dans cette vidéo</a>, trouver ce décalage de pixels n&#8217;est pas forcément chose simple.
Tout d&#8217;abord, il est nécessaire de trouver la raie "sombre" de référence : on utilisera traditionellement le doublet du sodium pour se répérer, puis on utilisera la raie Sodium D2 ou encore la raie Fe I présente à côté comme référence.</p>
</div>
<div class="paragraph">
<p>Ensuite, il faut trouver ce fameux décalage de pixels pour "tomber" sur la raie Hélium.
La vidéo de Christian ne montre pas les dernières améliorations que Valérie Desnoux a intégré à INTI pour rendre les choses plus simples, mais, grossièrement, il faut :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>faire une capture surexposée qui va nous permettre de "voir" la raie hélium</p>
</li>
<li>
<p>faire une capture "normale" pour disposer de l&#8217;image à réellement traiter</p>
</li>
<li>
<p>ouvrir INTI et traiter la première vidéo pour disposer de l&#8217;image moyenne montrant la raie Hélium en bord de champ</p>
</li>
<li>
<p>traiter la 2ème vidéo en mode "raie libre", utiliser "polynôme automatique" et ouvrir l&#8217;image moyenne calculée lors du premier traitement pour trouver le décalage</p>
</li>
<li>
<p>enfin utiliser un autre logiciel comme i-Spec pour faire la soustraction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cette procédure, <a href="http://valerie.desnoux.free.fr/inti/">bien que documentée</a>, est très intimidante pour les utilisateurs et explique que peu se soient lancés dans ce défi.</p>
</div>
<div class="paragraph">
<p>Dans JSol&#8217;Ex, la procédure est simplifiée au maximum :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on fait une capture "classique", intégrant la raie de référence (ex SoD2) et en utilisant un cropping assez large pour intégrer aussi la raie proche Hélium</p>
</li>
<li>
<p>on ouvre le fichier dans JSol&#8217;Ex : les images sont générées automatiquement, il n&#8217;y a rien à calculer, pas de soustraction de continuum, rien, juste un clic !</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Ca ne prend que quelques secondes !</strong></p>
</div>
<iframe width="1000" height="600" src="https://www.youtube.com/embed/yE6de4JM0Cw?si=O_qZrCAISZliPfxA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>
</div>
<div class="sect1">
<h2 id="_le_processus_de_simplification">Le processus de simplification</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_imagemath">ImageMath</h3>
<div class="paragraph">
<p>Avant d&#8217;en arriver là, il a fallu de nombreuses améliorations, qui ont été livrées au fur et à mesure des versions.
La première, c&#8217;est ce système de script que j&#8217;ai appelé "ImageMath" (le nom est inspiré de PixelMath dans PixInsight) : il permet d&#8217;utiliser des scripts pour produire des images que JSol&#8217;Ex ne produit pas tout seul.
Cette avancée a permis d&#8217;écrire un script qui produit une image Hélium à partir d&#8217;un seul fichier SER :</p>
</div>
<div class="listingblock">
<div class="title">Un exemple de script permettant de générer une image Hélium</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="python">[params]
# Entrer la valeur du décalage de raie
RaieHelium = -85
# Limites hautes et basses pour le continuum
ContinuumLo=-80
ContinuumHi=-70
# Stretch de l'image
Stretch=10

## Variables temporaires
[tmp]
continuum = max(range(ContinuumLo,ContinuumHi))
helium_raw = autocrop(img(RaieHelium) - continuum)

## Maintenant les images !
[outputs]
helium = asinh_stretch(helium_raw, blackPoint, Stretch)
helium_fixed = asinh_stretch(fix_banding(helium_raw;BandWidth;BandIterations),blackPoint, Stretch)
helium_color = colorize(helium_fixed, "Helium (D3)")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Néanmoins, vous noterez que ce script nécessite toujours de déterminer le décalage de la raie Hélium, ainsi que la position du continuum.
Ceci pouvait cependant être fait simplement avec le même fichier SER en l&#8217;ouvrant dans le "débogueur de raie", une procédure que <a href="https://www.youtube.com/watch?v=EwUUg06opKU">je décrivais à l&#8217;époque dans une vidéo</a>.</p>
</div>
<div class="paragraph">
<p>Cette procédure permettait ainsi d&#8217;obtenir une image Hélium en moins de 5 minutes, ce qui était déja une amélioration sensible par rapport à avant : plus besoin de faire 2 vidéos distinctes et un décalage de pixels calculé par le logiciel avec l&#8217;assistance de l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Bien que ce soit une amélioration notable, on peut faire encore mieux.</p>
</div>
</div>
<div class="sect2">
<h3 id="_profils_spectraux">Profils spectraux</h3>
<div class="paragraph">
<p>JSol&#8217;Ex affiche depuis longtemps dans un onglet le "profil spectral" de l&#8217;image étudiée et peut aussi calculer la <em>dispersion</em>, mesurée en Angrstöms par pixel, d&#8217;une image.
Ce profil correspond à l&#8217;intensité des raies pour un décalage de pixels donné.
Depuis la version 2.3.0 cependant, j&#8217;ai intégré une fonctionnalité qui permet de détecter automatiquement la raie étudiée grâce à la comparaison de ce profil à un profil de référence (les données sont issues de la <a href="https://bass2000.obspm.fr/solar_spect.php">base de données BASS2000</a>).
Grâce à celà, il est désormais possible de savoir comment une image "s&#8217;aligne" entre le profil de référence et celui qu&#8217;on étudie.
Puisque l&#8217;on connait à la fois la position de la raie de référence (Sodium D2 par exemple) et la dispersion, il est alors possible de calculer de combien de pixels on doit se déplacer pour trouver la raie Hélium !</p>
</div>
<div class="paragraph">
<p>Cette fonctionnalité est d&#8217;ailleurs disponible dans les scripts sous le nom de 'find_shift`.</p>
</div>
</div>
<div class="sect2">
<h3 id="_soustraction_du_continuum">Soustraction du continuum</h3>
<div class="paragraph">
<p>A ce stade, nous disposons donc d&#8217;une image dont on sait qu&#8217;elle contient une raie de référence (Sodium D2 ou Fer Fe I) mais aussi le décalage en pixels de la raie Hélium.
Il nous manque cependant la soustraction du continuum.
Là encore, le script ci-dessus montre qu&#8217;il fallait entrer une valeur "à la main" pour trouver ce qu&#8217;il fallait soustraire.
Une façon simple de procéder était encore une fois d&#8217;ouvrir le débogueur et de regarder les lignes plus claires dans le spectre : l&#8217;oeil étant assez sensible aux changements de contraste, il n&#8217;était pas trop compliqué de trouver un intervalle raisonnable pour le continuum.</p>
</div>
<div class="paragraph">
<p>Néanmoins, si on souhaite arriver à un traitement complètement automatique, on ne peut plus se baser sur une valeur "pifométrique".
Une façon naïve de régler le problème aurait été d&#8217;utiliser un décalage fixe (par exemple 15 pixels).
Cependant, ça ne fonctionne pas, pour plusieurs raisons :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le décalage dépend de la résolution (taille des pixels, dispersion)</p>
</li>
<li>
<p>on peut tomber sur une raie trop sombre, cette région du spectre étant assez contrastée</p>
</li>
<li>
<p>le résultat est très sensible à l&#8217;exposition</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour cette raison, j&#8217;ai ajouté une fonctionnalité qui calcule un "continuum synthétique".</p>
</div>
<div class="paragraph">
<p>Il faut noter que contrairement à l&#8217;image "continuum" qui utilise un décalage fixe (et configurable) dans les traitements standards, ce continuum synthétique est utilisé uniquement dans le contexte du traitement Hélium, ou lors de l&#8217;utilisation de la fonction <code>continuum()</code> dans un script.</p>
</div>
<div class="paragraph">
<p>L&#8217;idée de cette fonction est de calculer une image qui représente au mieux le continuum à soustraire.
Au lieu d&#8217;utiliser un seul décalage de pixels, on va effectuer un calcul à partir de plusieurs décalages (cette fonction nécessite donc plus de ressources lors du traitement).
Ainsi la première chose à comprendre c&#8217;est qu&#8217;il ne s&#8217;agira pas d&#8217;une image à une longueur d&#8217;onde précise, mais bel et bien d&#8217;une image synthétique basée sur des propriétés statistiques.</p>
</div>
<div class="paragraph">
<p>En premier lieu, on effectue un échantillonnage des images à différents décalages de pixels, du minimum possible au maximum possible par rapport à la fenêtre de cropping du spectre et de la distorsion.
Par exemple, si chaque trame fait 2000x200 pixels, on dispose potentiellement de 100 décalages entiers (la hauteur de l&#8217;image).
Cependant, à cause de la distorsion, seuls un sous-ensemble nous permet d&#8217;avoir des lignes complètes lors de la reconstruction (disons, 180 lignes, qui donneront 180 images).
Sur ces 180 décalages possible, nous n&#8217;allons, pour des raisons de performance, uniquement en retenir un échantillon (environ 1/3), ce qui nous donnera donc 60 images à étudier.
Sur ces 60 images, on élimine celles qui correspondent à un décalage de pixel trop proche de la raie de référence puisque de manière évidente elles ne correspondent pas au continuum.</p>
</div>
<div class="paragraph">
<p>Dès lors commence l&#8217;analyse statistique : pour chacune de ces images, on calcule leur valeur moyenne.
Ensuite, nous calculons la moyenne de ces moyennes et nous ne conservons que les images dont la moyenne est supérieure à cette moyenne.</p>
</div>
<div class="paragraph">
<p>A ce stade, il nous reste donc quelques candidates, dont la luminosité est suffisante pour être considérée comme le continuum, mais on dispose bien d&#8217;une liste d&#8217;images.
La dernière étape consiste donc à calculer la médiane de toutes ces images, pour obtenir un et un seul "continuum synthétique".</p>
</div>
<div class="paragraph">
<p>Si on reprend les étapes, celà nous donne par exemple:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on dispose de 60 images à des décalages de pixels (entiers)</p>
</li>
<li>
<p>on retire les 8 qui sont au centre de la raie étudiée, il en reste 52</p>
</li>
<li>
<p>on calcule la valeur moyenne de chacune de ces images : 5000, 8000, 5200, 6400, &#8230;&#8203;</p>
</li>
<li>
<p>on calcule la moyenne de toutes ces moyennes, par ex: 6000</p>
</li>
<li>
<p>on ne retient que les images dont la moyenne est supérieure à cette moyenne, disons qu&#8217;il en reste 30</p>
</li>
<li>
<p>on calcule la médiane de ces 30 images</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il ne nous reste donc plus qu&#8217;à faire la soustraction entre l&#8217;image au décalage de pixels de la raie Hélium avec le continuum synthétique calculé et on obtient l&#8217;image Hélium ci-dessus, en quelques secondes seulement !</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans ce billet, j&#8217;ai décris la façon dont je procède pour améliorer JSol&#8217;Ex.
En premier lieu, il s&#8217;agit d&#8217;identifier un besoin particulier, par exemple, ici, produire une image Hélium.
A partir de ce besoin, il s&#8217;agit de chercher comment simplifier un tel traitement.
La simplification ne se fait alors qu&#8217;à partir de ce dont je dispose à un instant <em>t</em>.
Par exemple, dans un premier temps, il a s&#8217;agit d&#8217;ajouter un système de scripts, qui, outre le traitement des images Hélium, permet d&#8217;exploiter la richesse des données disponibles dans un scan.
Les personnes intéressées peuvent en apprendre plus sur les scripts <a href="https://youtu.be/8XKzFcmvqfI">dans ce tutoriel</a>.</p>
</div>
<div class="paragraph">
<p>Ensuite, il a s&#8217;agit d&#8217;ajouter des fonctionnalités permettant de simplifier la configuration pour les utilisateurs, en l&#8217;occurrence la détection automatique de raie, puis d&#8217;exploiter ces nouvelles fonctionnalités pour simplifier encore plus le traitement des images.</p>
</div>
<div class="paragraph">
<p>Ainsi, il s&#8217;agit d&#8217;une méthode très itérative, mais toujours dans le but de livrer des incréments fournissant une certaine valeur ajoutée aux utilisateurs.
La bonne nouvelle, c&#8217;est que j&#8217;ai beaucoup d&#8217;autres idées en tête !</p>
</div>
<div class="sect2">
<h3 id="_ressources">Ressources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://melix.github.io/astro4j/latest/fr/jsolex.html">JSol&#8217;Ex</a> (téléchargement et documentation)</p>
</li>
<li>
<p><a href="http://valerie.desnoux.free.fr/inti/">INTI</a> (logiciel officiel)</p>
</li>
<li>
<p><a href="http://www.astrosurf.com/solex/sol-ex-traitement.html">Sol&#8217;Ex</a> (site officiel Sol&#8217;Ex)</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>
  			<a href="/blog/2024/04-25-jsolex-contrast.html"><h1>JSol&#8217;Ex 2.2.0 et amélioration du contraste</h1></a>
  			<p>25 April 2024</p>
			<p><em>Tags: </em>
		<a href="/blog/tags/solex.html">solex</a> 
	
		<a href="/blog/tags/jsolex.html">jsolex</a> 
	
		<a href="/blog/tags/solaire.html">solaire</a> 
	
		<a href="/blog/tags/astronomie.html">astronomie</a> 
	</p>
			
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/melix/astro4j/releases/tag/2.2.0">JSol&#8217;Ex 2.2.0</a> est tout juste sorti ! Dans cette version, j&#8217;ai particulièrement travaillé sur l&#8217;amélioration des contrastes. En effet, celles et ceux qui m&#8217;ont entendu parler de ce logiciel savent que je râle depuis longtemps sur mon algo d&#8217;amélioration de contraste. Dans JSol&#8217;Ex, il y a plusieurs algorithmes d&#8217;implémentés. Historiquement, le premier était une transformation sinus hyperbolique inverse, qui fonctionne relativement bien pour faire ressortir les zones plus sombres, mais éclaircit trop le reste. L&#8217;autre algorithme, utilisé aussi par <a href="http://valerie.desnoux.free.fr/inti/">INTI</a>, c&#8217;est la normalisation locale d&#8217;histogramme (CLAHE).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_les_problèmes_avec_clahe">Les problèmes avec CLAHE</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CLAHE est un algorithme qui améliore sensiblement le contraste. Cependant, je n&#8217;ai jamais été très content du résultat. Je ne sais pas comment Valérie Desnoux fait dans INTI, qui a l&#8217;air de s&#8217;en sortir mieux, mais dans JSol&#8217;Ex les résultats obtenus sont assez moyens.
En particulier, je note plusieurs défauts :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la création d&#8217;artéfacts, liés au fait que cet algorithme travaille sur des "tuiles" d&#8217;une taille donnée. Plus la taille de la tuile est élevée, moins l&#8217;amélioration de contraste est aggressive, mais plus les artéfacts sont visibles</p>
</li>
<li>
<p>sur l&#8217;image du soleil, les limbes sont toujours éclaircis, ce qui me mène au point suivant</p>
</li>
<li>
<p>les images solaires paraissent plus "plates" : le relief, en particulier l&#8217;obscurcissement lié à la sphéricité du soleil, disparaît. C&#8217;est aussi un effet mécanique de l&#8217;algorithme lui-même : plus la taille des tuiles est faible, moins on peut utiliser de valeurs distinctes. Ainsi pour une taille de tuile à 16 pixels, on aura au maximum 256 valeurs possibles (pour une image 16 bits avec 65536 valeurs à l&#8217;origine). Or, les meilleurs résultats, sur Sol&#8217;Ex, sont obtenus avec une taille de tuile de 8 pixels, soit une réduction à 64 valeurs possibles maximum.</p>
</li>
<li>
<p>il y a trop de paramètres possibles : la taille des tuiles, la dynamique et enfin le "facteur de coupe" pour l&#8217;égalisation. Sans entrer dans les détails, trouver une combinaison qui fonctionne bien indépendamment de la taille des images en entrée, de la dynamique de l&#8217;image et enfin du type d&#8217;image (H-alpha, calcium) est presque impossible.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour illustrer mon propos, voici par exemple un disque solaire (le fichier SER est <a href="http://www.astrosurf.com/solex/sol-ex-traitement.html">celui disponible sur le site de Christian Buil</a>) traité par JSol&#8217;Ex 2.1 (version précédente donc), avec les paramètres par défaut, une tuile de taille 16 pixels (à gauche) ou 64 pixels (à droite) :</p>
</div>
<div class="paragraph">
<p>
<div class="container-fluid">
<div class="row">
   <div class="col-md-6">
      <img class="img-responsive pop" src="/blog/img/jsolex2_2/clahe_16_jsolex_2.1.jpg">
   </div>
   <div class="col-md-6">
      <img class="img-responsive pop" src="/blog/img/jsolex2_2/clahe_64_jsolex_2.1.jpg">
   </div>
</div>
</div>
</p>
</div>
<div class="paragraph">
<p>On note déja clairement éclaircissement des limbes, et des artéfacts "carrés" qui apparaissent dès que la taille des tuiles augmente.
Trouver les bons paramètres qui conviennent à tous étant compliqué, JSol&#8217;Ex offrait déja la possibilité de changer ces paramètres (taille de tuile, intensité, &#8230;&#8203;) mais je pense que peu d&#8217;utilisateurs le faisaient.</p>
</div>
<div class="paragraph">
<p>Aussi ais-je décidé d&#8217;ajouter un algorithme dans JSol&#8217;Ex 2.2 dédié aux images solaires.
Pour vous donner un peu envie de lire la suite, voici ce qu&#8217;on peut obtenir avec JSol&#8217;Ex 2.2 sur la même image :</p>
</div>
<img src="/blog/img/jsolex2_2/christian-jsolex-2.2-decon.jpg" class="img-responsive center-block" width="50%">
</div>
</div>
<div class="sect1">
<h2 id="_nouvel_algorithme">Nouvel algorithme</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le nouvel algorithme est disponible dans JSol&#8217;Ex 2.2 et est l&#8217;algorithme utilisé par défaut.
Il combine plusieurs techniques, dont une correction du gamma avec masques, CLAHE et un stretching dynamique de l&#8217;image, pour produire une image plus digne de ce que Sol&#8217;Ex peut faire.
Je ne prétends pas que cet algorithme est parfait, il a lui aussi des défauts, mais il semble être un bon compromis.</p>
</div>
<div class="paragraph">
<p>Afin de vérifier mes assertions, j&#8217;ai procédé méthodiquement à une comparaison des images produites avec les paramètres par défaut de INTI, JSol&#8217;Ex 2.1 et JSol&#8217;Ex 2.2 (la seule modification est l&#8217;autocrop activé et un retournement vertical pour que les images soient orientées de la même façon).</p>
</div>
<div class="paragraph">
<p>Commençons par la vidéo H-alpha de démonstration utilisée par Christian Buil sur son site.</p>
</div>
<div class="paragraph">
<p><strong>Les images pouvant être difficiles à comparer en taille réduite, je vous invite à faire un clic doit et ouvrir l&#8217;image dans un nouvel onglet pour comparer.</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-1.jpg" alt="comparaison panel 1">
</div>
</div>
<div class="paragraph">
<p>On note clairement que sur JSol&#8217;Ex 2.1, il y avait certes une amélioration de contraste, mais elle se faisait au prix d&#8217;artéfacts et d&#8217;une perte de relief.
En revanche, JSol&#8217;Ex 2.2 offre une image plus nette que celle d&#8217;INTI, sans avoir les défauts de CLAHE.</p>
</div>
<div class="paragraph">
<p>Continuons avec une autre image solaire en H-alpha, avec plus de dynamique :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-2.jpg" alt="comparaison panel 2">
</div>
</div>
<div class="paragraph">
<p>Là encore on remarque que JSol&#8217;Ex 2.1 produisait une image raisonnable mais assez saturée et surtout "plate".
La version 2.2.0, quant à elle, offre une meilleure dynamique tout en préservant les détails et cette impression de profondeur.</p>
</div>
<div class="paragraph">
<p>Nous pouvons aussi comparer les résultats sur une image obtenue avec une plus longue focale et un disque partiel :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-3.jpg" alt="comparaison panel 3">
</div>
</div>
<div class="paragraph">
<p>Cette fois-ci on note que les 3 logiciels s&#8217;en tirent honorablement.
Cependant, JSol&#8217;Ex 2.1.3 affiche une image moins contrastée que la v2.2.0, alors qu&#8217;INTI v6 affiche une image légèrement plus floue.</p>
</div>
<div class="paragraph">
<p>Malheureusement suite à une fausse manipulation, j&#8217;ai perdu la plupart de mes fichiers SER en raie calcium. J&#8217;ai cependant pu faire des comparaisons, sur des fichiers loins d&#8217;être idéaux.
Les résultats sont cependant intéressants :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-4.jpg" alt="comparaison panel 4">
</div>
</div>
<div class="paragraph">
<p>Cette fois-ci, on constate que JSol&#8217;Ex 2.1 s&#8217;en sortait plutôt bien. INTI là encore fait un travail remarquable, mais JSol&#8217;Ex 2.2 sature trop l&#8217;image.
C&#8217;est un défaut que j&#8217;espère arriver à corriger, qui est lié au fait que les images calcium on un histogramme avec une gaussienne à base très large.
Il est néanmoins possible d&#8217;atténuer la saturation en choisissant un facteur de correction moins fort (par exemple 1.1 au lieu de la valeur par défaut 1.5), ce que je vous encourage à faire pour les images Calcium (conserver le 1.5 pour le h-alpha, baisser pour le calcium) :</p>
</div>
<img src="/blog/img/jsolex2_2/calcium-1-jsolex-2-2-facteur-1.1.jpg" class="img-responsive center-block" width="50%">
<div class="paragraph">
<p>Le résultat dépendra cependant beaucoup de l&#8217;exposition initiale de votre vidéo. Voici un autre exemple en raie calcium K:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-5.jpg" alt="comparaison panel 5">
</div>
</div>
<div class="paragraph">
<p>Il est utile de noter que si vous n&#8217;êtes pas satisfait du nouvel algorithme, il est tout à fait possible de repasser à CLAHE :</p>
</div>
<img src="/blog/img/jsolex2_2/config-params.jpg" class="img-responsive center-block" width="50%">
<div class="paragraph">
<p>Enfin, il vous est tout à fait possible d&#8217;être plus ou moins "aggressif" sur l&#8217;amélioration de constraste à effectuer.
Ansi, dans les paramètres de traitement, vous pouvez changer le facteur <em>gamma</em> qui permet d&#8217;assombrir l&#8217;image.
Pour l&#8217;exemple, si on pousse les curseurs un peu loin (par exemple à <em>4</em> dans l&#8217;image suivante), vous constaterez que l&#8217;image reste exploitable, et surtout que les défauts de CLAHE qui a tendance à aplatir les images est complètement disparu :</p>
</div>
<img src="/blog/img/jsolex2_2/gamma-4.jpg" class="img-responsive center-block" width="50%">
</div>
</div>
<div class="sect1">
<h2 id="_pour_aller_encore_plus_loin">Pour aller encore plus loin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tout d&#8217;abord, JSol&#8217;Ex offre un <a href="https://melix.github.io/astro4j/latest/fr/jsolex.html#imagemath">langage de script</a> qui permet d&#8217;aller bien plus loin dans les traitements, de générer automatiquement des animations, etc.
Bien sûr, les améliorations de JSol&#8217;Ex 2.2 sont disponibles dans les scripts par l&#8217;intermédiaire de 2 nouvelles fonctions : <code>adjust_gamma</code> qui permet de réaliser une simple correction de gamma sur l&#8217;image, et <code>auto_constrast</code> qui correspond à la correction décrite dans ce billet de blog.</p>
</div>
<div class="paragraph">
<p>Enfin, nous n&#8217;avons pas encore parlé des fonctionnalités désactivées par défaut, mais qui étaient déja disponibles dans JSol&#8217;Ex : la déconvolution et l&#8217;amélioration de la netteté.
Ces deux options sont activables dans les paramètres de traitement :</p>
</div>
<img src="/blog/img/jsolex2_2/config-params-2.jpg" class="img-responsive center-block" width="50%">
<div class="paragraph">
<p>Je ne recommande pas nécessairement de cocher la case "aiguiser les détails" si vous avez des images trop bruitées.
Cette dernière ligne compare donc la même image, traitée avec <a href="/blog/img/jsolex2_2/halpha-3-inti-6.png" target="_blank" rel="noopener">INTI v6</a>, JSol&#8217;Ex 2.2 (dernière version donc), mais <a href="/blog/img/jsolex2_2/halpha-3-jsolex-2.2.jpg" target="_blank" rel="noopener">sans déconvolution</a>, <a href="/blog/img/jsolex2_2/halpha-3-jsolex-2.2-decon.jpg" target="_blank" rel="noopener">avec déconvolution</a> et finalement <a href="/blog/img/jsolex2_2/halpha-3-jsolex-2.2-decon-sharpen.jpg" target="_blank" rel="noopener">avec déconvolution et amélioration des détails</a> :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/comparaison-panel-6.jpg" alt="comparaison panel 6">
</div>
</div>
<div class="paragraph">
<p>En ce qui me concerne, je trouve la version déconvoluée particulièrement plaisante à l&#8217;oeil, et j&#8217;active donc systématiquement la déconvolution :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/img/jsolex2_2/halpha-3-jsolex-2.2-decon.jpg" alt="halpha 3 jsolex 2.2 decon">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En conclusion, dans ce billet je vous ai présenté le nouvel algorithme de correction de contraste, activé par défaut dans JSol&#8217;Ex 2.2.
Je pense que les résultats sont assez probants, et que JSol&#8217;Ex n&#8217;a plus à rougir de INTI en ce qui concerne les images avec amélioration de contraste.
Cependant, je rappelle encore une fois que le logiciel officiel <strong>est</strong> INTI, que c&#8217;est le seul validé avec le sérieux de Christian Buil et Valérie Desnoux.
Si vous voulez déposer des images sur BASS2000, vous <strong>devez</strong> utiliser INTI.
Par ailleurs, je vous conseille toujours de comparer les résultats, ne considérez pas que JSol&#8217;Ex fait un meilleur travail, c&#8217;est probablement faux.</p>
</div>
<div class="paragraph">
<p>Par exemple, il reste des améliorations à faire sur les images calcium. Mais il est cependant tout à fait possible de modifier les paramètres par défaut, voire de changer d&#8217;algorithme.</p>
</div>
<div class="paragraph">
<p>N&#8217;oubliez pas non plus que JSo&#8217;Ex offre d&#8217;autres fonctionnalités comme la colorisation automatique des images, le stacking, la création de mosaïques solaires ou encore un langage de script particulièrement puissant, qui vous permet par exemple de générer des animations automatiquement.
Je vais donc conclure ce billet avec un exemple de script qui utilise cette nouvelle amélioration de contraste pour produire une animation qui nous fait plonger dans l&#8217;atmosphère solaire en jouant sur le décalage de pixels :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"># Décalage de pixels qu'on applique, de -15 à +15, pas de 0.5
images=range(-15,15,.5)
# On calcule une image corrigée de ses transversalliums
corrigee=fix_banding(images,32,40)
# Déconvolution
decon=rl_decon(corrigee)
# On redimensionne
redim=rescale_rel(autocrop2(decon,1.1),.5,.5)
# On applique la correction de contraste décrite dans ce billet
cst=auto_contrast(redim,1.5)

[outputs]
# Enfin on produit l'animation (75ms entre chaque frame)
animation=anim(cst,75)</code></pre>
</div>
</div>
<div class="text-center">
 <video width="640" height="640" controls>
  <source src="https://melix.github.io/blog/img/jsolex2_2/animation.webm" type="video/webm">
Your browser does not support the video tag.
</video>
</div>
<div class="sect2">
<h3 id="_bonus">Bonus</h3>
<div class="paragraph">
<p>J&#8217;en profite enfin pour partager deux vidéos, à destination des débutants sur Sol&#8217;Ex, que j&#8217;ai faites récemment :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.youtube.com/watch?v=NsDgg4o2SDw">Trouver le soleil sans chercheur solaire</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=8lWXcPG16I0">Régler exposition, gain et binning</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ressources">Ressources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/melix/astro4j">JSol&#8217;Ex</a> (téléchargement)</p>
</li>
<li>
<p><a href="https://melix.github.io/astro4j/latest/fr/jsolex.html">JSol&#8217;Ex</a> (documentation)</p>
</li>
<li>
<p><a href="http://valerie.desnoux.free.fr/inti/">INTI</a> (logiciel officiel)</p>
</li>
<li>
<p><a href="http://www.astrosurf.com/solex/sol-ex-traitement.html">Sol&#8217;Ex</a> (site officiel Sol&#8217;Ex)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Adaptive_histogram_equalization">CLAHE</a> (algorithme)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Gamma_correction">Gamma correction</a> (algorithme)</p>
</li>
</ul>
</div>
</div>
</div>
</div></p>
	
	<hr />
	
	<p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">Baked with <a href="https://jbake.org">JBake v2.6.6</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    
    <script src="/blog/js/jquery-1.11.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
   <script>hljs.highlightAll();</script>
  </body>
</html>
