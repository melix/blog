<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cédric Champeau's blog: Tip of the day: reversed git bisect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">    

    <!-- Le styles -->
    <link href="/blog/css/bootstrap.min.css" rel="stylesheet">
    <link href="/blog/css/asciidoctor.css" rel="stylesheet">
    <link href="/blog/css/base.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
    </head>
  <body>
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">
 lang: en_US
</script>
    <div id="wrap">
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
          <div class="container">
	    <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog">Cédric Champeau's blog</a>
	    </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">                
                <li><a href="/blog/about.html">About</a></li>
		<li><a href="/blog/projects.html">Projects</a></li>
		<li><a href="/blog/astronomy.html">Astronomy</a></li>
		<li class="dropdown">
          		<a data-toggle="dropdown" href="#">Topics<b class="caret"></b></a>
		          <ul class="dropdown-menu" role="menu">
				<li><a href="/blog/tags/groovy.html">Groovy</a></li>
                <li><a href="/blog/tags/groovy.html">Gradle</a></li>
				<li><a href="/blog/2013/07/30/deck2pdf_exporting_html5_slide_decks.html">deck2pdf</a></li>
				<li><a href="/blog/tags/jlangdetect.html">JLangDetect</a></li>
		          </ul>
	       </li>
                <li><a href="/blog/feed.xml">Feed</a></li>                
              </ul>
	      <ul class="nav navbar-nav navbar-right">
	      	<li><a href="https://github.com/melix"><i class="fa fa-github"></i></a></li>
	        <li><a href="https://twitter.com/CedricChampeau"><i class="fa fa-twitter"></i></a>
	      </ul>
            </div>
          </div>
      </div>
      <div class="container">
	
	<div class="page-header">
		<h1>Tip of the day: reversed git bisect</h1>
	</div>

	<p><em>23 July 2014</em></p>
	<p><em>Tags: </em>
		<a href="/blog/tags/groovy.html">groovy</a> 
	</em>
		<a href="/blog/tags/git.html">git</a> 
	</em>
		<a href="/blog/tags/bisect.html">bisect</a> 
	</p>
	<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://melix.github.io/blog/2014/07/bisecting-groovy.html" data-via="CedricChampeau" data-lang="fr">Tweeter</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	<div class="g-plusone" data-size="medium" data-href="http://melix.github.io/blog/2014/07/bisecting-groovy.html"></div>
        <script id='fbvpgng'>(function(i){var f,s=document.getElementById(i);f=document.createElement('iframe');f.src='//api.flattr.com/button/view/?uid=CedricChampeau&button=compact&url='+encodeURIComponent('http://melix.github.io/blog/2014/07/bisecting-groovy.html');f.title='Flattr';f.height=20;f.width=110;f.style.borderWidth=0;s.parentNode.insertBefore(f,s);})('fbvpgng');</script>
	<script type="IN/Share" data-url="http://melix.github.io/blog/2014/07/bisecting-groovy.html" data-counter="right"></script>
	<div class="fb-like" data-href="http://melix.github.io/blog/2014/07/bisecting-groovy.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>
	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I had an interesting use case for <code>git bisect</code> today and as my blog also consistutes a good archive for things I don&#8217;t
want to loose, let&#8217;s take advantage of this to share the trick with you!</p>
</div>
<div class="paragraph">
<p>Normally, <code>git bisect</code> is used to find what commit introduced a regression in the codebase. For example, if you know
that current <code>HEAD</code> is buggy but that at least, RELEASE_1_0 was good, then you can write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git bisect start             <i class="conum" data-value="1"></i><b>(1)</b>
git bisect bad               <i class="conum" data-value="2"></i><b>(2)</b>
git bisect good RELEASE_1_0  <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>start bisecting</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>tells that <code>HEAD</code> contains the regression</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>tells that <code>RELEASE_1_0</code> is a tag corresponding to a version known not to have the bug</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Git will checkout a revision that you can test, and you issue a list of <code>git bisect good</code> or <code>git bisect bad</code> commands
until it determines what commit introduced the regression.</p>
</div>
<div class="paragraph">
<p>This is a <strong>very</strong> practical way to find a regression. In Groovy, I&#8217;ve used this more than once, it&#8217;s very useful.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reversing_the_logic">Reversing the logic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But today, I wanted to <em>reverse the logic</em>. Actually, we had a <a href="https://jira.codehaus.org/browse/GROOVY-6463">bug report</a>
and we found out that the bug was already fixed, but we didn&#8217;t know in which version it was fixed. So actually, I didn&#8217;t
want to find a regression, but a fix commit.</p>
</div>
<div class="paragraph">
<p>The idea to do this is to reverse the meaning of <code>bad</code> and <code>good</code> in <code>bisect</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bad</code> becomes "doesn&#8217;t produce a compile error"</p>
</li>
<li>
<p><code>good</code> becomes "produces a compile error"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And since the range of revisions to test was pretty big (we know that the error was reported on Groovy 2.2.1, but master
is 2.4.0), then I also took advantage of the <code>git bisect run</code> command, which automatically continues bisecting based on
a command line return status code.</p>
</div>
<div class="paragraph">
<p>So basically, here&#8217;s what I wrote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git bisect start                <i class="conum" data-value="1"></i><b>(1)</b>
git bisect bad master           <i class="conum" data-value="2"></i><b>(2)</b>
git bisect good GROOVY_2_2_1    <i class="conum" data-value="3"></i><b>(3)</b>
git bisect run ./bisect.sh      <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>start bisecting</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>master is known to have the fix, so we say <strong>bad</strong> is master</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>GROOVY_2_2_1 is known to have the bug, so we say <strong>good</strong> is GROOVY_2_2_1</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>start automatic bisecting thanks to the ./bisect.sh script</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And what does <em>bisect.sh</em> consist of? Here you go:</p>
</div>
<div class="listingblock">
<div class="title">bisect.sh</div>
<div class="content">
<pre>#!/bin/bash
export GROOVY_HOME=/tmp/testversion                                                                     <i class="conum" data-value="1"></i><b>(1)</b>
./gradlew clean -x javadoc -x groovydoc -x javadocAll -x groovydocAll -PskipIndy=true installGroovy     <i class="conum" data-value="2"></i><b>(2)</b>
/tmp/testversion/bin/groovy bisect.groovy || exit 0                                                     <i class="conum" data-value="3"></i><b>(3)</b>
exit 1                                                                                                  <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>tells where the local build version of Groovy will be installed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>builds Groovy and installs it locally</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>executes the test script and if the test fails, return a success exit code</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>return a failure exit code</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The trick is to <strong>reverse the exit codes</strong> in the script too: if the script compiles, then it means that the bug was fixed.
Since we reverse the logic, we then need the script to return a bad exit code! In case the script fails, we will return
a success (0) error code, because it means that the revision doesn&#8217;t have the fix. Easy, but needs some mental contorsion :-)</p>
</div>
<div class="paragraph">
<p>You will note that this script uses <code>GROOVY_HOME</code> and a local installation path. You can configure it using the <code>$HOME/.gradle/gradle.properties</code> file,
and adding the following line in it:</p>
</div>
<div class="listingblock">
<div class="title">gradle.properties</div>
<div class="content">
<pre>groovy_installPath=/tmp/testversion</pre>
</div>
</div>
<div class="paragraph">
<p>Eventually, here is the groovy script which served as a test case (almost copied directly from the JIRA issue):</p>
</div>
<div class="listingblock">
<div class="title">bisect.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>abstract  class Base&lt;A&gt; {
    abstract  void foo(A[] a)
}

class X {}

class Inheritor extends Base&lt;X&gt;{
    @Override
    void foo(X[] a) {}
//Groovyc: Can't have an abstract method in a non-abstract class.
//The class 'B' must be declared abstract
//or the method 'void foo([Ljava.lang.Object;)' must be implemented.
}

Inheritor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that each revision took around ~1 min 30s to test, even skipping the javadoc/groovydoc and indy versions of Groovy,
so you can imagine what benefit you have here in using automatic bisecting.</p>
</div>
<div class="paragraph">
<p>In the end, after around 20 minutes of automatic processing, I received this nice message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>74d991f9f8c39d2730a054431bf28e6516e61735 is the first bad commit
commit 74d991f9f8c39d2730a054431bf28e6516e61735
Author: Cedric Champeau &lt;cedric.champeau@gmail.com&gt;
Date:   Sun Apr 27 18:06:24 2014 +0200

    GROOVY-6722: Compiler doesn't handle generic array covariant

:040000 040000 b61b92399ac86246c157f948b3232bf5ab0cf04f 5d0c56413a621c7693e7985aff0e4c84eb08889f M	src
bisect run success</pre>
</div>
</div>
<div class="paragraph">
<p>What? "bad commit"? Yes, remember that the logic is reversed, so "bad" means actually "fixed it". So it says that the
first commit which <strong>fixed</strong> the bug was actually <code>74d991f</code>. And here we go, issue closed ;) One improvement I can see
is to use a local clone of my repository instead of working directly in the same repository, so that I can continue
working on my copy while bisecting is in progress.</p>
</div>
</div>
</div></p>

	<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://melix.github.io/blog/2014/07/bisecting-groovy.html" data-via="CedricChampeau" data-lang="fr">Tweeter</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	<div class="g-plusone" data-size="medium" data-href="http://melix.github.io/blog/2014/07/bisecting-groovy.html"></div>
	<script type="IN/Share" data-url="http://melix.github.io/blog/2014/07/bisecting-groovy.html" data-counter="right"></script>
	<div class="fb-like" data-href="http://melix.github.io/blog/2014/07/bisecting-groovy.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'melixblog';
	var disqus_identifier = 'git_bisect_groovy';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	<hr>
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
	<p class="muted credit">All posts on this blog are published with a <em>Creative Commons by-nc-sa</em> license.<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.0/fr/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/2.0/fr/88x31.png"/></a></p>
        <p class="muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.0.3</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/blog/js/jquery-1.9.1.min.js"></script>
    <script src="/blog/js/bootstrap.min.js"></script>
    <script src="/blog/js/run_prettify.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
    var disqus_shortname = 'melixblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45962373-1', 'melix.github.io');
  ga('send', 'pageview');

</script>
<script src="http://cdn.lanyrd.net/badges/person-v1.min.js"></script>
  </body>
</html>
